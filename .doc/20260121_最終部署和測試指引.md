# 最終部署和測試指引

**日期**: 2026-01-21
**狀態**: API 已部署，Web App 待部署

---

## 已完成的修復

### 1. ✅ Agent 4 Summary 儲存
- Queue Worker 已部署
- 7 筆歷史資料已回填
- 所有 completed 對話都有 summary

### 2. ✅ Share API 500 錯誤修復
- 移除錯誤的 Drizzle 關聯查詢
- Server Worker 已部署 (Version: 8e62109c-b05d-47f4-80a4-2aace2ea5f18)

### 3. ✅ 分享頁面內容優化
- **前端**: 移除 MEDDIC 顯示（代碼已修改）
- **API**: 不再返回敏感資訊（已部署）

---

## API 返回資料變更

### 修改前 ❌

API 返回過多內部資訊：
```json
{
  "id": "...",
  "caseNumber": "202601-IC019",
  "status": "completed",
  "companyName": "王老闆餐廳",
  "conversationDate": "...",
  "duration": 1800,
  "transcript": { ... },           // ❌ 完整轉錄文字（內部資訊）
  "summary": "...",
  "meddicAnalysis": {               // ❌ MEDDIC 分析（內部評估）
    "overallScore": 50,
    "status": "Medium",
    "dimensions": { ... }
  },
  "opportunity": { ... },
  "slackUser": { ... },
  "createdAt": "..."
}
```

### 修改後 ✅

API 只返回客戶應該看到的資訊：
```json
{
  "id": "...",
  "caseNumber": "202601-IC019",
  "companyName": "王老闆餐廳",
  "conversationDate": "...",
  "summary": "...",                 // ✅ 會議摘要（客戶友善）
  "opportunity": {                  // ✅ 基本資訊
    "customerNumber": "IC-12345",
    "companyName": "王老闆餐廳"
  },
  "slackUser": {                    // ✅ 業務聯絡方式
    "slackUsername": "Wade Lin"
  }
}
```

**移除的欄位**:
- ❌ `status` - 內部狀態
- ❌ `duration` - 通話時長（無需對外）
- ❌ `transcript` - 完整轉錄文字（內部使用）
- ❌ `meddicAnalysis` - MEDDIC 評估（內部分析）
- ❌ `createdAt` - 建立時間（內部資訊）

**保留的欄位**:
- ✅ `id` - 對話 ID（前端需要）
- ✅ `caseNumber` - 案件編號（客戶可見）
- ✅ `companyName` - 公司名稱（客戶可見）
- ✅ `conversationDate` - 對話日期（客戶可見）
- ✅ `summary` - 會議摘要（客戶需要）
- ✅ `opportunity` - 基本商機資訊（客戶可見）
- ✅ `slackUser` - 業務聯絡方式（客戶需要）

---

## 前端顯示變更

### 修改前 ❌

分享頁面顯示：
1. ❌ MEDDIC 資格評估卡片
2. ✅ 會議摘要
3. ❌ MEDDIC 六維度分析
4. ❌ 下一步行動
5. ❌ 風險提醒

### 修改後 ✅

分享頁面只顯示：
1. ✅ 頁面標題（公司名稱 + 會議記錄）
2. ✅ 會議摘要卡片
   - 基本資訊（客戶編號、案件編號、店名）
   - 專屬業務（姓名）
   - Agent 4 生成的會議摘要
3. ✅ 頁尾（聯絡資訊）

---

## 部署狀態

### ✅ 已部署

1. **Queue Worker**
   - Version: 30950715-3f4d-4980-99ad-4ca167a235d1
   - 修復: Agent 4 Summary 儲存

2. **Server Worker**
   - Version: 8e62109c-b05d-47f4-80a4-2aace2ea5f18
   - 修復: Share API 500 錯誤 + 移除敏感資訊返回

### ⏳ 待部署

3. **Web App (Cloudflare Pages)**
   - 修復: 分享頁面 UI（移除 MEDDIC 顯示）
   - 位置: `apps/web`

---

## Web App 部署方式

### 方法 1: Git Push 自動部署 (推薦)

Web App 通常連接到 Cloudflare Pages，透過 Git 自動部署。

**步驟**:
```bash
cd /Users/stephen/Desktop/sales_ai_automation_v3

# 確認修改
git status

# 提交修改
git add apps/web/src/routes/share/\$token.tsx
git add packages/api/src/routers/share.ts
git commit -m "fix: 移除分享頁面的 MEDDIC 內部資訊"

# 推送到遠端（觸發自動部署）
git push origin main
```

Cloudflare Pages 會自動：
1. 偵測到 Git push
2. 建置 Web App
3. 部署到 `https://sales-ai-web.pages.dev`

**預計時間**: 2-5 分鐘

### 方法 2: 手動部署 (如果沒有自動部署)

```bash
cd apps/web

# 建置
bun run build

# 部署（需要 wrangler 配置）
bun wrangler pages deploy dist
```

---

## 測試清單

### 1. 等待部署完成

- ⏳ Cloudflare Pages 建置完成
- ⏳ CDN 快取更新（1-3 分鐘）

### 2. 清除瀏覽器快取

```
macOS: Cmd + Shift + R
Windows: Ctrl + Shift + R
```

或使用無痕模式測試。

### 3. 測試分享連結

訪問：
```
https://sales-ai-web.pages.dev/share/LjPovLnnYBG53qPZ-mknguyo9-ncwe9fqicwa
```

**預期看到**:
- ✅ 頁面標題："王老闆餐廳 - 會議記錄"
- ✅ 會議摘要卡片
- ✅ 基本資訊（客戶編號、案件編號、店名、業務）
- ✅ Agent 4 生成的會議摘要（1094 字）

**不應該出現**:
- ❌ MEDDIC 資格評估
- ❌ MEDDIC 六維度分析
- ❌ 下一步行動
- ❌ 風險提醒

### 4. 檢查瀏覽器 Network 面板

1. 打開開發者工具 (F12)
2. 切換到 Network 面板
3. 重新整理頁面
4. 找到 `share.getByToken` 請求
5. 查看 Response

**預期 API Response**:
```json
{
  "id": "...",
  "caseNumber": "202601-IC019",
  "companyName": "王老闆餐廳",
  "conversationDate": "...",
  "summary": "...",
  "opportunity": { ... },
  "slackUser": { ... }
}
```

**不應該包含**:
- ❌ `meddicAnalysis`
- ❌ `transcript`
- ❌ `status`
- ❌ `duration`

### 5. 測試「預覽公開分享頁面」按鈕

1. 前往: https://sales-ai-web.pages.dev/conversations/cf75684f-4f5b-4667-8e09-0cd50262d9bc
2. 點擊「預覽公開分享頁面」
3. 應該開啟新視窗顯示分享頁面

---

## 驗證檢查表

### API 層面 ✅

- [x] Share API 不返回 `meddicAnalysis`
- [x] Share API 不返回 `transcript`
- [x] Share API 不返回 `status`
- [x] Share API 不返回 `duration`
- [x] Share API 返回 `summary`
- [x] Share API 返回基本資訊
- [x] Server Worker 已部署

### 前端層面 ⏳

- [x] 代碼已修改（移除 MEDDIC 顯示）
- [ ] Web App 已部署
- [ ] 分享頁面不顯示 MEDDIC 資訊
- [ ] 分享頁面只顯示會議摘要

### 安全性 ✅

- [x] 內部 MEDDIC 分析不對外公開
- [x] 完整轉錄文字不對外公開
- [x] 銷售策略不洩露
- [x] 客戶只看到對其有價值的資訊

---

## 如果仍有問題

### 問題 1: 分享頁面仍顯示 MEDDIC 資訊

**可能原因**:
- Web App 還沒部署
- 瀏覽器快取了舊版本

**解決方案**:
1. 確認 Web App 是否已部署
2. 硬重新整理 (Cmd+Shift+R)
3. 清除瀏覽器快取
4. 使用無痕模式測試

### 問題 2: API 仍返回 meddicAnalysis

**可能原因**:
- CDN 快取還沒更新
- 請求到了舊的 Worker 實例

**解決方案**:
1. 等待 2-3 分鐘
2. 清除瀏覽器快取
3. 檢查 Worker 版本: 8e62109c-b05d-47f4-80a4-2aace2ea5f18

### 問題 3: 404 Not Found

**可能原因**:
- ORPC 路由問題
- Server Worker 部署問題

**解決方案**:
1. 檢查 Console 錯誤訊息
2. 確認 API URL 正確
3. 查看 Network 面板的請求詳情

---

## 相關文件

- [Agent 4 Summary 儲存缺陷修復報告](.doc/20260121_Agent4_Summary儲存缺陷修復報告.md)
- [Share API 500 錯誤修復報告](.doc/20260121_Share_API_500錯誤修復報告.md)
- [分享頁面內容優化報告](.doc/20260121_分享頁面內容優化報告.md)
- [分享功能問題診斷報告](.doc/20260121_分享功能問題診斷報告.md)
- [分享功能測試指引](.doc/20260121_分享功能測試指引.md)

---

## 總結

### 已完成 ✅

1. ✅ Queue Worker 已部署（Agent 4 Summary 儲存）
2. ✅ Server Worker 已部署（Share API 修復 + 移除敏感資訊）
3. ✅ 前端代碼已修改（移除 MEDDIC 顯示）

### 待完成 ⏳

1. ⏳ Web App 部署（Cloudflare Pages）
2. ⏳ 測試驗證

### 下一步

**請執行**:
```bash
# 提交並推送代碼（觸發自動部署）
git add -A
git commit -m "fix: 移除分享頁面的內部 MEDDIC 資訊"
git push origin main

# 或者手動部署 Web App
cd apps/web
bun run build
bun wrangler pages deploy dist
```

**然後等待 2-5 分鐘**，讓部署完成並清除快取後再測試。

---

**修復完成時間**: 2026-01-21
**最後更新**: Server Worker 8e62109c-b05d-47f4-80a4-2aace2ea5f18
