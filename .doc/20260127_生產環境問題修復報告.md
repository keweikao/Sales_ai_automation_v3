# 20260127 生產環境問題修復報告

## 問題概述

部署 Sales Pipeline Todo 功能升級後，網頁出現多個 500 Internal Server Error，包括：
- `/rpc/salesTodo/list` - 500 錯誤
- `/rpc/opportunity/get` - 找不到此機會
- `/rpc/analytics/repPerformance` - 500 錯誤
- 報告頁面無法載入

## 根本原因分析

### 1. 資料庫 Migration 未執行

**問題**：新功能需要的資料庫結構變更（Migration 0008、0009）未在生產環境執行。

- **Migration 0008** (`0008_update_sales_todos.sql`)：
  - 新增 `won_record` (jsonb)
  - 新增 `lost_record` (jsonb)
  - 新增 `next_todo_id` (text, FK)
  - 新增 `prev_todo_id` (text, FK)

- **Migration 0009** (`0009_add_todo_logs.sql`)：
  - 建立 `todo_logs` 資料表

**解決方案**：在 Neon Console 手動執行 SQL Migration。

### 2. UTC 時區問題

**問題**：Cloudflare Workers 運行在 UTC 時區，但業務邏輯需要使用 UTC+8（台北時間）。

**症狀**：
- 今日待辦（1/27）顯示 0 項
- 但這些待辦被錯誤分類到「逾期待辦」

**原因**：`getTodaysTodos` 和 `listTodos` 使用以下錯誤的時區計算：
```typescript
// 錯誤：使用 UTC 時間
const now = new Date();
const todayStart = new Date(now);
todayStart.setHours(0, 0, 0, 0);  // UTC 00:00 = 台北 08:00
```

**解決方案**：在 `sales-todo.ts` 中加入 UTC+8 時區工具函式：
```typescript
const UTC_PLUS_8_OFFSET_MS = 8 * 60 * 60 * 1000;

function getTodayStartInTaipei(): Date {
  const taipeiNow = nowInTaipei();
  // ... 計算 UTC+8 的今天 00:00
}

function getTodayEndInTaipei(): Date {
  // ... 計算 UTC+8 的今天 23:59:59.999
}
```

### 3. listTodos 計數錯誤

**問題**：頂部標籤顯示「待辦中 (1)」但實際有 3 項待辦。

**原因**：`listTodos` API 的 `total` 返回 `todos.length`（分頁後的結果數量），但前端用 `limit: 1` 查詢計數。

```typescript
// 錯誤：返回分頁後的數量
return {
  todos: [...],
  total: todos.length,  // 永遠 <= limit
};
```

**解決方案**：加入獨立的 count 查詢：
```typescript
const [todos, totalResult] = await Promise.all([
  db.query.salesTodos.findMany({ ... }),
  db.select({ count: count() }).from(salesTodos).where(whereClause),
]);

return {
  todos: [...],
  total: totalResult[0]?.count ?? 0,  // 實際總數
};
```

## 修改的檔案

### packages/api/src/routers/sales-todo.ts

1. **加入 UTC+8 時區工具函式**（第 23-70 行）
   - `nowInTaipei()` - 取得當前 UTC+8 時間
   - `getTodayStartInTaipei()` - 取得今天開始時間
   - `getTodayEndInTaipei()` - 取得今天結束時間
   - `getDateStartInTaipei(dateStr)` - 取得指定日期開始時間
   - `getDateEndInTaipei(dateStr)` - 取得指定日期結束時間

2. **修復 getTodaysTodos 時區問題**（第 849 行）
   ```typescript
   // 修復前
   const now = new Date();
   const todayStart = new Date(now);
   todayStart.setHours(0, 0, 0, 0);

   // 修復後
   const todayStart = getTodayStartInTaipei();
   const todayEnd = getTodayEndInTaipei();
   ```

3. **修復 listTodos 日期篩選**（第 756-761 行）
   ```typescript
   // 修復後
   if (dateFrom) {
     conditions.push(gte(salesTodos.dueDate, getDateStartInTaipei(dateFrom)));
   }
   if (dateTo) {
     conditions.push(lte(salesTodos.dueDate, getDateEndInTaipei(dateTo)));
   }
   ```

4. **修復 listTodos 計數問題**（第 764-810 行）
   - 加入 `count` import
   - 同時查詢資料和總數
   - 返回實際的 `total` 數量

### packages/api/src/routers/opportunity.ts

1. **重新啟用 salesTodos 查詢**（第 511 行）
   ```typescript
   const todos = await db.query.salesTodos.findMany({
     where: eq(salesTodos.opportunityId, opportunityId),
     orderBy: [desc(salesTodos.createdAt)],
   });
   ```

2. **重新啟用 todoLogs 查詢**（第 535 行）
   ```typescript
   const logs = await db.query.todoLogs.findMany({
     where: eq(todoLogs.opportunityId, opportunityId),
     orderBy: [desc(todoLogs.createdAt)],
   });
   ```

## 執行的 SQL Migration

### Migration 0008 - 更新 sales_todos 表
```sql
ALTER TABLE sales_todos ADD COLUMN IF NOT EXISTS "won_record" jsonb;
ALTER TABLE sales_todos ADD COLUMN IF NOT EXISTS "lost_record" jsonb;
ALTER TABLE sales_todos ADD COLUMN IF NOT EXISTS "next_todo_id" text REFERENCES sales_todos(id);
ALTER TABLE sales_todos ADD COLUMN IF NOT EXISTS "prev_todo_id" text REFERENCES sales_todos(id);
CREATE INDEX IF NOT EXISTS "sales_todos_next_todo_id_idx" ON "sales_todos" ("next_todo_id");
CREATE INDEX IF NOT EXISTS "sales_todos_prev_todo_id_idx" ON "sales_todos" ("prev_todo_id");
```

### Migration 0009 - 建立 todo_logs 表
```sql
CREATE TABLE IF NOT EXISTS "todo_logs" (
    "id" text PRIMARY KEY NOT NULL,
    "todo_id" text NOT NULL REFERENCES "sales_todos"("id") ON DELETE CASCADE,
    "opportunity_id" text REFERENCES "opportunities"("id") ON DELETE SET NULL,
    "user_id" text NOT NULL REFERENCES "user"("id") ON DELETE CASCADE,
    "action" text NOT NULL,
    "action_via" text NOT NULL,
    "changes" jsonb NOT NULL,
    "note" text,
    "created_at" timestamp DEFAULT now() NOT NULL
);
CREATE INDEX IF NOT EXISTS "todo_logs_todo_id_idx" ON "todo_logs" ("todo_id");
CREATE INDEX IF NOT EXISTS "todo_logs_opportunity_id_idx" ON "todo_logs" ("opportunity_id");
CREATE INDEX IF NOT EXISTS "todo_logs_user_id_idx" ON "todo_logs" ("user_id");
CREATE INDEX IF NOT EXISTS "todo_logs_created_at_idx" ON "todo_logs" ("created_at");
```

## 部署步驟

1. 在 Neon Console 執行 Migration 0008 和 0009
2. 部署 Server：`cd apps/server && bunx wrangler deploy`

## 驗證結果

- ✅ 待辦頁面正常顯示
- ✅ 今日待辦正確顯示（時區修復）
- ✅ 逾期待辦正確分類
- ✅ 頂部標籤計數正確
- ✅ 機會頁面正常載入
- ✅ 報告頁面正常載入

## 經驗教訓

1. **部署前確認 Migration**：新功能部署前，必須確認所有資料庫 Migration 已在生產環境執行。

2. **時區處理**：Cloudflare Workers 運行在 UTC，所有涉及日期比較的邏輯都需要明確處理時區轉換。

3. **分頁計數**：API 返回分頁資料時，`total` 應該是符合條件的總數，而非分頁後的結果數量。

4. **錯誤處理**：發生 500 錯誤時，可透過以下方式診斷：
   - 逐步停用可疑的查詢
   - 檢查 Migration 是否執行
   - 使用 `bunx wrangler tail` 查看即時日誌
