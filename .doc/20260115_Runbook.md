# Sales AI Automation V3 - Runbook

## 目的
本文檔提供常見運維場景的標準操作程序 (SOP),確保快速響應和解決問題。

---

## 緊急聯絡

### 緊急程度分類
- **P0 (Critical)**: 服務完全不可用
- **P1 (High)**: 核心功能受影響
- **P2 (Medium)**: 部分功能異常
- **P3 (Low)**: 小問題或改進

### 升級路徑
1. **值班工程師**: 第一響應
2. **技術 Lead**: P0/P1 問題
3. **架構師**: 需要架構變更的問題

---

## 場景 1: Queue Worker 處理失敗率高 (>5%)

### 症狀
- Cloudflare Dashboard 顯示錯誤率 > 5%
- Slack 通知大量失敗訊息

### 緊急程度
**P1 (High)**

### 診斷步驟

#### 1. 查看即時日誌
```bash
cd apps/queue-worker
wrangler tail --format json
```

#### 2. 統計錯誤類型
```bash
wrangler tail --format json | \
  grep "ERROR" | \
  jq -r '.message' | \
  sort | uniq -c | sort -rn
```

#### 3. 檢查外部服務狀態
- Groq API: https://status.groq.com
- Google Cloud: https://status.cloud.google.com
- Neon: https://neon.tech/status

### 常見原因與解決方案

#### 原因 1: Groq API 限流
**症狀**: `GROQ_API_ERROR` 錯誤

**解決方案**:
1. 檢查 API quota: https://console.groq.com/settings/limits
2. 如果超過限制,暫時停止處理:
   ```bash
   # 暫停 Queue (需要手動實作)
   wrangler queues pause transcription-queue
   ```
3. 聯絡 Groq support 提升 quota
4. 恢復處理:
   ```bash
   wrangler queues resume transcription-queue
   ```

#### 原因 2: Database 連接問題
**症狀**: `DATABASE_ERROR` 錯誤

**解決方案**:
1. 檢查 Neon 狀態
2. 檢查連接池:
   ```sql
   SELECT count(*) as active_connections
   FROM pg_stat_activity
   WHERE state = 'active';
   ```
3. 如果超過限制,重啟 Worker:
   ```bash
   wrangler publish
   ```

#### 原因 3: R2 Storage 問題
**症狀**: `FILE_DOWNLOAD_FAILED` 錯誤

**解決方案**:
1. 檢查 R2 狀態
2. 測試檔案存取:
   ```bash
   # 使用 AWS CLI
   aws s3 ls s3://your-bucket-name/ \
     --endpoint-url=$CLOUDFLARE_R2_ENDPOINT
   ```
3. 如果 R2 正常,檢查音檔是否存在
4. 重試失敗的訊息

### 預防措施
- 實作自動重試機制 (已完成)
- 監控外部服務狀態
- 設置 API quota 告警

---

## 場景 2: Queue 堆積 (>100 訊息)

### 症狀
- Cloudflare Queue dashboard 顯示大量待處理訊息
- 處理延遲顯著增加

### 緊急程度
**P2 (Medium)**

### 診斷步驟

#### 1. 查看 Queue 深度
```bash
wrangler queues list
```

#### 2. 檢查處理速率
```bash
# 查看最近 10 分鐘的處理量
wrangler tail | grep "Processing completed" | wc -l
```

#### 3. 查看 Worker 狀態
```bash
# 檢查是否有錯誤導致處理停滯
wrangler tail | grep "ERROR"
```

### 解決方案

#### 方案 1: 增加並發處理
```toml
# apps/queue-worker/wrangler.toml
[[queues.consumers]]
queue = "transcription-queue"
max_batch_size = 10  # 增加批次大小
max_retries = 3
max_concurrency = 10  # 增加並發數
```

重新部署:
```bash
cd apps/queue-worker
wrangler publish
```

#### 方案 2: 臨時清理無效訊息
如果發現大量無效訊息:
```bash
# 需要手動實作清理邏輯
# 可以添加管理端點來清理
```

### 預防措施
- 監控 Queue 深度
- 設置自動擴展
- 優化處理速度

---

## 場景 3: Database 性能下降

### 症狀
- 查詢時間明顯增加 (>500ms)
- 應用回應緩慢

### 緊急程度
**P2 (Medium)**

### 診斷步驟

#### 1. 查看慢查詢
```sql
SELECT
    query,
    mean_exec_time,
    calls,
    total_exec_time
FROM pg_stat_statements
WHERE mean_exec_time > 100
ORDER BY mean_exec_time DESC
LIMIT 10;
```

#### 2. 檢查鎖等待
```sql
SELECT
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.page IS NOT DISTINCT FROM blocked_locks.page
    AND blocking_locks.tuple IS NOT DISTINCT FROM blocked_locks.tuple
    AND blocking_locks.virtualxid IS NOT DISTINCT FROM blocked_locks.virtualxid
    AND blocking_locks.transactionid IS NOT DISTINCT FROM blocked_locks.transactionid
    AND blocking_locks.classid IS NOT DISTINCT FROM blocked_locks.classid
    AND blocking_locks.objid IS NOT DISTINCT FROM blocked_locks.objid
    AND blocking_locks.objsubid IS NOT DISTINCT FROM blocked_locks.objsubid
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

#### 3. 檢查索引使用
```sql
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read
FROM pg_stat_user_indexes
WHERE idx_scan = 0
AND schemaname NOT IN ('pg_catalog', 'information_schema');
```

### 解決方案

#### 方案 1: 優化慢查詢
1. 使用 EXPLAIN ANALYZE 分析查詢
2. 添加必要的索引
3. 重寫低效查詢

#### 方案 2: 清理連接
```sql
-- 終止 idle 超過 5 分鐘的連接
SELECT pg_terminate_backend(pid)
FROM pg_stat_activity
WHERE state = 'idle'
AND state_change < NOW() - INTERVAL '5 minutes';
```

#### 方案 3: 數據清理
```sql
-- 刪除舊的已完成記錄 (保留 30 天)
DELETE FROM conversations
WHERE status = 'completed'
AND created_at < NOW() - INTERVAL '30 days';
```

### 預防措施
- 定期執行 VACUUM ANALYZE
- 監控慢查詢
- 實作數據歸檔策略

---

## 場景 4: Slack Bot 無回應

### 症狀
- Slack slash commands 沒有回應
- 用戶無法上傳音檔

### 緊急程度
**P0 (Critical)**

### 診斷步驟

#### 1. 檢查 Worker 狀態
```bash
cd apps/slack-bot
wrangler tail
```

#### 2. 測試 Slack 簽名驗證
```bash
# 查看是否有簽名驗證錯誤
wrangler tail | grep "Invalid signature"
```

#### 3. 檢查環境變數
```bash
# 驗證 SLACK_BOT_TOKEN 是否正確
wrangler secret list
```

### 解決方案

#### 方案 1: 重新部署
```bash
cd apps/slack-bot
wrangler publish
```

#### 方案 2: 更新 Slack 配置
1. 檢查 Slack App 配置: https://api.slack.com/apps
2. 驗證 Request URL 是否正確
3. 重新產生 signing secret (如果需要)

#### 方案 3: 檢查 Rate Limiting
```bash
# 查看是否被 Slack rate limiting
wrangler tail | grep "rate_limited"
```

### 預防措施
- 實作 health check endpoint
- 監控 Slack API 狀態
- 設置備援機制

---

## 場景 5: 資料庫備份失敗

### 症狀
- 備份腳本執行失敗
- 備份檔案損壞或不完整

### 緊急程度
**P2 (Medium)**

### 診斷步驟

#### 1. 檢查備份日誌
```bash
./scripts/backup-database.sh 2>&1 | tee backup.log
```

#### 2. 驗證備份檔案
```bash
# 檢查檔案大小
ls -lh backups/

# 測試還原 (在 test DB)
gunzip -c backups/backup_latest.sql.gz | head -100
```

### 解決方案

#### 方案 1: 手動備份
```bash
# 使用 Neon Console 手動創建備份
# 或使用 pg_dump
pg_dump $DATABASE_URL > manual_backup.sql
```

#### 方案 2: 使用 Neon Branch
```bash
# 使用 Neon API 創建分支 (快照)
curl -X POST https://console.neon.tech/api/v2/projects/$PROJECT_ID/branches \
  -H "Authorization: Bearer $NEON_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"name":"backup-'$(date +%Y%m%d)'"}'
```

### 預防措施
- 自動化備份腳本 (cron job)
- 測試還原流程
- 使用 Neon 自動備份功能

---

## 場景 6: 部署後回滾

### 症狀
- 部署後發現嚴重 bug
- 服務異常需要緊急回滾

### 緊急程度
**P0 (Critical)**

### 執行步驟

#### 1. 立即執行回滾
```bash
./scripts/rollback.sh
```

#### 2. 驗證回滾
```bash
# 檢查服務狀態
wrangler tail

# 測試基本功能
curl https://your-api.com/health
```

#### 3. 通知團隊
```bash
# 發送 Slack 通知
curl -X POST $SLACK_WEBHOOK_URL \
  -H 'Content-Type: application/json' \
  -d '{"text":"⚠️ 緊急回滾已執行"}'
```

### 後續行動
1. 分析失敗原因
2. 修復 bug
3. 重新測試
4. 再次部署

---

## 常用命令速查

### Cloudflare Workers

```bash
# 查看即時日誌
wrangler tail

# 部署
wrangler publish

# 查看部署歷史
wrangler deployments list

# 查看 secrets
wrangler secret list
```

### Database

```bash
# 連接資料庫
psql $DATABASE_URL

# 查看所有表
\dt

# 查看表結構
\d conversations

# 查看連接數
SELECT count(*) FROM pg_stat_activity;
```

### 備份與還原

```bash
# 備份
./scripts/backup-database.sh

# 還原
gunzip -c backups/backup_20260115.sql.gz | psql $DATABASE_URL
```

---

## 檢查清單

### 部署前
- [ ] 所有測試通過
- [ ] 資料庫已備份
- [ ] 環境變數已設置
- [ ] 團隊已通知

### 部署後
- [ ] Health check 通過
- [ ] 日誌無錯誤
- [ ] 核心功能測試通過
- [ ] 監控指標正常

### 緊急回滾
- [ ] 執行回滾腳本
- [ ] 驗證服務恢復
- [ ] 通知團隊
- [ ] 記錄事件

---

## 相關文檔
- [監控指南](.doc/20260115_Monitoring_Guide.md)
- [部署檢查清單](.doc/20260115_Deployment_Checklist.md)
- [架構文檔](.doc/20260115_Agent_A_基礎設施與核心服務實作計畫.md)

---

**版本**: 1.0
**更新日期**: 2026-01-15
**維護人**: Agent A Infrastructure Team
