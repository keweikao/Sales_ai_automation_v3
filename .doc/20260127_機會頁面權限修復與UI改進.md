# 20260127 機會頁面權限修復與 UI 改進

## 摘要

本次工作主要處理以下問題：
1. 建立 `/case` Skill 快速查詢案件進度
2. Lambda 音檔壓縮設定調整
3. 機會頁面權限問題修復（Slack 建立的商機在網頁無法顯示）
4. 機會列表 UI 改進（新增案件編號、SPIN 分數）
5. 屏蔽對話頁面導航

---

## 一、/case Skill 建立

### 背景
用戶希望能快速查詢特定案件的處理進度，而不需要經過複雜的診斷流程。

### 實作內容

**新增檔案：**
- `.claude/skills/case/skill.md` - Skill 定義
- `scripts/case-lookup.ts` - 快速查詢腳本

**功能：**
```bash
/case IC918        # 查詢案件 IC918
/case 202601-IC918 # 完整案件編號查詢
```

**查詢結果包含：**
- 案件編號、公司名稱、客戶編號
- 處理狀態（pending/processing/completed/failed）
- MEDDIC 分析完成狀態及分數
- 音檔長度、建立時間

---

## 二、Lambda 音檔壓縮設定調整

### 背景
案件 IC920 處理失敗，調查發現 77 分鐘的音檔（37.67 MB）超過 Groq API 的 25MB 限制，但 Lambda 壓縮未被觸發。

### 問題原因
原本的觸發條件為 `> 25MB`，但實際上應該更保守地設定。

### 修改內容

**檔案：** `apps/queue-worker/src/index.ts`

| 設定項目 | 修改前 | 修改後 |
|---------|--------|--------|
| `GROQ_SIZE_LIMIT_MB` | 25 | 20 |
| Lambda timeout | 180,000 ms (3分鐘) | 360,000 ms (6分鐘) |

### 驗證
- IC921 測試案件（20MB+）成功觸發 Lambda 壓縮並完成處理

---

## 三、機會頁面權限問題修復

### 問題描述
用戶回報 IC923 案件：
- Slack Bot 已成功發送分析報告
- 但網頁端 `/opportunities/b57b1302-7be7-478a-b95a-c065e2ee1387` 顯示「找不到機會」

### 根本原因
`getOpportunity` API 原本的權限檢查邏輯只允許 `userId === 當前用戶` 查看。但 Slack Bot 建立的商機，其 `userId` 為 `service-account`，導致一般用戶無法查看。

### 修復方案

**檔案：** `packages/api/src/routers/opportunity.ts`

**修改前（約 line 475）：**
```typescript
const opportunity = await db.query.opportunities.findFirst({
  where: and(
    eq(opportunities.id, opportunityId),
    eq(opportunities.userId, userId)  // 嚴格限制為當前用戶
  ),
  // ...
});
```

**修改後：**
```typescript
// 先查詢 opportunity（不限制 userId）
const opportunity = await db.query.opportunities.findFirst({
  where: eq(opportunities.id, opportunityId),
  // ...
});

if (!opportunity) {
  throw new ORPCError("NOT_FOUND");
}

// 檢查權限：所有者、管理員/主管、或 Slack 建立的商機
const userEmail = context.session?.user.email;
const userRole = getUserRole(userEmail);
const isOwner = opportunity.userId === userId;
const isSlackGenerated =
  !opportunity.userId || opportunity.userId === "service-account";
const hasAdminAccess = userRole === "admin" || userRole === "manager";

if (!(isOwner || isSlackGenerated || hasAdminAccess)) {
  throw new ORPCError("FORBIDDEN");
}
```

### 權限邏輯
| 條件 | 允許存取 |
|------|---------|
| `opportunity.userId === 當前用戶` | ✅ 所有者 |
| `opportunity.userId === "service-account"` | ✅ Slack 建立 |
| `opportunity.userId === null` | ✅ 無指定擁有者 |
| `userRole === "admin" 或 "manager"` | ✅ 管理權限 |

---

## 四、機會列表 UI 改進

### 需求
1. 新增「案件編號」欄位
2. 將「機會分數」欄位替換為「SPIN 分數」（原機會分數與 PDCM 重複）

### API 修改

**檔案：** `packages/api/src/routers/opportunity.ts` - `listOpportunities`

**新增回傳欄位：**
```typescript
return {
  // ... 原有欄位
  latestCaseNumber: latestConversation?.caseNumber || null,
  spinScore: extractedSpinScore,  // 從 agent3.spin_analysis.spin_completion_rate 提取
};
```

**SPIN 分數提取邏輯：**
```typescript
const agent3 = latestAnalysis.agentOutputs?.agent3;
const spinAnalysis = agent3?.spin_analysis;
const completionRate = spinAnalysis?.spin_completion_rate;
spinScore = Math.round(completionRate * 100);  // 轉為百分比
```

### UI 修改

**檔案：** `apps/web/src/routes/opportunities/index.tsx`

**表格欄位變更：**
| 原欄位 | 新欄位 |
|--------|--------|
| 公司名稱 | 公司名稱 |
| - | **案件編號** (新增) |
| 客戶編號 | 客戶編號 |
| 聯絡人 | 聯絡人 |
| 狀態 | 狀態 |
| 機會分數 | **SPIN** (替換) |
| PDCM | PDCM |
| 上次更新 | 上次更新 |

---

## 五、屏蔽對話頁面導航

### 需求
暫時隱藏對話頁面的導航入口（直接訪問 URL 仍可使用）

### 修改內容

**檔案：** `apps/web/src/components/header.tsx`

```typescript
const links = [
  { to: "/", label: "首頁", icon: Home },
  { to: "/opportunities", label: "機會", icon: Building2 },
  // { to: "/conversations", label: "對話", icon: MessageSquare }, // 暫時屏蔽
  { to: "/reports", label: "報告", icon: FileText },
  { to: "/todos", label: "待辦", icon: CheckSquare },
  { to: "/admin/team", label: "團隊管理", icon: Shield },
] as const;
```

**同步移除未使用的 import：**
```typescript
// 移除 MessageSquare 從 lucide-react imports
```

---

## 六、遇到的問題與修復

### 問題 1：Import 變數覆蓋導致 500 錯誤

**症狀：**
部署後 API 返回 500 Internal Server Error

**原因分析：**
在修改 `listOpportunities` 時，新增了 `conversations` 和 `meddicAnalyses` 的 import，但這些名稱與 Drizzle 的 `orderBy` callback 參數重名：

```typescript
// Import
import { conversations, meddicAnalyses, ... } from "schema";

// Drizzle 查詢中的 callback
orderBy: (conversations, { desc }) => [...]  // ← conversations 參數被 import 覆蓋
```

**修復方案：**
使用 import alias 避免衝突：

```typescript
import {
  conversations as conversationsTable,
  meddicAnalyses as meddicAnalysesTable,
  // ...
} from "@Sales_ai_automation_v3/db/schema";
```

並更新 `where` 子句：
```typescript
where: eq(conversationsTable.opportunityId, opportunity.id),
where: eq(meddicAnalysesTable.conversationId, latestConversation.id),
```

### 問題 2：Shared Package TypeScript 錯誤

**症狀：**
Build 失敗，缺少 `getTodayStartInTaipei` 等 timezone 函式

**原因：**
`packages/shared/src/utils/timezone.ts` 有 TypeScript 型別錯誤導致 build 失敗

**修復：**
```typescript
// 修復前
const [year, month, day] = dateStr.split("-").map(Number);

// 修復後（處理可能 undefined 的情況）
const parts = dateStr.split("-").map(Number);
const year = parts[0] ?? 0;
const month = parts[1] ?? 1;
const day = parts[2] ?? 1;
```

---

## 七、部署紀錄

### 部署命令

```bash
# Server
cd apps/server && bunx wrangler deploy

# Web (如需)
cd apps/web && bun run build && bunx wrangler pages deploy dist

# Queue Worker (如有修改)
cd apps/queue-worker && bunx wrangler deploy
```

### 最終部署版本

| 應用 | Version ID | 狀態 |
|------|------------|------|
| server | dc7a257a-1324-488d-ad8a-1a35e489054c | ✅ 已還原原始版本 |
| queue-worker | (Lambda 設定已更新) | ✅ |

---

## 八、待辦事項

1. **重新實作權限修復** - 目前已還原原始版本以排查 500 錯誤，需重新正確實作
2. **驗證修復效果** - 確認用戶可以查看 Slack 建立的商機
3. **機會列表 UI 更新** - 案件編號和 SPIN 分數欄位
4. **考慮建立整合測試** - 避免未來類似的 import 衝突問題

---

## 九、相關檔案清單

| 檔案路徑 | 修改類型 | 說明 |
|----------|----------|------|
| `packages/api/src/routers/opportunity.ts` | 修改 | 權限邏輯、API 回傳欄位 |
| `apps/web/src/routes/opportunities/index.tsx` | 修改 | 表格欄位調整 |
| `apps/web/src/components/header.tsx` | 修改 | 隱藏對話導航 |
| `apps/queue-worker/src/index.ts` | 修改 | Lambda 壓縮設定 |
| `packages/shared/src/utils/timezone.ts` | 修改 | TypeScript 型別修復 |
| `.claude/skills/case/skill.md` | 新增 | Case 查詢 Skill |
| `scripts/case-lookup.ts` | 新增 | 案件查詢腳本 |

---

## 十、教訓與最佳實踐

### 1. Import 命名衝突
在使用 Drizzle ORM 的 relational queries 時，避免將 table imports 命名為與 callback 參數相同的名稱。建議：
- 使用 alias: `import { table as tableSchema } from ...`
- 或使用完整的 namespace: `import * as schema from ...`

### 2. 部署前驗證
- 執行 `bun x ultracite check` 確認無 lint 錯誤
- 執行 `bun run typecheck` 確認型別正確
- 本地測試 API 端點（若可能）

### 3. 權限修改的影響
修改 API 權限邏輯時，需考慮：
- 現有資料的 ownership 狀態
- 不同建立來源（web、Slack、API）的差異
- 向後相容性
