# Slack Bot 無回應問題排查

## 🔍 問題現狀
- **測試環境**: 私訊頻道 (Direct Message with Bot)
- **行為**: 上傳音檔後沒有任何回應
- **預期**: Bot 應該發送互動式表單

---

## 🎯 立即測試方案

### 測試 1: 在公開頻道測試 (推薦先做這個)

這能幫助確認 Bot 功能本身是否正常。

**步驟**:
1. 建立一個測試頻道 (例: `#test-sales-ai`)
2. 在頻道中邀請 Bot:
   ```
   /invite @你的bot名稱
   ```
3. 在該頻道上傳一個音檔 (mp3/wav/m4a)
4. 觀察 Bot 是否有回應

**如果有回應** ✅
- 代表 Bot 功能正常
- 問題出在私訊的事件訂閱配置

**如果沒有回應** ❌
- 需要檢查 Cloudflare Workers 日誌
- 可能是權限或事件訂閱問題

---

### 測試 2: 檢查 Slack Event Subscriptions 配置

前往: https://api.slack.com/apps

**檢查 Bot Token Scopes** (OAuth & Permissions):
確認以下權限都已加入:
- ✅ `files:read` - 讀取檔案
- ✅ `files:write` - 寫入檔案 (如果需要)
- ✅ `chat:write` - 發送訊息
- ✅ `chat:write.public` - 在公開頻道發送訊息
- ✅ `im:write` - 在私訊發送訊息
- ✅ `im:history` - 讀取私訊歷史
- ✅ `channels:history` - 讀取頻道歷史
- ✅ `groups:history` - 讀取私人頻道歷史
- ✅ `mpim:history` - 讀取群組私訊歷史

**檢查 Event Subscriptions**:
確認以下事件都已訂閱:
- ✅ `file_shared` - 檔案分享事件
- ✅ `message.channels` - 頻道訊息
- ✅ `message.groups` - 私人頻道訊息
- ✅ `message.im` - 私訊訊息
- ✅ `message.mpim` - 群組私訊訊息

**⚠️ 重要**: 如果新增了權限,需要:
1. 點選 "Install App" 重新安裝
2. 或點選 "Reinstall App"

---

### 測試 3: 檢查 Cloudflare Workers 日誌

**Slack Bot 日誌**:
1. 前往: https://dash.cloudflare.com/
2. 選擇: Workers & Pages → sales-ai-slack-bot → Logs
3. 點選 "Begin log stream"
4. 在 Slack 上傳音檔
5. 觀察是否有任何日誌輸出

**可能看到的情況**:

**情況 A**: 完全沒有日誌
- 代表 Slack 根本沒有發送事件到你的 Worker
- 需要檢查 Event Subscriptions URL 是否正確
- 確認 Event Subscriptions 已啟用

**情況 B**: 看到 "Unhandled event type"
- 代表收到了事件,但不是 `file_shared` 類型
- 可能需要訂閱額外的事件

**情況 C**: 看到 "Failed to get file info"
- 代表 Bot 沒有讀取檔案的權限
- 需要新增 `files:read` scope

**情況 D**: 看到 "Ignoring non-audio file"
- 檔案類型不在支援清單中
- 確認上傳的是音檔 (mp3/wav/m4a)

---

## 🔧 Slack API 已知限制

### 私訊 (DM) 中的 file_shared 事件

根據 Slack API 文件,`file_shared` 事件在私訊中的行為可能不同:

**可能的限制**:
1. 私訊中的檔案分享可能不會觸發 `file_shared` 事件
2. 需要透過 `message` 事件中的 `files` 屬性來偵測

**解決方案**: 修改程式碼來同時處理 `message` 事件中的檔案

---

## 💡 建議的除錯流程

### 階段 1: 驗證基本功能 (5分鐘)
1. ✅ 在公開頻道測試音檔上傳
2. ✅ 確認 Bot 在公開頻道正常運作

### 階段 2: 確認權限配置 (5分鐘)
1. ✅ 檢查所有 OAuth Scopes
2. ✅ 檢查所有 Event Subscriptions
3. ✅ 如有變更,重新安裝 App

### 階段 3: 查看日誌 (5分鐘)
1. ✅ 開啟 Cloudflare Workers 日誌
2. ✅ 在 Slack 觸發事件
3. ✅ 記錄任何錯誤訊息

### 階段 4: 針對性修復 (視情況)
根據測試結果決定下一步

---

## 📝 回報格式

測試完成後,請提供以下資訊:

**測試 1 結果**:
- 公開頻道測試: [ ] 成功 [ ] 失敗
- 錯誤訊息 (如有):

**測試 2 結果**:
- 缺少的 Scopes (如有):
- 缺少的 Events (如有):

**測試 3 結果**:
- Cloudflare 日誌內容:
```
[貼上日誌]
```

---

## 🚀 快速修復建議

### 如果公開頻道測試成功

這代表 Bot 功能正常,只是私訊配置問題。

**修復方案**:
1. 確保 `im:history` scope 已加入
2. 確保 `message.im` event 已訂閱
3. 考慮修改程式碼來處理 `message` 事件中的檔案附件

### 如果公開頻道也失敗

**檢查清單**:
- [ ] Event Subscriptions URL 是否正確設定
- [ ] URL Verification 是否通過
- [ ] `files:read` scope 是否已加入
- [ ] Bot 是否已加入頻道

---

**測試時間**: [待填寫]
**問題狀態**: [待更新]
