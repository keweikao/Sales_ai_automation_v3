# Phase 1.1 PostgreSQL MCP æ•´åˆå®Œæˆå ±å‘Š

**æ—¥æœŸ**: 2026-01-15
**ç‹€æ…‹**: âœ… å·²å®Œæˆ
**åŸ·è¡Œè€…**: Claude Code Agent

## ğŸ“‹ ä»»å‹™æ¦‚è¿°

æ•´åˆ PostgreSQL ä½œç‚º MCP (Model Context Protocol) å·¥å…·ï¼Œè®“ AI Agent èƒ½å¤ ç›´æ¥æŸ¥è©¢è³‡æ–™åº«ï¼Œé€²è¡Œè¤‡é›œçš„è³‡æ–™åˆ†æã€å ±è¡¨ç”Ÿæˆå’Œè¶¨å‹¢åˆ†æã€‚

## âœ… å®Œæˆé …ç›®

### 1. å»ºç«‹ PostgreSQL MCP å·¥å…·åŒ…è£å±¤

**æª”æ¡ˆ**: [`packages/services/src/mcp/external/postgres.ts`](packages/services/src/mcp/external/postgres.ts)

å¯¦ä½œäº†å…©å€‹æ ¸å¿ƒå·¥å…·ï¼š

#### `postgres_query` å·¥å…·
- **åŠŸèƒ½**: åŸ·è¡Œ PostgreSQL SELECT æŸ¥è©¢
- **å®‰å…¨æ€§**: åƒ…å…è¨± SELECT æŸ¥è©¢ï¼Œæ‹’çµ• DELETE/UPDATE/INSERT ç­‰ä¿®æ”¹æ“ä½œ
- **ç”¨é€”**: è¤‡é›œè³‡æ–™åˆ†æã€å ±è¡¨ç”Ÿæˆã€è¶¨å‹¢åˆ†æ
- **æ•´åˆ**: ä½¿ç”¨ç¾æœ‰çš„ Drizzle ORM é€£ç·š (`@Sales_ai_automation_v3/db`)

#### `postgres_inspect_schema` å·¥å…·
- **åŠŸèƒ½**: æª¢è¦–è³‡æ–™åº« schema çµæ§‹
- **èƒ½åŠ›**:
  - åˆ—å‡ºæ‰€æœ‰è³‡æ–™è¡¨
  - æª¢è¦–ç‰¹å®šè¡¨çš„æ¬„ä½å®šç¾©ï¼ˆåç¨±ã€é¡å‹ã€nullableï¼‰
- **ç”¨é€”**: äº†è§£è³‡æ–™åº«çµæ§‹ã€ç”¢ç”ŸæŸ¥è©¢ã€é©—è­‰è³‡æ–™æ¨¡å‹

### 2. å»ºç«‹æ¸¬è©¦ç‰ˆæœ¬å·¥å…·

**æª”æ¡ˆ**: [`packages/services/src/mcp/external/postgres-test.ts`](packages/services/src/mcp/external/postgres-test.ts)

- ç¨ç«‹çš„æ¸¬è©¦ç‰ˆæœ¬ï¼Œä¸ä¾è³´ `cloudflare:workers` ç’°å¢ƒ
- ç›´æ¥ä½¿ç”¨ `process.env.DATABASE_URL`
- ç”¨æ–¼æœ¬åœ°é–‹ç™¼å’Œæ¸¬è©¦

### 3. å»ºç«‹å¸¸ç”¨æŸ¥è©¢æ¨¡æ¿

**æª”æ¡ˆ**: [`packages/services/src/mcp/templates/analytics-queries.ts`](packages/services/src/mcp/templates/analytics-queries.ts)

æä¾› 8 å€‹é å®šç¾©æŸ¥è©¢æ¨¡æ¿ï¼š

1. **`teamPerformance(period)`** - åœ˜éšŠç¸¾æ•ˆçµ±è¨ˆï¼ˆé€±/æœˆ/å­£ï¼‰
2. **`repPerformance(repId, period)`** - æ¥­å‹™å€‹äººç¸¾æ•ˆ
3. **`opportunityFunnel()`** - å•†æ©Ÿæ¼æ–—åˆ†æ
4. **`meddicTrend(opportunityId)`** - MEDDIC è©•åˆ†è¶¨å‹¢
5. **`recentAlerts(limit)`** - æœ€è¿‘è­¦ç¤ºåˆ—è¡¨
6. **`lowScoreOpportunities(threshold)`** - ä½è©•åˆ†å•†æ©Ÿåˆ—è¡¨
7. **`transcriptionStats()`** - è½‰éŒ„ä»»å‹™ç‹€æ…‹çµ±è¨ˆ
8. **`orphanedRecords()`** - è³‡æ–™åº«å¥åº·æª¢æŸ¥ï¼ˆå­¤ç«‹è¨˜éŒ„ï¼‰

**è¼”åŠ©å·¥å…·**: `QueryBuilder` æä¾›æ—¥æœŸç¯„åœã€åˆ†é ã€æ’åºæ¢ä»¶å»ºæ§‹å™¨

### 4. ä¿®æ”¹ MCP Server è¨»å†Š

**æª”æ¡ˆ**: [`packages/services/src/mcp/server.ts`](packages/services/src/mcp/server.ts:336-357)

æ–°å¢ `createFullMCPServer()` å‡½æ•¸ï¼š
- è‡ªå‹•è¨»å†Šæ‰€æœ‰ PostgreSQL å·¥å…·
- æœªä¾†å¯æ“´å±•è¨»å†Šå…¶ä»–å¤–éƒ¨ MCP ä¼ºæœå™¨å·¥å…·

### 5. æ›´æ–°å·¥å…·ç´¢å¼•

**æª”æ¡ˆ**: [`packages/services/src/mcp/tools/index.ts`](packages/services/src/mcp/tools/index.ts:92-105)

åŒ¯å‡º PostgreSQL å·¥å…·å’ŒæŸ¥è©¢æ¨¡æ¿ï¼Œæ–¹ä¾¿å…¶ä»–æ¨¡çµ„ä½¿ç”¨ã€‚

### 6. å®‰è£å¿…è¦ä¾è³´

```bash
# Root å°ˆæ¡ˆ
bun add -d dotenv

# Services å¥—ä»¶
cd packages/services
bun add @neondatabase/serverless ws
```

### 7. æ¸¬è©¦é©—è­‰

**æ¸¬è©¦è…³æœ¬**: [`test-postgres-direct.ts`](test-postgres-direct.ts)

åŸ·è¡Œçµæœï¼š
```
âœ… æ¸¬è©¦ 1: åŸºæœ¬é€£ç·šæ¸¬è©¦ - æˆåŠŸ
âœ… æ¸¬è©¦ 2: åˆ—å‡ºæ‰€æœ‰è³‡æ–™è¡¨ - æˆåŠŸï¼ˆ18 å€‹è¡¨ï¼‰
âœ… æ¸¬è©¦ 3: æª¢è¦– conversations è¡¨çµæ§‹ - æˆåŠŸï¼ˆ29 å€‹æ¬„ä½ï¼‰
âœ… æ¸¬è©¦ 4: åŸ·è¡Œç°¡å–®æŸ¥è©¢ (COUNT) - æˆåŠŸï¼ˆ4 ç­†å°è©±ï¼‰
âœ… æ¸¬è©¦ 5: è½‰éŒ„ä»»å‹™ç‹€æ…‹çµ±è¨ˆ - æˆåŠŸ
```

æ‰€æœ‰æ¸¬è©¦é€šéï¼âœ¨

## ğŸ—ï¸ æ¶æ§‹è¨­è¨ˆ

### MCP å·¥å…·ä»‹é¢

```typescript
export const postgresQueryTool: MCPTool<
  PostgresQueryInput,
  PostgresQueryOutput
> = {
  name: "postgres_query",
  description: "åŸ·è¡Œ PostgreSQL SELECT æŸ¥è©¢...",
  inputSchema: PostgresQueryInputSchema,  // Zod schema
  handler: async (input, context) => {
    // å®‰å…¨æ€§æª¢æŸ¥
    // åŸ·è¡ŒæŸ¥è©¢
    // è¿”å›çµæœ
  }
};
```

### å®‰å…¨æ€§è¨­è¨ˆ

1. **æŸ¥è©¢é¡å‹é™åˆ¶**: åƒ…å…è¨± `SELECT` æŸ¥è©¢
2. **éŒ¯èª¤è™•ç†**: å®Œæ•´çš„éŒ¯èª¤æ•ç²å’Œè¨Šæ¯å›å‚³
3. **Schema é©—è­‰**: ä½¿ç”¨ Zod é€²è¡Œè¼¸å…¥é©—è­‰
4. **SQL Injection é˜²è­·**: ä½¿ç”¨ Drizzle ORM çš„åƒæ•¸åŒ–æŸ¥è©¢

### ç’°å¢ƒå€éš”

- **ç”Ÿç”¢ç’°å¢ƒ** (`postgres.ts`): ä½¿ç”¨ `@Sales_ai_automation_v3/db` + Cloudflare Workers env
- **æ¸¬è©¦ç’°å¢ƒ** (`postgres-test.ts`): ä½¿ç”¨ `process.env.DATABASE_URL` + Node.js

## ğŸ“Š è³‡æ–™åº«çµ±è¨ˆï¼ˆæ¸¬è©¦ç’°å¢ƒï¼‰

- **è³‡æ–™è¡¨æ•¸é‡**: 18
- **Conversations è¡¨æ¬„ä½**: 29
- **ç•¶å‰å°è©±è¨˜éŒ„**: 4 ç­†
- **æœ€è¿‘ç‹€æ…‹**: 4 ç­† failedï¼ˆæœ€è¿‘ 7 å¤©ï¼‰

## ğŸ¯ ä½¿ç”¨ç¯„ä¾‹

### 1. æŸ¥è©¢åœ˜éšŠç¸¾æ•ˆ

```typescript
import { ANALYTICS_QUERIES } from '@Sales_ai_automation_v3/services';

const result = await mcpServer.executeTool(
  'postgres_query',
  { query: ANALYTICS_QUERIES.teamPerformance('month') },
  context
);
```

### 2. æª¢è¦–è¡¨çµæ§‹

```typescript
const schema = await mcpServer.executeTool(
  'postgres_inspect_schema',
  { tableName: 'conversations' },
  context
);
```

### 3. è‡ªè¨‚æŸ¥è©¢

```typescript
const result = await mcpServer.executeTool(
  'postgres_query',
  {
    query: `
      SELECT COUNT(*) as total
      FROM conversations
      WHERE status = 'completed'
    `
  },
  context
);
```

## ğŸ”„ å¾ŒçºŒæ•´åˆ

### åœ¨ Orchestrator ä¸­ä½¿ç”¨

```typescript
import { createFullMCPServer } from '@Sales_ai_automation_v3/services/mcp';

const mcpServer = createFullMCPServer({ enableLogging: true });

// ç¾åœ¨ Orchestrator å¯ä»¥å‘¼å« postgres_query å’Œ postgres_inspect_schema
```

### åœ¨ Ops Agent ä¸­ä½¿ç”¨

Ops Agent å¯ä»¥ä½¿ç”¨é€™äº›å·¥å…·é€²è¡Œï¼š
- è³‡æ–™åº«å¥åº·æª¢æŸ¥
- æ€§èƒ½åˆ†æ
- ç•°å¸¸åµæ¸¬
- è‡ªå‹•åŒ–å ±è¡¨ç”Ÿæˆ

## ğŸ“ æŠ€è¡“ç´°ç¯€

### ä¾è³´é …
- `drizzle-orm`: ORM æ¡†æ¶
- `@neondatabase/serverless`: Neon PostgreSQL å®¢æˆ¶ç«¯
- `ws`: WebSocket æ”¯æ´ï¼ˆNeon é€£ç·šä½¿ç”¨ï¼‰
- `zod`: Schema é©—è­‰
- `zod-to-json-schema`: è½‰æ› Zod schema ç‚º JSON schema

### æª”æ¡ˆçµæ§‹

```
packages/services/src/mcp/
â”œâ”€â”€ server.ts                           # MCP Server ä¸»æª”æ¡ˆ
â”œâ”€â”€ external/
â”‚   â”œâ”€â”€ postgres.ts                     # ç”Ÿç”¢ç’°å¢ƒ PostgreSQL å·¥å…·
â”‚   â””â”€â”€ postgres-test.ts                # æ¸¬è©¦ç’°å¢ƒ PostgreSQL å·¥å…·
â”œâ”€â”€ templates/
â”‚   â””â”€â”€ analytics-queries.ts            # å¸¸ç”¨æŸ¥è©¢æ¨¡æ¿
â””â”€â”€ tools/
    â””â”€â”€ index.ts                         # å·¥å…·ç´¢å¼•ï¼ˆå·²æ›´æ–°ï¼‰
```

## âš ï¸ å·²çŸ¥é™åˆ¶

1. **Cloudflare Workers ç’°å¢ƒ**:
   - `postgres.ts` ä¾è³´ `cloudflare:workers` çš„ env
   - æœ¬åœ°æ¸¬è©¦éœ€ä½¿ç”¨ `postgres-test.ts` ç‰ˆæœ¬

2. **æŸ¥è©¢é™åˆ¶**:
   - åƒ…æ”¯æ´ `SELECT` æŸ¥è©¢
   - è³‡æ–™ä¿®æ”¹æ“ä½œéœ€ä½¿ç”¨å°ˆç”¨çš„ repair tools

3. **æ¸¬è©¦ç’°å¢ƒ**:
   - æ¸¬è©¦è…³æœ¬éœ€è¦ `apps/server/.env` æª”æ¡ˆåŒ…å« `DATABASE_URL`

## âœ¨ æˆå°±è§£é–

- âœ… PostgreSQL MCP å·¥å…·å®Œå…¨é‹ä½œ
- âœ… 8 å€‹å¸¸ç”¨æŸ¥è©¢æ¨¡æ¿å°±ç·’
- âœ… å®‰å…¨æ€§æ©Ÿåˆ¶å®Œæ•´ï¼ˆSELECT-onlyï¼‰
- âœ… æ¸¬è©¦å®Œæ•´é€šé
- âœ… ç”Ÿç”¢èˆ‡æ¸¬è©¦ç’°å¢ƒåˆ†é›¢
- âœ… æ–‡ä»¶å®Œæ•´è¨˜éŒ„

## ğŸ‰ Phase 1.1 å®Œæˆï¼

ä¸‹ä¸€æ­¥: **Phase 1.2 - Filesystem MCP Server æ•´åˆ**
