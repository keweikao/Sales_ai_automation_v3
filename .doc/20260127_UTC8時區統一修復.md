# UTC+8 時區統一修復

**日期**: 2026-01-27
**問題**: Todos 頁面 1/27 的待辦事項未正確顯示

---

## 問題分析

### 發現的問題

1. **前端月度統計查詢 (todos/index.tsx)**
   - `monthTodosQuery` 的 `dateTo` 參數沒有加上 `T23:59:59`
   - 導致 `new Date("2026-01-31")` 被解析為 UTC 00:00:00
   - 造成當天較晚時間的待辦不會被包含在查詢結果中

2. **後端 API 時區邏輯 (sales-todo.ts)**
   - `getTodaysTodos` 使用 `setHours(0, 0, 0, 0)` 而非時區感知的方法
   - Cloudflare Workers 默認使用 UTC 時區，導致「今天」的定義錯誤
   - 日期篩選邏輯未正確處理 UTC+8 時區

3. **Slack Bot 日期格式化 (todo-reminder.ts, report.ts)**
   - 使用 `getMonth()`, `getDate()`, `getDay()` 依賴伺服器時區 (UTC)
   - `toLocaleString("zh-TW")` 在 Cloudflare Workers 中不會使用 UTC+8

---

## 修復內容

### 1. 建立統一的時區工具函式

新增 `packages/shared/src/utils/timezone.ts`：

```typescript
// 主要函式
nowInTaipei()                    // 取得當前 UTC+8 時間
getTodayStartInTaipei()          // 取得 UTC+8 的今天開始時間
getTodayEndInTaipei()            // 取得 UTC+8 的今天結束時間
getDateStartInTaipei(dateStr)    // 取得特定日期在 UTC+8 的開始時間
getDateEndInTaipei(dateStr)      // 取得特定日期在 UTC+8 的結束時間
formatTaiwanDate(date)           // 格式化為 "M/d (週X)" 格式
formatDateTimeInTaipei(date)     // 格式化為 "yyyy-MM-dd HH:mm:ss" 格式
formatDateInTaipei(date)         // 格式化為 "yyyy-MM-dd" 格式
```

### 2. 修復後端 API (packages/api/src/routers/sales-todo.ts)

**getTodaysTodos 查詢**：
```diff
- const now = new Date();
- const todayStart = new Date(now);
- todayStart.setHours(0, 0, 0, 0);
- const todayEnd = new Date(now);
- todayEnd.setHours(23, 59, 59, 999);
+ const todayStart = getTodayStartInTaipei();
+ const todayEnd = getTodayEndInTaipei();
```

**list 查詢的日期篩選**：
```diff
- conditions.push(gte(salesTodos.dueDate, new Date(dateFrom)));
- conditions.push(lte(salesTodos.dueDate, new Date(dateTo)));
+ const fromDate = dateFrom.includes("T")
+   ? new Date(dateFrom)
+   : getDateStartInTaipei(dateFrom);
+ conditions.push(gte(salesTodos.dueDate, fromDate));
+ const toDate = dateTo.includes("T")
+   ? new Date(dateTo)
+   : getDateEndInTaipei(dateTo);
+ conditions.push(lte(salesTodos.dueDate, toDate));
```

### 3. 修復前端月度統計查詢 (apps/web/src/routes/todos/index.tsx)

```diff
- dateTo: monthEnd,
+ dateTo: `${monthEnd}T23:59:59`,
```

### 4. 修復 Slack Bot

**todo-reminder.ts**：
```diff
+ import { formatTaiwanDate, nowInTaipei } from "@sales_ai_automation_v3/shared";

- function formatDate(isoDate: string): string {
-   const date = new Date(isoDate);
-   const month = date.getMonth() + 1;
-   const day = date.getDate();
-   const weekday = ["日", "一", "二", "三", "四", "五", "六"][date.getDay()];
-   return `${month}/${day} (${weekday})`;
- }
+ function formatDate(isoDate: string): string {
+   return formatTaiwanDate(isoDate);
+ }

// 改期 Modal 的預設日期計算
- const tomorrow = new Date();
- tomorrow.setDate(tomorrow.getDate() + 1);
- const defaultDate = tomorrow.toISOString().split("T")[0];
+ const taipeiTomorrow = nowInTaipei();
+ taipeiTomorrow.setUTCDate(taipeiTomorrow.getUTCDate() + 1);
+ const defaultDate = `${year}-${month}-${day}`;
```

**report.ts**：
```diff
+ import { formatDateTimeInTaipei } from "@sales_ai_automation_v3/shared";

- text: `:clock1: 更新時間: ${new Date().toLocaleString("zh-TW")}`,
+ text: `:clock1: 更新時間: ${formatDateTimeInTaipei(new Date())}`,
```

---

## 部署記錄

| 服務 | 版本 ID | 狀態 |
|------|---------|------|
| Server | `0567db9a-3ec9-435d-bc3e-1ebbbe281b28` | 成功 |
| Slack Bot | `f42f6ff9-6623-4a87-8977-0c359a411bfe` | 成功 |
| Web | `bad42c2b` | 成功 |

---

## 影響範圍

- **Todos 頁面**: 日曆小圓點顯示、待辦列表篩選
- **Slack Bot**: Todo 提醒訊息的日期格式、改期 Modal 的預設日期
- **報告功能**: 更新時間顯示

---

## 測試驗證

1. 訪問 https://sales-ai-web.pages.dev/todos
2. 確認 1/27 的待辦事項正確顯示在日曆上
3. 選擇 1/27 日期，確認待辦列表正確顯示
