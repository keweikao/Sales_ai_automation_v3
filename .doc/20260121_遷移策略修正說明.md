# V2â†’V3 é·ç§»ç­–ç•¥ä¿®æ­£èªªæ˜

**å»ºç«‹æ—¥æœŸ:** 2026-01-21
**ä¿®æ­£åŸå› :** æ ¹æ“šå¯¦éš› Firestore è³‡æ–™çµæ§‹å’Œä½¿ç”¨è€…éœ€æ±‚èª¿æ•´

---

## ğŸ“Š å¯¦éš›è³‡æ–™çµæ§‹ç¢ºèª

### V2 Firestore æ¬„ä½æ ¼å¼

| æ¬„ä½ | æ ¼å¼ç¯„ä¾‹ | èªªæ˜ |
|------|----------|------|
| **Document ID** | `202511-IC004` | Firestore æ–‡æª” ID (æ¡ˆä»¶å±¤ç´š,å”¯ä¸€) |
| **data.caseId** | `202511-IC004` | ç­‰åŒæ–¼ Document ID |
| **data.customerId** | `202511-122188` | **å®¢æˆ¶å±¤ç´š ID (å¯é‡è¤‡)** âš ï¸ é—œéµç™¼ç¾ |
| **data.customerName** | `å†°` | å®¢æˆ¶åç¨± |

### é—œéµç™¼ç¾

**customerId â‰  caseId** (èˆ‡ä¹‹å‰ç†è§£ä¸åŒ!)

- ä¸€å€‹å®¢æˆ¶ (customerId) å¯èƒ½æœ‰å¤šå€‹æ¡ˆä»¶ (caseId)
- customerId æ˜¯**å®¢æˆ¶å±¤ç´š**çš„å”¯ä¸€è­˜åˆ¥ç¢¼
- caseId æ˜¯**æ¡ˆä»¶å±¤ç´š**çš„å”¯ä¸€è­˜åˆ¥ç¢¼

**ç¯„ä¾‹:**
```
å®¢æˆ¶ "å†°" (customerId: 202511-122188):
  â”œâ”€ æ¡ˆä»¶ 1: 202511-IC001
  â”œâ”€ æ¡ˆä»¶ 2: 202511-IC003
  â””â”€ æ¡ˆä»¶ 3: 202511-IC004

å®¢æˆ¶ "éº»è¾£ç‡™" (customerId: 202511-122162):
  â”œâ”€ æ¡ˆä»¶ 1: 202511-IC002
  â”œâ”€ æ¡ˆä»¶ 2: 202511-IC005
  â”œâ”€ æ¡ˆä»¶ 3: 202511-IC006
  â””â”€ æ¡ˆä»¶ 4: 202511-IC007
```

---

## âœ… ä½¿ç”¨è€…æ±ºå®š

### å•é¡Œ 1: customerNumber æ˜ å°„ç­–ç•¥
**æ±ºå®š:** **é¸é … A** - ç›´æ¥ä½¿ç”¨ V2 customerId

**ä¿®æ”¹:**
```typescript
// âŒ èˆŠæ–¹æ¡ˆ (åŸºæ–¼ customerName hash ç”Ÿæˆ)
customerNumber: generateCustomerNumber(caseDoc.customerName, createdAt)

// âœ… æ–°æ–¹æ¡ˆ (ç›´æ¥ä½¿ç”¨ V2 customerId)
customerNumber: caseDoc.customerId
```

**å„ªé»:**
- ä¿ç•™åŸå§‹å®¢æˆ¶ ID,ä¾¿æ–¼è¿½æº¯
- åŒä¸€å€‹ customerId çš„å¤šå€‹ cases æœƒæ­£ç¢ºé—œè¯åˆ°åŒä¸€å€‹ Opportunity
- é‚è¼¯ç°¡å–®,ä¸éœ€è¦è¤‡é›œçš„ hash ç”Ÿæˆ

---

### å•é¡Œ 2: User æ˜ å°„ç­–ç•¥
**æ±ºå®š:** **é¸é … A + é¡å¤–éœ€æ±‚**

**æ˜ å°„é‚è¼¯:**
1. å„ªå…ˆç”¨ `salesRepSlackId` æŸ¥è©¢ `user_profiles.slackUserId` â†’ å–å¾— `userId`
2. æ‰¾ä¸åˆ°å‰‡ä½¿ç”¨ `service-account`

**é¡å¤–éœ€æ±‚:**
- ç¢ºä¿å…¶ä»–é é¢å¯è®€å–æ¥­å‹™ email å’Œ username

**å¯¦ä½œ:**
- `salesRepName` â†’ `conversations.slackUsername` âœ… å·²å¯¦ä½œ
- `salesRepEmail` â†’ é€é `slackUserId` æŸ¥è©¢ `user_profiles` â†’ `users.email` (ä¸é‡è¤‡å„²å­˜)

---

### å•é¡Œ 3: æ¸¬è©¦è³‡æ–™éæ¿¾
**æ±ºå®š:** éæ¿¾åŒ…å«æ¸¬è©¦é—œéµå­—çš„ customerName

**é‡æ¸…:** `demoMeta` ä¸æ˜¯ demo data,æ˜¯ Demo æœƒè­°çš„ metadata

**éæ¿¾è¦å‰‡:**
```typescript
const testKeywords = [
  'æ¸¬è©¦', 'æµ‹è¯•', 'test', 'demo', 'sample',
  'ç¯„ä¾‹', 'èŒƒä¾‹', 'æ¨£æœ¬', 'æ ·æœ¬', 'testing',
  'ãƒ‡ãƒ¢', 'ãƒ†ã‚¹ãƒˆ'
];
```

**å¯¦ä½œ:**
```typescript
export function isTestData(customerName: string): boolean {
  const lowerName = customerName.toLowerCase();
  return testKeywords.some(keyword =>
    lowerName.includes(keyword.toLowerCase())
  );
}
```

**é·ç§»æµç¨‹:**
1. è®€å–æ‰€æœ‰ Firestore cases
2. éæ¿¾æ‰ `isTestData(customerName) === true` çš„ cases
3. åƒ…é·ç§»æ­£å¼è³‡æ–™

---

### å•é¡Œ 4: MEDDIC åˆ†æç­–ç•¥
**æ±ºå®š:** **é‡æ–°åˆ†æ** (ä¸é·ç§» V2 çš„åˆ†æè³‡æ–™)

**ç†ç”±:**
- V2 åƒ… 4 å€‹ Agent (agent1-4)
- V3 éœ€è¦å®Œæ•´ 6 ç¶­åº¦ MEDDIC
- ä¿ç•™æ–‡å­—ç¨¿å¾Œé‡æ–°åˆ†æ,ç¢ºä¿è³‡æ–™ä¸€è‡´æ€§

**ä¿®æ”¹:**
```typescript
// Phase 4: ä¸å»ºç«‹ meddic_analyses
console.log("ğŸ“Š Phase 4: MEDDIC Analyses - è·³é (å°‡ç”± V3 ç³»çµ±é‡æ–°åˆ†æ)");
stats.meddicAnalyses.skipped = casesWithAnalysis.length;
```

**è³‡æ–™ä¿ç•™:**
- `conversations.transcript` âœ… å®Œæ•´ä¿ç•™
- `conversations.meddicAnalysis` âœ… ä¿ç•™ç°¡åŒ–ç‰ˆ (åƒ…ä¾›åƒè€ƒ)
- `meddic_analyses` âŒ ä¸å»ºç«‹,ç”± V3 é‡æ–°åˆ†æ

---

### å•é¡Œ 5: éŸ³æª”é·ç§»æ™‚æ©Ÿ
**æ±ºå®š:** **å£“ç¸®å¾Œç¨ç«‹é·ç§»**

**æµç¨‹:**
1. **ç¬¬ä¸€éšæ®µ (ç›®å‰):** é·ç§»æ–‡å­—è³‡æ–™,`audioUrl = null`
2. **ç¬¬äºŒéšæ®µ (å¾…å¯¦ä½œ):**
   - å¾ GCS ä¸‹è¼‰éŸ³æª”
   - **å£“ç¸®éŸ³æª”** (æ¸›å°‘å„²å­˜æˆæœ¬)
   - ä¸Šå‚³è‡³ Cloudflare R2
   - æ›´æ–° `conversations.audioUrl`

**å¾…å»ºç«‹è…³æœ¬:** `scripts/migration/migrate-v3-audio-compressed.ts`

---

## ğŸ”§ å·²ä¿®æ”¹çš„æª”æ¡ˆ

### 1. `scripts/migration/mappers/v3-cases-mapper.ts`

**æ–°å¢:**
```typescript
// æ¸¬è©¦è³‡æ–™æª¢æŸ¥å‡½æ•¸
export function isTestData(customerName: string): boolean { ... }
```

**ä¿®æ”¹:**
```typescript
// ç§»é™¤ generateCustomerNumber å‡½æ•¸
// ç›´æ¥ä½¿ç”¨ V2 customerId
customerNumber: caseDoc.customerId
```

### 2. `scripts/migration/migrate-v3-cases.ts`

**Phase 1 ä¿®æ”¹:**
```typescript
// éæ¿¾æ¸¬è©¦è³‡æ–™
const caseDocs = allCaseDocs.filter(caseDoc => {
  if (isTestData(caseDoc.customerName)) {
    console.log(`â­ï¸  è·³éæ¸¬è©¦è³‡æ–™: ${caseDoc.caseId} (${caseDoc.customerName})`);
    return false;
  }
  return true;
});
```

**Phase 2 ä¿®æ”¹:**
```typescript
// æŒ‰ customerId å»é‡ (ä¸æ˜¯ customerName)
const customerGroups = new Map<string, FirestoreV3Case[]>();
for (const caseDoc of caseDocs) {
  const customerId = caseDoc.customerId;
  if (!customerGroups.has(customerId)) {
    customerGroups.set(customerId, []);
  }
  customerGroups.get(customerId)!.push(caseDoc);
}
```

**Phase 4 ä¿®æ”¹:**
```typescript
// è·³éå»ºç«‹ MEDDIC Analyses
console.log("ğŸ“Š Phase 4: MEDDIC Analyses - è·³é (å°‡ç”± V3 ç³»çµ±é‡æ–°åˆ†æ)");
stats.meddicAnalyses.skipped = casesWithAnalysis.length;
```

---

## ğŸ“‹ æ›´æ–°å¾Œçš„æ˜ å°„é—œä¿‚

### V2 â†’ V3 å®Œæ•´æ˜ å°„è¡¨

| V2 æ¬„ä½ | V3 æ¬„ä½ | èªªæ˜ |
|---------|---------|------|
| **Document ID** | `conversations.id` | å®Œå…¨æ²¿ç”¨ âœ… |
| `data.caseId` | `conversations.caseNumber` | å®Œå…¨æ²¿ç”¨ âœ… |
| **`data.customerId`** | **`opportunities.customerNumber`** | ç›´æ¥æ²¿ç”¨ âœ… (ä¿®æ­£) |
| `data.customerName` | `opportunities.companyName` | âœ… |
| `data.customerPhone` | `opportunities.contactPhone` | âœ… |
| `data.salesRepSlackId` | `opportunities.userId` (é€éæ˜ å°„) | âœ… |
| `data.salesRepSlackId` | `conversations.slackUserId` | âœ… |
| `data.salesRepName` | `conversations.slackUsername` | âœ… |
| `data.salesRepEmail` | é€é user_profiles æŸ¥è©¢ | âš ï¸ ä¸é‡è¤‡å„²å­˜ |
| `data.unit` | `opportunities.productLine` | ICâ†’ichef, OCâ†’outchef âœ… |
| `data.transcription` | `conversations.transcript` | JSONB è½‰æ› âœ… |
| `data.audio.gcsPath` | `conversations.audioUrl` | ç¬¬äºŒéšæ®µé·ç§» â³ |
| `data.analysis.*` | âŒ ä¸é·ç§» | ç”± V3 é‡æ–°åˆ†æ |

---

## ğŸ¯ é·ç§»æµç¨‹ (æ›´æ–°å¾Œ)

### éšæ®µä¸€: æ–‡å­—è³‡æ–™é·ç§»

```bash
# 1. æ¸…ç† V3 è³‡æ–™åº«
FORCE_CLEANUP=true bun run scripts/migration/cleanup-v3-database.ts

# 2. Dry Run æ¸¬è©¦
DRY_RUN=true bun run scripts/migration/migrate-v3-cases.ts

# 3. æ­£å¼é·ç§»
DRY_RUN=false bun run scripts/migration/migrate-v3-cases.ts

# 4. é©—è­‰çµæœ
bun run scripts/migration/validate-v3-cases.ts
```

**é æœŸçµæœ:**
- âœ… éæ¿¾æ¸¬è©¦è³‡æ–™ (åŒ…å«æ¸¬è©¦é—œéµå­—çš„ customerName)
- âœ… Opportunities æŒ‰ customerId å»é‡
- âœ… Conversations ä¿ç•™å®Œæ•´ transcript
- âœ… ä¸å»ºç«‹ meddic_analyses (ç”± V3 é‡æ–°åˆ†æ)
- âœ… audioUrl ç‚º null (å¾…ç¬¬äºŒéšæ®µ)

### éšæ®µäºŒ: éŸ³æª”é·ç§» (å¾…å¯¦ä½œ)

**è…³æœ¬:** `scripts/migration/migrate-v3-audio-compressed.ts`

**æµç¨‹:**
1. GCS ä¸‹è¼‰éŸ³æª”
2. **å£“ç¸®è™•ç†** (ffmpeg)
3. ä¸Šå‚³è‡³ R2
4. æ›´æ–° conversations.audioUrl

---

## ğŸ“Š é æœŸçµ±è¨ˆ

**V2 Firestore:** 271 ç­† cases

**é æœŸé·ç§»çµæœ:**
- éæ¿¾æ¸¬è©¦è³‡æ–™: ~10-20 ç­† (å« "æ¸¬è©¦"ã€"test" ç­‰é—œéµå­—)
- æ­£å¼è³‡æ–™: ~250-260 ç­† cases
- Opportunities: ~50-100 ç­† (æŒ‰ customerId å»é‡)
- Conversations: ~250-260 ç­†
- MEDDIC Analyses: 0 ç­† (ç”± V3 é‡æ–°åˆ†æ)

---

## âœ… æª¢æŸ¥æ¸…å–®

é·ç§»å‰ç¢ºèª:
- [ ] å·²ä¿®æ”¹ mapper ä½¿ç”¨ `customerId` è€Œé `customerName` hash
- [ ] å·²åŠ å…¥æ¸¬è©¦è³‡æ–™éæ¿¾é‚è¼¯
- [ ] å·²ç§»é™¤ Phase 4 MEDDIC åˆ†æå»ºç«‹
- [ ] ç¢ºèª salesRepName æ˜ å°„åˆ° slackUsername
- [ ] äº†è§£ salesRepEmail é€é user_profiles æŸ¥è©¢

é·ç§»å¾Œç¢ºèª:
- [ ] æ¸¬è©¦è³‡æ–™å·²è¢«éæ¿¾
- [ ] Opportunities.customerNumber = V2 customerId
- [ ] Conversations.transcript å®Œæ•´ä¿ç•™
- [ ] ç„¡ meddic_analyses è³‡æ–™ (å¾… V3 é‡æ–°åˆ†æ)
- [ ] audioUrl ç‚º null (å¾…ç¬¬äºŒéšæ®µ)

---

**æœ€å¾Œæ›´æ–°:** 2026-01-21
