# 🚨 Slack Bot 無回應 - 緊急檢查清單

## ✅ 請依序檢查以下項目

### 第 1 步: 確認 Bot 已加入頻道
在測試頻道中執行:
```
/invite @你的bot名稱
```

**預期結果**: 看到訊息「xxx has joined the channel」

- [ ] ✅ Bot 已加入頻道

---

### 第 2 步: 檢查 Event Subscriptions URL

前往: https://api.slack.com/apps → 選擇你的 App → Event Subscriptions

**檢查項目**:
1. Enable Events 開關: [ ] ✅ 已開啟
2. Request URL: `https://sales-ai-slack-bot.salesaiautomationv3.workers.dev/slack/events`
3. URL 驗證狀態: [ ] ✅ 顯示綠色勾勾 "Verified"

**如果 URL 驗證失敗**:
- 錯誤訊息: _______________
- 需要重新驗證

---

### 第 3 步: 檢查 Subscribe to bot events

在同一頁面,找到 "Subscribe to bot events" 區塊

**必須包含的事件** (請打勾):
- [ ] `file_shared` - 檔案分享
- [ ] `message.channels` - 頻道訊息
- [ ] `message.groups` - 私人頻道訊息
- [ ] `message.im` - 私訊
- [ ] `app_mention` - @提及 (選用)

**如果缺少任何事件**:
1. 點選 "Add Bot User Event"
2. 搜尋並新增缺少的事件
3. 點選頁面底部 "Save Changes"
4. **重要**: Slack 會提示你重新安裝 App,請點選 "reinstall your app"

---

### 第 4 步: 檢查 OAuth Scopes

前往: OAuth & Permissions → Scopes → Bot Token Scopes

**必須包含的權限** (請打勾):
- [ ] `files:read` - 讀取檔案內容
- [ ] `chat:write` - 發送訊息
- [ ] `channels:history` - 讀取公開頻道歷史
- [ ] `channels:read` - 查看公開頻道資訊
- [ ] `groups:history` - 讀取私人頻道歷史
- [ ] `im:history` - 讀取私訊歷史
- [ ] `im:write` - 發送私訊
- [ ] `users:read` - 讀取使用者資訊

**如果缺少任何權限**:
1. 點選 "Add an OAuth Scope"
2. 搜尋並新增缺少的權限
3. 向上滾動到頁面頂部
4. **重要**: 點選黃色橫幅中的 "reinstall your app" 按鈕

---

### 第 5 步: 檢查 Bot Token

在 OAuth & Permissions 頁面

**Bot User OAuth Token**:
- 應該以 `xoxb-` 開頭
- [ ] Token 已複製並設定到 Cloudflare Workers

**驗證 Token 是否正確**:
```bash
# 在你的終端執行以下指令來驗證 (將 YOUR_SLACK_BOT_TOKEN 替換為實際 token)
curl -X POST https://slack.com/api/auth.test \
  -H "Authorization: Bearer YOUR_SLACK_BOT_TOKEN"
```

預期回應應包含 `"ok": true`

---

### 第 6 步: 查看 Cloudflare Workers 實時日誌

這是最關鍵的一步,可以看到 Bot 是否收到任何請求。

**步驟**:
1. 開啟新分頁前往: https://dash.cloudflare.com/
2. 點選: Workers & Pages
3. 找到並點選: sales-ai-slack-bot
4. 點選左側: Logs
5. 點選藍色按鈕: **"Begin log stream"**
6. 保持這個分頁開啟

**然後**:
7. 回到 Slack
8. 在測試頻道上傳一個音檔
9. 立即切回 Cloudflare 日誌分頁
10. 觀察是否有任何日誌輸出

**可能的日誌情況**:

**情況 A: 完全沒有日誌** ❌
- 代表 Slack 沒有發送請求到你的 Worker
- 問題出在 Slack 配置
- **解決**: 檢查上面 1-5 步是否都正確

**情況 B: 看到請求但顯示錯誤** ⚠️
- 日誌內容: _______________
- 請將日誌貼給我

**情況 C: 看到 "Unhandled event type: xxx"** ⚠️
- 收到了事件,但類型不對
- 事件類型: _______________
- 可能需要訂閱額外的事件

**情況 D: 看到正常的處理流程** ✅
- 應該會看到 "Processing file_shared event" 之類的訊息
- 如果看到但 Slack 沒回應,問題在後續處理

---

### 第 7 步: 測試簡單的事件

為了確認 Bot 是否能收到任何事件,試試這個:

在測試頻道中輸入:
```
@你的bot名稱 hello
```

**預期結果**: Bot 應該回覆說明訊息

- [ ] ✅ Bot 有回應 @mention
- [ ] ❌ Bot 沒有回應 @mention

如果 @mention 也沒回應,代表 Bot 完全收不到任何事件。

---

## 📊 檢查結果總結

請將你的檢查結果填寫在這裡:

**第 1 步 - Bot 在頻道**: [ ] 是 [ ] 否
**第 2 步 - Event URL Verified**: [ ] 是 [ ] 否
**第 3 步 - file_shared 已訂閱**: [ ] 是 [ ] 否
**第 4 步 - files:read 權限**: [ ] 是 [ ] 否
**第 5 步 - Bot Token 正確**: [ ] 是 [ ] 否
**第 6 步 - Cloudflare 日誌**: [ ] 有日誌 [ ] 無日誌
**第 7 步 - @mention 測試**: [ ] 有回應 [ ] 無回應

**Cloudflare 日誌內容** (如有):
```
[請貼上日誌]
```

---

## 🎯 快速診斷

根據你的檢查結果,我可以快速判斷問題:

| 症狀 | 可能原因 | 解決方案 |
|------|---------|---------|
| @mention 沒回應 + 無日誌 | Event URL 沒有正確設定或驗證 | 重新設定 Event Subscriptions URL |
| @mention 有回應 + 音檔無回應 + 無日誌 | file_shared 事件沒訂閱 | 新增 file_shared 事件並重新安裝 app |
| 有日誌但顯示錯誤 | 權限不足或程式錯誤 | 根據錯誤訊息修復 |
| @mention 沒回應但有日誌 | 程式邏輯問題 | 需要查看日誌詳情 |

---

## ⚡ 最快速的驗證方式

如果你想最快確認問題,請:

1. **開啟 Cloudflare 日誌** (第 6 步)
2. **在 Slack @mention Bot** (第 7 步)
3. **查看日誌是否有輸出**

這能在 30 秒內告訴我們 Bot 是否能收到任何事件。

---

**檢查時間**: _______________
**結果**: _______________
