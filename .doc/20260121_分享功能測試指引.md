# 分享功能測試指引

**日期**: 2026-01-21
**修復版本**: Server Worker `f263fa93-d7a5-43a3-acbe-12e863857db2`

---

## 已完成的修復

### 1. ✅ Agent 4 Summary 儲存
- Queue Worker 已部署
- 7 筆歷史資料已回填
- 所有 completed 對話都有 summary

### 2. ✅ Share API 500 錯誤修復
- 移除錯誤的 Drizzle 關聯查詢
- 修正欄位名稱
- Server Worker 已部署 (Version: f263fa93-d7a5-43a3-acbe-12e863857db2)

### 3. ✅ 前端錯誤處理改善
- 加入詳細的 Console 日誌
- 顯示具體錯誤訊息

---

## 測試步驟

### 方法 1: 直接測試分享連結 (推薦)

直接訪問以下連結：

```
https://sales-ai-web.pages.dev/share/LjPovLnnYBG53qPZ-mknguyo9-ncwe9fqicwa
```

**預期結果**:
- ✅ 頁面正常載入
- ✅ 顯示 MEDDIC 評分卡 (分數: 50)
- ✅ 顯示會議摘要 (1094 字)
- ✅ 顯示公司資訊
- ✅ 顯示對話日期

**如果失敗**:
1. 按 F12 打開開發者工具
2. 切換到 Console 面板
3. 重新整理頁面
4. 查看錯誤訊息並截圖

---

### 方法 2: 測試「預覽公開分享頁面」按鈕

1. **清除瀏覽器快取**
   ```
   macOS: Cmd + Shift + R
   Windows: Ctrl + Shift + R
   ```

2. **前往對話頁面**
   ```
   https://sales-ai-web.pages.dev/conversations/cf75684f-4f5b-4667-8e09-0cd50262d9bc
   ```

3. **打開開發者工具**
   - 按 F12
   - 切換到 Console 面板

4. **點擊「預覽公開分享頁面」按鈕**

5. **觀察 Console 輸出**

**預期的 Console 日誌**:
```
[Share] Creating share token for conversation: cf75684f-4f5b-4667-8e09-0cd50262d9bc
[Share] Token created: LjPovLnnYBG53qPZ-mknguyo9-ncwe9fqicwa
[Share] Opening share URL: https://sales-ai-web.pages.dev/share/LjPovLnnYBG53qPZ-mknguyo9-ncwe9fqicwa
```

**預期結果**:
- ✅ 新視窗開啟
- ✅ 顯示分享頁面（內容同方法 1）

**如果仍然失敗**:
- 查看 Console 的錯誤訊息
- 截圖錯誤訊息
- 查看 Network 面板的 API 請求狀態

---

## 瀏覽器 Console 測試

如果分享頁面仍顯示錯誤，請在分享頁面按 F12，切換到 Console，執行以下代碼：

```javascript
// 測試 ORPC 端點
const token = 'LjPovLnnYBG53qPZ-mknguyo9-ncwe9fqicwa';

const response = await fetch('https://sales-ai-server.salesaiautomationv3.workers.dev/rpc/share.getByToken', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ token }),
  credentials: 'include'
});

console.log('HTTP Status:', response.status);

if (response.ok) {
  const data = await response.json();
  console.log('✅ API 成功回應:');
  console.log('案件:', data.caseNumber);
  console.log('Summary 長度:', data.summary?.length || 0);
} else {
  const error = await response.text();
  console.log('❌ API 錯誤:', error);
}
```

**預期輸出**:
```
HTTP Status: 200
✅ API 成功回應:
案件: 202601-IC019
Summary 長度: 1094
```

---

## 部署狀態確認

### Server Worker 部署資訊

- **URL**: https://sales-ai-server.salesaiautomationv3.workers.dev
- **Version ID**: f263fa93-d7a5-43a3-acbe-12e863857db2
- **部署時間**: 2026-01-21
- **修復內容**: Share API 關聯查詢錯誤

### Queue Worker 部署資訊

- **URL**: https://sales-ai-queue-worker.salesaiautomationv3.workers.dev
- **Version ID**: 30950715-3f4d-4980-99ad-4ca167a235d1
- **部署時間**: 2026-01-21
- **修復內容**: Agent 4 Summary 儲存

---

## 已知問題

### IC020~IC023 不存在

這些對話根本不存在於資料庫中。

**解決方案**:
1. 硬重新整理 (Cmd+Shift+R)
2. 清除瀏覽器快取
3. 重新登入

**最新對話編號**: 202601-IC019

---

## 可用的測試資料

### 對話列表 (所有都有 summary)

| 案件編號 | URL |
|---------|-----|
| 202601-IC019 | https://sales-ai-web.pages.dev/conversations/cf75684f-4f5b-4667-8e09-0cd50262d9bc |
| 202601-IC018 | https://sales-ai-web.pages.dev/conversations/ee277ef6-ee6f-4a71-b811-4f51538ae045 |
| 202601-IC017 | https://sales-ai-web.pages.dev/conversations/ff1dfda8-7731-439a-b6f7-5b6265bb2bde |
| 202601-IC016 | https://sales-ai-web.pages.dev/conversations/bda22553-e408-4ca7-a845-c3e288f0935d |
| 202601-IC015 | https://sales-ai-web.pages.dev/conversations/00b95b0e-816d-416e-aacd-ceddb9886d07 |
| 202601-IC014 | https://sales-ai-web.pages.dev/conversations/a3467a37-98f0-4da4-b755-16bba24b6fc1 |
| 202601-IC013 | https://sales-ai-web.pages.dev/conversations/214536e3-2eab-4de0-9aaf-a29acea78028 |

### 分享連結

| 案件編號 | 分享連結 |
|---------|---------|
| 202601-IC019 | https://sales-ai-web.pages.dev/share/LjPovLnnYBG53qPZ-mknguyo9-ncwe9fqicwa |

---

## 故障排除

### 問題: 仍然顯示 500 錯誤

**可能原因**:
1. Cloudflare Workers CDN 尚未完全更新（通常需要 1-5 分鐘）
2. 瀏覽器快取了舊的回應

**解決方案**:
1. 等待 2-3 分鐘
2. 硬重新整理 (Cmd+Shift+R)
3. 清除瀏覽器快取
4. 使用無痕模式測試

### 問題: 顯示「連結無效或已過期」

**可能原因**:
1. Token 已過期（14 天）
2. Token 被撤銷

**解決方案**:
1. 檢查 token 過期時間（2026-02-03）
2. 重新點擊「預覽公開分享頁面」生成新 token

### 問題: 404 Not Found

**可能原因**:
1. ORPC 路由格式問題
2. Server Worker 部署失敗

**解決方案**:
1. 檢查 Server Worker 部署狀態
2. 查看瀏覽器 Console 的 API 請求 URL
3. 確認 URL 格式: `/rpc/share.getByToken`

---

## 相關文件

- [Agent 4 Summary 儲存缺陷修復報告](.doc/20260121_Agent4_Summary儲存缺陷修復報告.md)
- [Share API 500 錯誤修復報告](.doc/20260121_Share_API_500錯誤修復報告.md)
- [分享功能問題診斷報告](.doc/20260121_分享功能問題診斷報告.md)

---

## 總結

**所有修復已完成並部署** ✅

- Agent 4 Summary 儲存 ✅
- Share API 500 錯誤 ✅
- 前端錯誤處理改善 ✅

**下一步**: 請按照上述測試步驟驗證功能是否正常。

如果遇到問題，請：
1. 截圖錯誤訊息
2. 複製 Console 日誌
3. 提供給開發團隊
