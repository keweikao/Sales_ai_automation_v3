# Routine Ops Agent éƒ¨ç½²æŒ‡å—

## ğŸ“‹ å·²å®ŒæˆåŠŸèƒ½

### âœ… æ ¸å¿ƒæ¶æ§‹
- **Ops Orchestrator**: å¥åº·æª¢æŸ¥èˆ‡ä¿®å¾©çš„èª¿åº¦å™¨ï¼ˆå·²æ•´åˆ MCP Serverï¼‰
- **MCP Server æ•´åˆ**: ä½¿ç”¨çœŸå¯¦å·¥å…·åŸ·è¡Œï¼Œæ”¯æ´ä¸¦è¡Œæª¢æŸ¥èˆ‡è‡ªå‹•ä¿®å¾©
- **Scheduled Event Handlers**: Server å’Œ Slack Bot çš„å®šæ™‚ä»»å‹™è™•ç†å™¨
- **Cron Triggers**: å®šæœŸåŸ·è¡Œé…ç½®ï¼ˆServer: æ¯ 15 åˆ†é˜ï¼ŒSlack Bot: æ¯ 5 åˆ†é˜ï¼‰
- **Slack è­¦ç¤ºé€šçŸ¥**: è‡ªå‹•ç™¼é€ critical å•é¡Œåˆ°æŒ‡å®šé »é“ï¼ˆC0A7C2HUXRRï¼‰
- **æœ¬åœ°æ¸¬è©¦è…³æœ¬**: å¯åœ¨éƒ¨ç½²å‰é©—è­‰åŠŸèƒ½

### âœ… å·²å¯¦ä½œçš„å·¥å…·
**Database æª¢æ¸¬å·¥å…·** (3 å€‹):
- `database_connection_check` - æª¢æŸ¥è³‡æ–™åº«é€£ç·šèˆ‡å»¶é²
- `database_orphaned_check` - æª¢æŸ¥å­¤ç«‹è¨˜éŒ„
- `database_index_check` - æª¢æŸ¥ç´¢å¼•å¥åº·

**Database ä¿®å¾©å·¥å…·** (3 å€‹):
- `database_reconnect_repair` - é‡æ–°å»ºç«‹é€£ç·š
- `database_cleanup_repair` - æ¸…ç†å­¤ç«‹è¨˜éŒ„ï¼ˆæ”¯æ´ dry-runï¼‰
- `database_reindex_repair` - é‡å»ºç´¢å¼•

### âœ… å·¥å…·è¨»å†Šèˆ‡åŸ·è¡Œ
- Database Ops Tools å·²åœ¨ Orchestrator åˆå§‹åŒ–æ™‚è‡ªå‹•è¨»å†Š
- ä½¿ç”¨ MCP Server åŸ·è¡Œæ‰€æœ‰æª¢æŸ¥èˆ‡ä¿®å¾©å·¥å…·
- æ”¯æ´å·¥å…·è‡ªå‹•ç™¼ç¾ï¼ˆæœªå¯¦ä½œçš„å·¥å…·æœƒå„ªé›…åœ°è·³éï¼‰
- å®Œæ•´çš„éŒ¯èª¤è™•ç†èˆ‡è¶…æ™‚æ©Ÿåˆ¶

---

## ğŸš€ éƒ¨ç½²æ­¥é©Ÿ

### 1. è¨­å®š SLACK_BOT_TOKEN

```bash
# åœ¨ server è¨­å®š Slack Bot Tokenï¼ˆç”¨æ–¼ç™¼é€ Ops è­¦ç¤ºï¼‰
cd apps/server
wrangler secret put SLACK_BOT_TOKEN --env production
# è¼¸å…¥ä½ çš„ Slack Bot Token
```

### 2. éƒ¨ç½² Server

```bash
cd apps/server
bun run deploy
```

### 3. éƒ¨ç½² Slack Bot

```bash
cd apps/slack-bot
bun run deploy
```

### 4. æœ¬åœ°æ¸¬è©¦ï¼ˆéƒ¨ç½²å‰ï¼‰

åœ¨éƒ¨ç½²å‰ï¼Œå»ºè­°å…ˆåœ¨æœ¬åœ°æ¸¬è©¦ Ops Orchestratorï¼š

```bash
# æ¸¬è©¦ Ops Orchestrator çš„å¥åº·æª¢æŸ¥èˆ‡ä¿®å¾©åŠŸèƒ½
bun run packages/services/scripts/test-ops-orchestrator.ts
```

é€™å€‹æ¸¬è©¦è…³æœ¬æœƒï¼š
- åˆå§‹åŒ– Ops Orchestrator
- åŸ·è¡Œæ‰€æœ‰å·²è¨»å†Šçš„å¥åº·æª¢æŸ¥ï¼ˆç›®å‰ï¼šDatabase 3 é …ï¼‰
- è‡ªå‹•è§¸ç™¼éœ€è¦çš„ä¿®å¾©
- ç”¢ç”Ÿè©³ç´°çš„åŸ·è¡Œå ±å‘Š

### 5. é©—è­‰éƒ¨ç½²

éƒ¨ç½²å®Œæˆå¾Œï¼Œæª¢æŸ¥ä»¥ä¸‹é …ç›®ï¼š

1. **æŸ¥çœ‹ Cloudflare Workers æ—¥èªŒ**
   - å‰å¾€ Cloudflare Dashboard
   - é¸æ“‡ `sales-ai-server` worker
   - æŸ¥çœ‹ Logs ç¢ºèª cron æ˜¯å¦æ¯ 15 åˆ†é˜åŸ·è¡Œ

2. **æª¢æŸ¥ Slack é€šçŸ¥é »é“**
   - é »é“ ID: `C0A7C2HUXRR`
   - é »é“ URL: https://ichef.slack.com/archives/C0A7C2HUXRR
   - å¦‚æœæœ‰ critical å•é¡Œï¼Œæœƒæ”¶åˆ°æ ¼å¼åŒ–çš„è­¦ç¤ºè¨Šæ¯

3. **æ‰‹å‹•è§¸ç™¼æ¸¬è©¦**ï¼ˆCloudflare Workers ç’°å¢ƒï¼‰
   ```bash
   cd apps/server
   bun wrangler dev --test-scheduled
   ```

---

## ğŸ“Š Slack è­¦ç¤ºè¨Šæ¯æ ¼å¼

ç•¶åµæ¸¬åˆ° critical å•é¡Œæ™‚ï¼Œæœƒç™¼é€ä»¥ä¸‹æ ¼å¼çš„è¨Šæ¯åˆ° Slackï¼š

```
ğŸš¨ ç³»çµ±å¥åº·æª¢æŸ¥è­¦ç¤º

åŸ·è¡Œæ™‚é–“: 2026-01-13 15:30:00
ç¸½åŸ·è¡Œæ™‚é–“: 5234ms
å¥åº·æª¢æŸ¥: âœ… 18 / âš ï¸ 2 / ğŸš¨ 1
è‡ªå‹•ä¿®å¾©: âœ… 1 / âŒ 0

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

åµæ¸¬åˆ° 1 å€‹åš´é‡å•é¡Œ:

âœ… å·²è‡ªå‹•ä¿®å¾©
æª¢æŸ¥é …ç›®: database_connection_check
è©³ç´°è³‡è¨Š: Database connection failed: timeout
æ™‚é–“: 2026-01-13 15:29:55

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ¤– ç”± Routine Ops Agent è‡ªå‹•ç”¢ç”Ÿ
```

---

## ğŸ”§ Cron Triggers é…ç½®

### Server (`apps/server/wrangler.toml`)
```toml
[triggers]
crons = [
  "*/15 * * * *",  # æ¯ 15 åˆ†é˜åŸ·è¡Œå¥åº·æª¢æŸ¥èˆ‡è‡ªå‹•ä¿®å¾©
]
```

### Slack Bot (`apps/slack-bot/wrangler.toml`)
```toml
[triggers]
crons = [
  "*/5 * * * *",   # æ¯ 5 åˆ†é˜æª¢æŸ¥ Slack ç›¸é—œè­¦ç¤º
]
```

---

## ğŸ“ å¾ŒçºŒé–‹ç™¼å·¥ä½œ

### å¾…å¯¦ä½œçš„å·¥å…·ï¼ˆå¯é€æ­¥è£œå……ï¼‰

æ ¹æ“šè¨ˆç•«ï¼Œé‚„éœ€è¦å¯¦ä½œä»¥ä¸‹å·¥å…·ï¼š

1. **Transcription å·¥å…·** (3 check + 3 repair)
   - `transcription_api_check`
   - `transcription_stuck_tasks_check`
   - `transcription_expired_tasks_check`
   - `transcription_api_repair`
   - `transcription_retry_repair`
   - `transcription_cancel_repair`

2. **Slack å·¥å…·** (5 check + 5 repair)
   - `slack_connection_check`
   - `slack_file_download_check`
   - `slack_event_listener_check`
   - `slack_message_send_check`
   - `slack_channel_permission_check`
   - å°æ‡‰çš„ 5 å€‹ repair tools

3. **Storage å·¥å…·** (3 check + 3 repair)
4. **Analysis å·¥å…·** (3 check + 3 repair)
5. **SMS å·¥å…·** (3 check + 3 repair)

### å¯¦ä½œæ–¹å¼

åƒè€ƒ Database å·¥å…·çš„å¯¦ä½œæ¨¡å¼ï¼š

```typescript
// packages/services/src/mcp/tools/ops/[category]/[tool-name].tool.ts

import { z } from "zod";
import type { MCPTool } from "../../../types.js";

const YourToolInput = z.object({
  // å®šç¾©è¼¸å…¥åƒæ•¸
});

const YourToolOutput = z.object({
  status: z.enum(["healthy", "degraded", "critical"]),
  // å…¶ä»–è¼¸å‡ºæ¬„ä½
});

export const yourTool: MCPTool<Input, Output> = {
  name: "your_tool_name",
  description: "å·¥å…·æè¿°",
  inputSchema: YourToolInput,
  handler: async (input: Input): Promise<Output> => {
    // å¯¦ä½œé‚è¼¯
  },
};
```

### âœ… å·²å®Œæˆçš„æ•´åˆå·¥ä½œ

1. **è¨»å†Šå·¥å…·åˆ° MCP Server** âœ…
   - Database Ops Tools å·²åœ¨ Orchestrator åˆå§‹åŒ–æ™‚è¨»å†Š
   - ä½¿ç”¨ `MCPServer.registerTools()` æ‰¹æ¬¡è¨»å†Š

2. **æ•´åˆ MCP Server** âœ…
   - Orchestrator ä½¿ç”¨ `MCPServer.executeTool()` åŸ·è¡Œæª¢æŸ¥å’Œä¿®å¾©å·¥å…·
   - ä¸å†ä½¿ç”¨æ¨¡æ“¬çµæœï¼Œå·²æ”¹ç‚ºçœŸå¯¦å·¥å…·åŸ·è¡Œ
   - åŒ…å«å®Œæ•´éŒ¯èª¤è™•ç†å’Œè¶…æ™‚æ©Ÿåˆ¶

3. **å·¥å…·è‡ªå‹•ç™¼ç¾** âœ…
   - å·¥å…·æœªè¨»å†Šæ™‚æœƒè‡ªå‹•è·³éä¸¦å›å ± "Tool not yet implemented"
   - æ”¯æ´å‹•æ…‹è¨»å†Šæ–°å·¥å…·

### å¾…å®Œæˆçš„æ•´åˆå·¥ä½œ

1. **è³‡æ–™åº«è¨˜éŒ„**ï¼ˆæœªä¾†åŠŸèƒ½ï¼‰
   - å»ºç«‹ `ops_check_logs` è³‡æ–™è¡¨
   - è¨˜éŒ„æ¯æ¬¡åŸ·è¡Œçµæœ

2. **æ¯æ—¥å ±å‘Š**ï¼ˆæœªä¾†åŠŸèƒ½ï¼‰
   - å¯¦ä½œæ¯æ—¥æ‘˜è¦åŠŸèƒ½
   - é€±ä¸€åˆ°é€±äº”æ—©ä¸Š 9:00 ç™¼é€åˆ° Slack

---

## ğŸ› æ•…éšœæ’é™¤

### Cron æ²’æœ‰åŸ·è¡Œ
1. æª¢æŸ¥ Cloudflare Dashboard çš„ Triggers æ˜¯å¦å•Ÿç”¨
2. æŸ¥çœ‹ Worker æ—¥èªŒæ˜¯å¦æœ‰éŒ¯èª¤è¨Šæ¯

### Slack é€šçŸ¥æ²’æœ‰æ”¶åˆ°
1. ç¢ºèª `SLACK_BOT_TOKEN` å·²æ­£ç¢ºè¨­å®š
2. ç¢ºèª Bot æœ‰æ¬Šé™ç™¼é€è¨Šæ¯åˆ°é »é“ `C0A7C2HUXRR`
3. æª¢æŸ¥æ˜¯å¦çœŸçš„æœ‰ critical å•é¡Œï¼ˆåªæœ‰ critical æ‰æœƒç™¼é€é€šçŸ¥ï¼‰

### å·¥å…·åŸ·è¡Œå¤±æ•—
1. æŸ¥çœ‹ Worker æ—¥èªŒçš„è©³ç´°éŒ¯èª¤è¨Šæ¯
2. ç¢ºèªè³‡æ–™åº«é€£ç·šæ­£å¸¸
3. ç¢ºèªæ‰€æœ‰å¿…è¦çš„ç’°å¢ƒè®Šæ•¸éƒ½å·²è¨­å®š

---

## ğŸ“š ç›¸é—œæª”æ¡ˆ

### æ ¸å¿ƒæª”æ¡ˆ
- [packages/services/src/ops/types.ts](packages/services/src/ops/types.ts) - é¡å‹å®šç¾©
- [packages/services/src/ops/orchestrator.ts](packages/services/src/ops/orchestrator.ts) - èª¿åº¦å™¨
- [packages/services/src/ops/notification.ts](packages/services/src/ops/notification.ts) - é€šçŸ¥æœå‹™

### Scheduled Handlers
- [apps/server/src/index.ts](apps/server/src/index.ts#L139-L184) - Server handler
- [apps/slack-bot/src/index.ts](apps/slack-bot/src/index.ts#L508-L524) - Slack Bot handler

### é…ç½®æª”æ¡ˆ
- [apps/server/wrangler.toml](apps/server/wrangler.toml) - Server é…ç½®
- [apps/slack-bot/wrangler.toml](apps/slack-bot/wrangler.toml) - Slack Bot é…ç½®

### Database å·¥å…·ç¯„ä¾‹
- [packages/services/src/mcp/tools/ops/database/](packages/services/src/mcp/tools/ops/database/) - æ‰€æœ‰ Database å·¥å…·

---

## ğŸ¯ ç›£æ§ç¯„åœ

æ ¹æ“šè¨ˆç•«ï¼ŒRoutine Ops Agent å°‡ç›£æ§ä»¥ä¸‹æµç¨‹ï¼š

1. âœ… **è³‡æ–™åº«å®Œæ•´æ€§** (å·²å¯¦ä½œ)
2. **Slack éŸ³æª”ä¸Šå‚³æµç¨‹**
3. **è½‰éŒ„æœå‹™**
4. **å­˜æª” (Storage)**
5. **åˆ†ææœå‹™**
6. **Push åˆ° Slack**
7. **Summary ç°¡è¨Šå¯„ç™¼**

ç›®å‰ç³»çµ±å·²å»ºç«‹å®Œæ•´æ¶æ§‹ï¼Œå¯ä»¥é–‹å§‹é‹ä½œã€‚å‰©é¤˜çš„å·¥å…·å¯ä»¥æ ¹æ“šå¯¦éš›éœ€æ±‚é€æ­¥è£œå……ï¼
