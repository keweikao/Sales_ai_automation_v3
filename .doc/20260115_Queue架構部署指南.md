# Queue æ¶æ§‹éƒ¨ç½²æŒ‡å—

## âœ… å®Œæˆçš„é–‹ç™¼å·¥ä½œ

### 1. MEDDIC æ•´åˆå®Œæˆ
- âœ… Queue Worker æœƒåŒæ™‚æ›´æ–°å…©å€‹è¡¨:
  - `conversations` è¡¨: å­˜å„²æ‘˜è¦åœ¨ `meddicAnalysis` JSONB æ¬„ä½
  - `meddicAnalyses` è¡¨: å­˜å„²å®Œæ•´åˆ†æè³‡æ–™
- âœ… åŒ…å«æ‰€æœ‰ MEDDIC ç¶­åº¦åˆ†æ•¸ã€è­‰æ“šã€ç¼ºå£ã€å»ºè­°
- âœ… åŒ…å« keyFindingsã€nextStepsã€risksã€agentOutputs

### 2. å·²ä¿®æ”¹çš„æ–‡ä»¶
- âœ… `apps/server/wrangler.toml` - æ·»åŠ  Queue Producer
- âœ… `apps/queue-worker/wrangler.toml` - æ–°å»º Queue Consumer
- âœ… `apps/queue-worker/package.json` - æ–°å»º
- âœ… `apps/queue-worker/tsconfig.json` - æ–°å»º
- âœ… `apps/queue-worker/src/index.ts` - æ–°å»º (480+ è¡Œ,å®Œæ•´å¯¦ç¾)
- âœ… `packages/api/src/routers/conversation.ts` - ç§»é™¤åŒæ­¥è½‰éŒ„,æ”¹ç”¨ Queue
- âœ… `apps/slack-bot/src/events/file.ts` - ç«‹å³è¿”å›,ä¸ç­‰å¾…è½‰éŒ„

---

## ğŸ“‹ éƒ¨ç½²å‰æª¢æŸ¥æ¸…å–®

### æ­¥é©Ÿ 1: ç¢ºèª Cloudflare ç™»å…¥
```bash
# å¦‚æœå°šæœªç™»å…¥
npx wrangler login

# æª¢æŸ¥ç™»å…¥ç‹€æ…‹
npx wrangler whoami
```

### æ­¥é©Ÿ 2: å‰µå»º Cloudflare Queues
```bash
# å‰µå»ºä¸»è¦ Queue
npx wrangler queues create transcription-queue

# å‰µå»º Dead Letter Queue (æ”¶é›†å¤±æ•—è¨Šæ¯)
npx wrangler queues create transcription-dlq
```

### æ­¥é©Ÿ 3: è¨­ç½® Queue Worker ç’°å¢ƒè®Šæ•¸

**å¿…éœ€çš„ Secrets:**
```bash
cd apps/queue-worker

# è³‡æ–™åº«
npx wrangler secret put DATABASE_URL
# è¼¸å…¥: postgresql://...

# AI æœå‹™
npx wrangler secret put GROQ_API_KEY
# è¼¸å…¥: gsk_...

npx wrangler secret put GEMINI_API_KEY
# è¼¸å…¥: AIza...

# R2 Storage
npx wrangler secret put CLOUDFLARE_R2_ACCESS_KEY
# è¼¸å…¥: ...

npx wrangler secret put CLOUDFLARE_R2_SECRET_KEY
# è¼¸å…¥: ...

npx wrangler secret put CLOUDFLARE_R2_ENDPOINT
# è¼¸å…¥: https://...

npx wrangler secret put CLOUDFLARE_R2_BUCKET
# è¼¸å…¥: sales-ai-audio

# Slack
npx wrangler secret put SLACK_BOT_TOKEN
# è¼¸å…¥: xoxb-...
```

**æª¢æŸ¥å·²è¨­ç½®çš„ Secrets:**
```bash
npx wrangler secret list
```

---

## ğŸš€ éƒ¨ç½²æ­¥é©Ÿ

### 1. éƒ¨ç½² Queue Worker (ç¬¬ä¸€å€‹)
```bash
cd apps/queue-worker

# å®‰è£ä¾è³´ (å¦‚æœéœ€è¦)
npm install

# æª¢æŸ¥ TypeScript
npm run typecheck

# éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
npx wrangler deploy

# éƒ¨ç½²åˆ°é–‹ç™¼ç’°å¢ƒ (å¯é¸)
npx wrangler deploy --env dev
```

**é æœŸè¼¸å‡º:**
```
âœ¨ Built successfully, built project size is 234 KiB.
âœ¨ Successfully published your script to
   https://sales-ai-queue-worker.salesaiautomationv3.workers.dev
```

**é©—è­‰éƒ¨ç½²:**
```bash
# æŸ¥çœ‹æ—¥èªŒ
npx wrangler tail

# æª¢æŸ¥ Queue Consumer ç‹€æ…‹
npx wrangler queues consumer list transcription-queue
```

### 2. éƒ¨ç½² Server (ç¬¬äºŒå€‹)
```bash
cd apps/server

# æª¢æŸ¥ TypeScript
npm run typecheck

# éƒ¨ç½²
npx wrangler deploy

# æˆ–ä½¿ç”¨ dev ç’°å¢ƒ
npx wrangler deploy --env dev
```

**é æœŸè¼¸å‡º:**
```
âœ¨ Successfully published your script to
   https://sales-ai-server.salesaiautomationv3.workers.dev
```

### 3. éƒ¨ç½² Slack Bot (ç¬¬ä¸‰å€‹)
```bash
cd apps/slack-bot

# æª¢æŸ¥ TypeScript
npm run typecheck

# éƒ¨ç½²
npx wrangler deploy
```

**é æœŸè¼¸å‡º:**
```
âœ¨ Successfully published your script to
   https://sales-ai-slack-bot.salesaiautomationv3.workers.dev
```

---

## ğŸ§ª æ¸¬è©¦éƒ¨ç½²

### 1. å¿«é€Ÿå¥åº·æª¢æŸ¥
```bash
# æª¢æŸ¥ Queue ç‹€æ…‹
npx wrangler queues list

# é æœŸè¼¸å‡º:
# Queue Name: transcription-queue
# Consumers: 1
```

### 2. æ¸¬è©¦å°éŸ³æª” (< 10MB)
1. åœ¨ Slack ä¸Šå‚³ä¸€å€‹å°éŸ³æª” (ä¾‹å¦‚ 5MB)
2. è§€å¯Ÿå³æ™‚æ—¥èªŒ:
```bash
# Queue Worker æ—¥èªŒ
cd apps/queue-worker
npx wrangler tail

# Server æ—¥èªŒ
cd apps/server
npx wrangler tail
```

3. æª¢æŸ¥è³‡æ–™åº«è¨˜éŒ„:
```bash
# ä½¿ç”¨ç¾æœ‰çš„æ¸¬è©¦è…³æœ¬
DATABASE_URL="..." npx tsx check-db-conversations.ts
```

**é æœŸæµç¨‹:**
```
T+0s:   Slack ä¸Šå‚³éŸ³æª”
T+2s:   æ”¶åˆ° "å·²æ¥æ”¶éŸ³æª”" è¨Šæ¯
T+30s:  Queue Worker é–‹å§‹è™•ç†
T+2m:   è½‰éŒ„å®Œæˆ,é–‹å§‹ MEDDIC åˆ†æ
T+3m:   åˆ†æå®Œæˆ,æ”¶åˆ° Slack é€šçŸ¥
```

### 3. æ¸¬è©¦å¤§éŸ³æª” (96MB)
```bash
# ä¸Šå‚³å¤§éŸ³æª”
# è§€å¯Ÿ Queue Worker æ—¥èªŒ
cd apps/queue-worker
npx wrangler tail

# é æœŸä¸æœƒè¶…æ™‚,æœ€å¤š 10-15 åˆ†é˜å®Œæˆ
```

### 4. é©—è­‰ MEDDIC æ•´åˆ
```bash
# æª¢æŸ¥ meddicAnalyses è¡¨æ˜¯å¦æœ‰æ–°è¨˜éŒ„
DATABASE_URL="..." npx tsx -e "
import { drizzle } from 'drizzle-orm/neon-http';
import { neon } from '@neondatabase/serverless';
import { meddicAnalyses } from './packages/db/src/schema/index.js';

const sql = neon(process.env.DATABASE_URL);
const db = drizzle(sql);

const results = await db.select().from(meddicAnalyses).orderBy(desc(meddicAnalyses.createdAt)).limit(5);
console.log(JSON.stringify(results, null, 2));
"
```

**é æœŸè¼¸å‡º:** æ‡‰è©²çœ‹åˆ°å®Œæ•´çš„ MEDDIC åˆ†æè³‡æ–™,åŒ…æ‹¬:
- æ‰€æœ‰ 6 å€‹ç¶­åº¦åˆ†æ•¸
- dimensions ç‰©ä»¶
- keyFindings, nextSteps, risks é™£åˆ—

---

## ğŸ” ç›£æ§èˆ‡é™¤éŒ¯

### æŸ¥çœ‹å³æ™‚æ—¥èªŒ
```bash
# Queue Worker
cd apps/queue-worker
npx wrangler tail

# Server
cd apps/server
npx wrangler tail

# Slack Bot
cd apps/slack-bot
npx wrangler tail
```

### æª¢æŸ¥ Queue çµ±è¨ˆ
```bash
# æŸ¥çœ‹ Queue è¨Šæ¯æ•¸é‡
npx wrangler queues consumer list transcription-queue

# æŸ¥çœ‹ Dead Letter Queue
npx wrangler queues consumer list transcription-dlq
```

### å¸¸è¦‹å•é¡Œ

#### 1. Queue Worker æ²’æœ‰æ”¶åˆ°è¨Šæ¯
```bash
# æª¢æŸ¥ Queue Producer binding
cd apps/server
npx wrangler tail

# æœå°‹ "TRANSCRIPTION_QUEUE.send"
# æ‡‰è©²çœ‹åˆ°æ¨é€æ—¥èªŒ
```

#### 2. è½‰éŒ„å¤±æ•—
```bash
# æª¢æŸ¥ Groq API Key
cd apps/queue-worker
npx wrangler secret list

# æŸ¥çœ‹éŒ¯èª¤æ—¥èªŒ
npx wrangler tail
```

#### 3. è³‡æ–™åº«æ›´æ–°å¤±æ•—
```bash
# æª¢æŸ¥ DATABASE_URL
npx wrangler secret list

# æ¸¬è©¦è³‡æ–™åº«é€£æ¥
DATABASE_URL="..." npx tsx -e "
import { neon } from '@neondatabase/serverless';
const sql = neon(process.env.DATABASE_URL);
const result = await sql\`SELECT NOW()\`;
console.log('âœ… Database connection OK:', result);
"
```

---

## ğŸ“Š é æœŸæ”¹å–„æ•ˆæœ

| æŒ‡æ¨™ | éƒ¨ç½²å‰ | éƒ¨ç½²å¾Œ | æ”¹å–„ |
|------|--------|--------|------|
| å°æª”æ¡ˆ (5MB) | 2-3 åˆ†é˜ | < 2 åˆ†é˜ | 30%+ |
| å¤§æª”æ¡ˆ (96MB) | âŒ è¶…æ™‚ | âœ… 10-15 åˆ†é˜ | 100% |
| ç”¨æˆ¶ç­‰å¾…æ™‚é–“ | 5-10 åˆ†é˜ | < 3 ç§’ | 99%+ |
| NeonDbError | âŒ é »ç¹ | âœ… 0 æ¬¡ | 100% |
| å¤±æ•—è‡ªå‹•é‡è©¦ | âŒ ç„¡ | âœ… 3 æ¬¡ | 100% |

---

## ğŸ¯ ä¸‹ä¸€æ­¥ (å¯é¸)

### Week 1 Day 3: çµ±ä¸€éŒ¯èª¤è™•ç†
- å‰µå»º `packages/shared/src/errors/index.ts`
- å¯¦ç¾ `AppError` é¡åˆ¥
- æ›´æ–°æ‰€æœ‰ throw èªå¥

### Week 1 Day 4: å¢å¼· Slack é€šçŸ¥
- å‰µå»º `packages/services/src/notifications/slack.ts`
- å¯¦ç¾è±å¯Œçš„ Block Kit è¨Šæ¯
- æ·»åŠ æ“ä½œæŒ‰éˆ• (æŸ¥çœ‹è½‰éŒ„ã€æŸ¥çœ‹åˆ†æ)

### Week 1 Day 5: æ•´åˆæ¸¬è©¦
- å–®å…ƒæ¸¬è©¦
- æ•´åˆæ¸¬è©¦
- E2E æ¸¬è©¦

---

## ğŸ“ éƒ¨ç½²å®Œæˆæª¢æŸ¥

- [ ] Cloudflare Queues å‰µå»ºå®Œæˆ
- [ ] Queue Worker æ‰€æœ‰ Secrets è¨­ç½®å®Œæˆ
- [ ] Queue Worker éƒ¨ç½²æˆåŠŸ
- [ ] Server éƒ¨ç½²æˆåŠŸ
- [ ] Slack Bot éƒ¨ç½²æˆåŠŸ
- [ ] å°éŸ³æª”æ¸¬è©¦é€šé
- [ ] å¤§éŸ³æª”æ¸¬è©¦é€šé
- [ ] Slack é€šçŸ¥æ­£å¸¸ç™¼é€
- [ ] meddicAnalyses è¡¨æ­£ç¢ºæ’å…¥è³‡æ–™
- [ ] conversations è¡¨æ­£ç¢ºæ›´æ–°ç‹€æ…‹

---

## ğŸ†˜ ç·Šæ€¥å›æ»¾

å¦‚æœéƒ¨ç½²å¾Œå‡ºç¾å•é¡Œ,å¯ä»¥å¿«é€Ÿå›æ»¾:

```bash
# 1. åœç”¨ Queue Consumer (æš«åœè™•ç†)
cd apps/queue-worker
npx wrangler queues consumer remove transcription-queue sales-ai-queue-worker

# 2. éƒ¨ç½²èˆŠç‰ˆ Server (æ¢å¾©åŒæ­¥è™•ç†)
cd apps/server
git checkout HEAD~1 -- src/
npx wrangler deploy

# 3. éƒ¨ç½²èˆŠç‰ˆ Slack Bot
cd apps/slack-bot
git checkout HEAD~1 -- src/
npx wrangler deploy
```

---

**æº–å‚™å¥½é–‹å§‹éƒ¨ç½²äº†å—?** è«‹æŒ‰ç…§ä»¥ä¸‹é †åºåŸ·è¡Œ:
1. å‰µå»º Queues
2. è¨­ç½® Queue Worker Secrets
3. éƒ¨ç½² Queue Worker
4. éƒ¨ç½² Server
5. éƒ¨ç½² Slack Bot
6. æ¸¬è©¦é©—è­‰
