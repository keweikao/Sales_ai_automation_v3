# ç’°å¢ƒè®Šæ•¸è¨­å®šå®Œæˆå ±å‘Š

**è¨­å®šæ™‚é–“**: 2026-01-20
**ç‹€æ…‹**: âœ… å®Œæˆ

---

## âœ… å·²è¨­å®šçš„ç’°å¢ƒè®Šæ•¸

### Queue Worker

#### 1. ä¸€èˆ¬ç’°å¢ƒè®Šæ•¸ (é€é wrangler.toml)

```toml
[vars]
ENVIRONMENT = "production"
SERVER_URL = "https://sales-ai-server.salesaiautomationv3.workers.dev"
WEB_APP_URL = "https://5bcc2d03.sales-ai-web.pages.dev"
```

#### 2. Secret ç’°å¢ƒè®Šæ•¸ (é€é wrangler secret)

- âœ… `SERVICE_API_TOKEN` - å·²è¨­å®š (èˆ‡ Server å…±ç”¨ç›¸åŒ token)

### Server

#### Secret ç’°å¢ƒè®Šæ•¸

- âœ… `SERVICE_API_TOKEN` - å·²è¨­å®š (èˆ‡ Queue Worker å…±ç”¨ç›¸åŒ token)
- âœ… `API_TOKEN` - å·²å­˜åœ¨
- âœ… `EVERY8D_USERNAME` - å·²å­˜åœ¨
- âœ… `EVERY8D_PASSWORD` - å·²å­˜åœ¨
- âœ… `SHARE_TOKEN_SECRET` - å·²å­˜åœ¨

---

## ğŸ” Service API Token

å·²ç”Ÿæˆä¸¦è¨­å®šæ–°çš„ Service API Token:

```
Token: CNTLz8i+mmWkDVJvJ3KNDjbojeZODdaOUo/FqtsgZhM=
```

**é‡è¦**: é€™å€‹ token å·²åŒæ™‚è¨­å®šåˆ°:
- Server Worker (`sales-ai-server`)
- Queue Worker (`sales-ai-queue-worker`)

é€™æ¨£ Queue Worker å°±å¯ä»¥ä½¿ç”¨ Bearer Token èªè­‰ä¾†èª¿ç”¨ Server API çš„ `share.create` ç«¯é»ã€‚

---

## ğŸ¯ èªè­‰æµç¨‹

```
Queue Worker
    â†“
    èª¿ç”¨ POST /rpc/share.create
    Headers: Authorization: Bearer CNTLz8i+mmWkDVJvJ3KNDjbojeZODdaOUo/FqtsgZhM=
    â†“
Server API (context.ts)
    â†“
    æª¢æŸ¥ Bearer Token æ˜¯å¦ç­‰æ–¼ SERVICE_API_TOKEN
    â†“
    âœ… èªè­‰æˆåŠŸ,è¿”å› Service Account Session
    â†“
    åŸ·è¡Œ protectedProcedure (share.create)
    â†“
    è¿”å› share token çµ¦ Queue Worker
```

---

## ğŸ“‹ éƒ¨ç½²ç‹€æ…‹

### Queue Worker - æœ€æ–°ç‰ˆæœ¬

- **Version ID**: e907cc08-abc9-4e41-89c8-e27f3b1b5e33
- **URL**: https://sales-ai-queue-worker.salesaiautomationv3.workers.dev
- **ç’°å¢ƒè®Šæ•¸**:
  - âœ… ENVIRONMENT = "production"
  - âœ… SERVER_URL = "https://sales-ai-server.salesaiautoma..."
  - âœ… WEB_APP_URL = "https://5bcc2d03.sales-ai-web.pages.dev"
  - âœ… SERVICE_API_TOKEN = "***" (Secret)
  - âœ… CACHE_KV (KV Namespace)

---

## ğŸ§ª æ¸¬è©¦æ¸…å–®

ç¾åœ¨æ‰€æœ‰ç’°å¢ƒè®Šæ•¸éƒ½å·²è¨­å®šå®Œæˆ,å¯ä»¥é€²è¡Œç«¯åˆ°ç«¯æ¸¬è©¦:

### æ¸¬è©¦æ­¥é©Ÿ

1. **ä¸Šå‚³éŸ³æª”åˆ° Slack**
   - [ ] ä¸Šå‚³æ¸¬è©¦éŸ³æª”
   - [ ] å¡«å¯«å®¢æˆ¶è³‡è¨Šè¡¨å–®
   - [ ] **é‡è¦**: å¡«å¯«å®¢æˆ¶é›»è©± (09xxxxxxxx)
   - [ ] æäº¤è¡¨å–®

2. **ç›£æ§è™•ç†æµç¨‹**
   ```bash
   cd apps/queue-worker
   wrangler tail
   ```

   é æœŸçœ‹åˆ°çš„æ—¥èªŒ:
   ```
   [Queue] ğŸ¬ Processing conversation xxx
   [Queue] ğŸ”— Generating share token...
   [Queue] âœ“ Share token generated: xxx
   [Queue] âœ“ Sent completion notification to Uxxxx
   ```

3. **é©—è­‰ Slack é€šçŸ¥**
   - [ ] æ”¶åˆ°å®Œæˆé€šçŸ¥
   - [ ] é€šçŸ¥ä¸­æœ‰ã€ŒğŸ“± ç™¼é€ SMS çµ¦å®¢æˆ¶ã€æŒ‰éˆ•
   - [ ] æŒ‰éˆ•ç‚ºè—è‰² (primary style)

4. **æ¸¬è©¦ SMS ç™¼é€**
   - [ ] é»æ“Šã€Œç™¼é€ SMSã€æŒ‰éˆ•
   - [ ] é¡¯ç¤ºã€Œæ­£åœ¨ç™¼é€ç°¡è¨Šè‡³ 09xxxxxxxx...ã€
   - [ ] é¡¯ç¤ºã€Œâœ… ç°¡è¨Šå·²æˆåŠŸç™¼é€è‡³ 09xxxxxxxxã€

5. **é©—è­‰å®¢æˆ¶ç«¯**
   - [ ] æª¢æŸ¥æ‰‹æ©Ÿæ”¶åˆ°ç°¡è¨Š
   - [ ] ç°¡è¨ŠåŒ…å«åˆ†äº«é€£çµ
   - [ ] é»æ“Šé€£çµå¯é–‹å•Ÿå ±å‘Šé é¢
   - [ ] ä¸éœ€è¦ç™»å…¥å³å¯æŸ¥çœ‹

---

## ğŸ” é™¤éŒ¯æŒ‡ä»¤

### æŸ¥çœ‹ Queue Worker ç’°å¢ƒè®Šæ•¸

```bash
cd apps/queue-worker
wrangler deployments view
```

### æŸ¥çœ‹ Queue Worker æ—¥èªŒ

```bash
cd apps/queue-worker
wrangler tail --format pretty
```

### æ¸¬è©¦ Share Token ç”Ÿæˆ

å¯ä»¥é€éæ—¥èªŒæŸ¥çœ‹æ˜¯å¦æˆåŠŸ:

```bash
wrangler tail | grep -E "(share|token|401|403)"
```

é æœŸè¼¸å‡º:
```
[Queue] ğŸ”— Generating share token...
[Queue] âœ“ Share token generated: abc123...
```

å¦‚æœçœ‹åˆ° 401 æˆ– 403 éŒ¯èª¤,è¡¨ç¤ºèªè­‰å¤±æ•—,éœ€è¦æª¢æŸ¥ SERVICE_API_TOKEN æ˜¯å¦æ­£ç¢ºã€‚

---

## âœ… å®Œæˆç‹€æ…‹

- [x] Queue Worker ç’°å¢ƒè®Šæ•¸è¨­å®šå®Œæˆ
- [x] Service API Token ç”Ÿæˆä¸¦è¨­å®š
- [x] Server èˆ‡ Queue Worker Token åŒæ­¥
- [x] é‡æ–°éƒ¨ç½² Queue Worker
- [ ] ç«¯åˆ°ç«¯æ¸¬è©¦ (å¾…åŸ·è¡Œ)

---

## ğŸ“ å‚™è¨»

1. **Token å®‰å…¨æ€§**
   - Service API Token å·²ä½¿ç”¨ OpenSSL ç”Ÿæˆ (32 bytes, base64 ç·¨ç¢¼)
   - Token å„²å­˜ç‚º Cloudflare Workers Secret,ä¸æœƒå‡ºç¾åœ¨æ—¥èªŒä¸­
   - åªæœ‰ Server å’Œ Queue Worker çŸ¥é“æ­¤ Token

2. **é–‹ç™¼ç’°å¢ƒ**
   - é–‹ç™¼ç’°å¢ƒçš„ SERVER_URL å’Œ WEB_APP_URL å·²è¨­å®šç‚º localhost
   - é–‹ç™¼æ™‚ä½¿ç”¨ `wrangler dev` æœƒè‡ªå‹•è¼‰å…¥ `.dev.vars` å’Œ `[env.dev.vars]`

3. **æœªä¾†ç¶­è­·**
   - å¦‚éœ€æ›´æ› Token,åŒæ™‚æ›´æ–° Server å’Œ Queue Worker
   - ä½¿ç”¨å‘½ä»¤: `echo "æ–°token" | wrangler secret put SERVICE_API_TOKEN`

---

**è¨­å®šå®Œæˆ!** ğŸ‰

ç¾åœ¨å¯ä»¥é€²è¡Œå®Œæ•´çš„ç«¯åˆ°ç«¯æ¸¬è©¦äº†ã€‚
