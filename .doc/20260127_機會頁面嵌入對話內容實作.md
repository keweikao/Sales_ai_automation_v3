# 20260127 機會頁面嵌入對話內容實作

## 摘要

將對話頁面的內容直接嵌入機會頁面，用戶不需跳轉即可查看完整銷售分析。

**前提：** 每個客戶（機會）只會有一個音檔/對話。

---

## 一、需求說明

1. 對話內容直接嵌入機會頁面（不需跳轉）
2. 會議摘要預設收合，放在頁面最下面
3. 基本資訊欄位結構化顯示（店型、營運型態、現有 POS、決策者在場、來源）
4. 對話內容極簡顯示，預設顯示銷售分析

---

## 二、修改檔案清單

| 檔案路徑 | 修改類型 | 說明 |
|----------|----------|------|
| `apps/web/src/components/ui/collapsible.tsx` | 新增 | Collapsible 收合組件 |
| `apps/web/src/routes/opportunities/$id.tsx` | 重構 | 嵌入對話內容 |

---

## 三、新增組件

### Collapsible 組件

**檔案：** `apps/web/src/components/ui/collapsible.tsx`

```typescript
import * as CollapsiblePrimitive from "@radix-ui/react-collapsible";

const Collapsible = CollapsiblePrimitive.Root;
const CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger;
const CollapsibleContent = CollapsiblePrimitive.CollapsibleContent;

export { Collapsible, CollapsibleTrigger, CollapsibleContent };
```

**依賴套件：**
```bash
cd apps/web && bun add @radix-ui/react-collapsible
```

---

## 四、機會頁面重構

### 4.1 頁面佈局

```
+------------------------------------------------------------------+
| 頁面標題 + 返回按鈕                                                |
+------------------------------------------------------------------+
| 主要內容區 (2/3)                    | 側邊欄 (1/3)                |
+-------------------------------------|-----------------------------+
| 基本資訊卡                          | PDCM 評分卡                 |
|  - 公司名稱                         |                             |
|  - 店型                             | SPIN 進度卡                 |
|  - 營運型態                         |                             |
|  - 現有 POS                         | 音檔播放器                   |
|  - 決策者在場                       |                             |
|  - 來源                             | 客戶歷程時間軸               |
|-------------------------------------|                             |
| 銷售分析 / 轉錄文字 Tabs            | 基本時間                     |
|  - PDCM 詳細分析                    |                             |
|  - SPIN 銷售技巧                    |                             |
|  - 戰術建議                         |                             |
|  - 警示                             |                             |
|  - 關鍵發現                         |                             |
|  - 下一步行動                       |                             |
|  - 風險警示                         |                             |
|-------------------------------------|                             |
| 會議摘要 [收合] ▼                   |                             |
+------------------------------------------------------------------+
```

### 4.2 資料獲取

新增對話詳情 query（因為 `opportunity.get` 的 `latestAnalysis` 缺少 `agentOutputs`）：

```typescript
const firstConversationId = opportunity?.conversations?.[0]?.id;

const conversationQuery = useQuery({
  queryKey: ["conversations", "detail", firstConversationId],
  queryFn: () => client.conversations.get({ conversationId: firstConversationId! }),
  enabled: !!firstConversationId,
});

const conversation = conversationQuery.data;
```

### 4.3 基本資訊卡 - 結構化備註

將備註內容解析為結構化欄位顯示：

```typescript
const parseNotes = (notes: string | null | undefined) => {
  if (!notes) return {};
  const result: Record<string, string> = {};
  const lines = notes.split("\n");
  for (const line of lines) {
    const match = line.match(/^(.+?):\s*(.+)$/);
    if (match) {
      result[match[1].trim()] = match[2].trim();
    }
  }
  return result;
};
```

**支援的欄位：**
| 欄位名稱 | 圖示 |
|----------|------|
| 公司名稱 | Building2 |
| 店型 | Target |
| 營運型態 | BarChart3 |
| 現有 POS | MessageSquare |
| 決策者在場 | User |
| 來源 | FileText |

**備註格式範例：**
```
店型: 餐廳
營運型態: takeout
現有 POS: iCHEF 舊版
決策者在場: 是
來源: Slack 音檔上傳
```

### 4.4 銷售分析 Tabs（極簡顯示）

- 移除對話資訊卡（對話類型、時長、日期）
- 預設顯示「銷售分析」Tab
- 保留「轉錄文字」Tab

**Tab 內容：**

**銷售分析 Tab：**
- PDCM 詳細分析（P/D/C/M 四個維度）
- SPIN 銷售技巧分析
- 戰術建議區塊
- 警示區塊
- 關鍵發現
- 下一步行動
- 風險警示

**轉錄文字 Tab：**
- 分段轉錄（含 speaker badge）
- 完整文本（fallback）

### 4.5 側邊欄

| 組件 | 資料來源 |
|------|----------|
| PdcmScoreCard | `conversation.analysis.agentOutputs.agent2.pdcm_scores` |
| SpinProgressCard | `conversation.analysis.agentOutputs.agent3.spin_analysis` |
| 音檔播放器 | `conversation.audioUrl` |
| 客戶歷程時間軸 | `opportunity.todoLogs`, `opportunity.conversations` |
| 基本時間 | `opportunity.createdAt`, `opportunity.updatedAt` |

### 4.6 會議摘要（Collapsible）

- 放在頁面最下面
- 預設收合
- 點擊展開顯示 `conversation.summary`

```tsx
<Collapsible open={isSummaryOpen} onOpenChange={setIsSummaryOpen}>
  <CollapsibleTrigger>
    <FileText /> 會議摘要
    <ChevronDown className="chevron" />
  </CollapsibleTrigger>
  <CollapsibleContent>
    {conversation.summary}
  </CollapsibleContent>
</Collapsible>
```

### 4.7 無對話情況處理

當 `opportunity.conversations.length === 0` 時：
- 顯示「尚未上傳對話」提示
- 提供「上傳錄音」按鈕連結到 `/conversations/new?opportunityId=xxx`

---

## 五、重用組件

| 組件 | 路徑 | 用途 |
|------|------|------|
| PdcmScoreCard | `components/meddic/pdcm-score-card.tsx` | 側邊欄 PDCM 評分 |
| SpinProgressCard | `components/meddic/spin-progress-card.tsx` | 側邊欄 SPIN 進度 |
| TacticalSuggestions | `components/meddic/tactical-suggestions.tsx` | 戰術建議 |
| PdcmSpinAlerts | `components/meddic/pdcm-spin-alerts.tsx` | 警示 |
| Tabs | `components/ui/tabs.tsx` | Tab 切換 |
| Collapsible | `components/ui/collapsible.tsx` | 收合組件 |

---

## 六、部署紀錄

```bash
# 安裝依賴
cd apps/web && bun add @radix-ui/react-collapsible

# 建構與部署
bun run build
bunx wrangler pages deploy dist --project-name=sales-ai-web --branch=main
```

**正式環境 URL：** https://sales-ai-web.pages.dev

---

## 七、驗證清單

- [x] 開啟機會頁面 `/opportunities/{id}`
- [x] 確認對話內容直接顯示（不需跳轉）
- [x] 確認基本資訊結構化顯示（店型、營運型態等）
- [x] 確認會議摘要預設收合，點擊可展開
- [x] 確認 PDCM 評分在側邊欄正確顯示
- [x] 確認 SPIN 進度卡正確顯示
- [x] 確認音檔可播放
- [x] 確認 Tabs 切換正常（銷售分析 / 轉錄文字）
- [x] 測試無對話的機會頁面顯示正常
