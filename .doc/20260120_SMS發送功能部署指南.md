# SMS ç™¼é€åŠŸèƒ½éƒ¨ç½²æŒ‡å—

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å¯¦ä½œäº†å®Œæ•´çš„å®¢æˆ¶ SMS é€šçŸ¥ç³»çµ±,å…è¨±æ¥­å‹™äººå“¡åœ¨ Slack ä¸­é»æ“ŠæŒ‰éˆ•ç›´æ¥ç™¼é€ MEDDIC åˆ†æå ±å‘Šçµ¦å®¢æˆ¶ã€‚

### æ ¸å¿ƒåŠŸèƒ½

1. **Slack Bot è¡¨å–®æ–°å¢é›»è©±æ¬„ä½** - æ”¯æ´å°ç£æ‰‹æ©Ÿè™Ÿç¢¼é©—è­‰ (09xxxxxxxx)
2. **å…¬é–‹åˆ†äº«é€£çµç³»çµ±** - ä½¿ç”¨åŠ å¯† token è®“å®¢æˆ¶ç„¡éœ€ç™»å…¥å³å¯æŸ¥çœ‹å ±å‘Š
3. **EVERY8D SMS æ•´åˆ** - å°ç£ SMS æœå‹™å•†æ•´åˆ
4. **Slack äº’å‹•å¼æŒ‰éˆ•** - ä¸€éµç™¼é€ SMS çµ¦å®¢æˆ¶

---

## ğŸ—ï¸ æ¶æ§‹è¨­è¨ˆ

### è³‡æ–™æµç¨‹

```
1. æ¥­å‹™ä¸Šå‚³éŸ³æª” + å¡«å¯«å®¢æˆ¶é›»è©± (Slack Bot)
   â†“
2. Queue Worker è™•ç†éŸ³æª”ä¸¦ç”Ÿæˆ MEDDIC åˆ†æ
   â†“
3. Queue Worker èª¿ç”¨ API ç”Ÿæˆå…¬é–‹åˆ†äº« token
   â†“
4. Queue Worker ç™¼é€ Slack å®Œæˆé€šçŸ¥ (åŒ…å«ã€Œç™¼é€ SMSã€æŒ‰éˆ•)
   â†“
5. æ¥­å‹™é»æ“Šã€Œç™¼é€ SMSã€æŒ‰éˆ•
   â†“
6. Slack Bot èª¿ç”¨ API ç™¼é€ SMS
   â†“
7. API ç”Ÿæˆ SMS å…§å®¹ (åŒ…å«åˆ†äº«é€£çµ) ä¸¦èª¿ç”¨ EVERY8D ç™¼é€
   â†“
8. å®¢æˆ¶æ”¶åˆ° SMS ä¸¦é»æ“Šé€£çµæŸ¥çœ‹å ±å‘Š
```

### é—œéµæª”æ¡ˆ

#### 1. SMS æœå‹™å±¤
- **`packages/services/src/sms/every8d.ts`** - EVERY8D API æ•´åˆ
  - `sendSMS()` - ç™¼é€ç°¡è¨Š
  - `generateCustomerSMSContent()` - ç”Ÿæˆç°¡è¨Šå…§å®¹

#### 2. API å±¤
- **`packages/api/src/routers/sms.ts`** - SMS API ç«¯é»
  - `sendCustomerSMS` - ç™¼é€å®¢æˆ¶ç°¡è¨Š (protectedProcedure)
- **`packages/api/src/routers/share.ts`** - åˆ†äº«é€£çµ API
  - `createShareToken` - ç”Ÿæˆåˆ†äº« token
  - `getConversationByToken` - é€é token å–å¾—å°è©± (publicProcedure)

#### 3. Queue Worker
- **`apps/queue-worker/src/index.ts`**
  - Step 5.5: ç”Ÿæˆå…¬é–‹åˆ†äº« Token
  - Step 6: ç™¼é€ Slack å®Œæˆé€šçŸ¥ (å‚³é shareToken)

#### 4. Slack Bot
- **`apps/slack-bot/src/index.ts`** (iCHEF)
- **`apps/slack-bot-beauty/src/index.ts`** (Beauty)
  - `send_customer_sms` äº’å‹•è™•ç†å™¨
- **`apps/slack-bot*/src/api-client.ts`**
  - `sendCustomerSMS()` æ–¹æ³•

#### 5. é€šçŸ¥æœå‹™
- **`packages/services/src/notifications/blocks.ts`**
  - `buildProcessingCompletedBlocks()` - æ–°å¢ SMS æŒ‰éˆ•
- **`packages/services/src/notifications/types.ts`**
  - `ProcessingCompletedParams` - æ–°å¢ shareToken åƒæ•¸

---

## ğŸ”§ ç’°å¢ƒè®Šæ•¸é…ç½®

### 1. Server (apps/server)

éœ€è¦åœ¨ `packages/infra/alchemy.run.ts` é…ç½®:

```typescript
export const server = await Worker("server", {
  bindings: {
    // SMS Service (EVERY8D)
    EVERY8D_API_URL:
      alchemy.env.EVERY8D_API_URL ||
      "https://oms.every8d.com/API21/HTTP/sendSMS.ashx",
    EVERY8D_USERNAME: alchemy.secret.env.EVERY8D_USERNAME || alchemy.secret(""),
    EVERY8D_PASSWORD: alchemy.secret.env.EVERY8D_PASSWORD || alchemy.secret(""),

    // Share Token
    SHARE_TOKEN_SECRET:
      alchemy.secret.env.SHARE_TOKEN_SECRET ||
      alchemy.secret("default-secret-change-in-prod"),
    WEB_APP_URL: alchemy.env.WEB_APP_URL || "http://localhost:5173",
  },
});
```

### 2. Queue Worker (apps/queue-worker)

éœ€è¦åœ¨ `.dev.vars` é…ç½®:

```bash
# ç¶²é æ‡‰ç”¨ç¨‹å¼ URL (ç”¨æ–¼ Slack é€šçŸ¥ä¸­çš„å®Œæ•´åˆ†ææŒ‰éˆ•)
WEB_APP_URL=http://localhost:5173

# Server API URL (ç”¨æ–¼å‘¼å« API ç”Ÿæˆ share token)
SERVER_URL=http://localhost:3000
```

éœ€è¦åœ¨ TypeScript é¡å‹ä¸­æ–°å¢:

```typescript
export interface Env {
  // Server API
  SERVER_URL: string;
  SERVICE_API_TOKEN?: string;

  // Web App
  WEB_APP_URL: string;
}
```

### 3. ç’°å¢ƒè®Šæ•¸æ¸…å–®

#### é–‹ç™¼ç’°å¢ƒ (.env, .dev.vars)

```bash
# EVERY8D SMS æœå‹™
EVERY8D_API_URL=https://oms.every8d.com/API21/HTTP/sendSMS.ashx
EVERY8D_USERNAME=your_username
EVERY8D_PASSWORD=your_password

# Share Token åŠ å¯†é‡‘é‘°
SHARE_TOKEN_SECRET=your-secret-key-min-32-chars

# æ‡‰ç”¨ç¨‹å¼ URL
WEB_APP_URL=http://localhost:5173
SERVER_URL=http://localhost:3000

# Service Account Token (Queue Worker -> Server API)
SERVICE_API_TOKEN=your-service-token
```

#### ç”Ÿç”¢ç’°å¢ƒ (Cloudflare Workers Secrets)

```bash
# è¨­å®š Secret (æ•æ„Ÿè³‡è¨Š)
wrangler secret put EVERY8D_USERNAME --env production
wrangler secret put EVERY8D_PASSWORD --env production
wrangler secret put SHARE_TOKEN_SECRET --env production
wrangler secret put SERVICE_API_TOKEN --env production

# è¨­å®šç’°å¢ƒè®Šæ•¸ (éæ•æ„Ÿè³‡è¨Š)
# åœ¨ wrangler.toml ä¸­é…ç½®:
[env.production.vars]
EVERY8D_API_URL = "https://oms.every8d.com/API21/HTTP/sendSMS.ashx"
WEB_APP_URL = "https://your-domain.com"
SERVER_URL = "https://api.your-domain.com"
```

---

## ğŸ“¦ è³‡æ–™åº«è®Šæ›´

### æ–°å¢è³‡æ–™è¡¨

#### 1. `share_tokens` - å…¬é–‹åˆ†äº« Token

```sql
CREATE TABLE share_tokens (
  id TEXT PRIMARY KEY,
  conversation_id TEXT NOT NULL REFERENCES conversations(id),
  token TEXT UNIQUE NOT NULL,
  expires_at TIMESTAMP NOT NULL,
  is_revoked BOOLEAN DEFAULT FALSE,
  view_count TEXT DEFAULT '0',
  last_viewed_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_share_tokens_token ON share_tokens(token);
CREATE INDEX idx_share_tokens_conversation ON share_tokens(conversation_id);
```

#### 2. `sms_logs` - SMS ç™¼é€è¨˜éŒ„

```sql
CREATE TABLE sms_logs (
  id TEXT PRIMARY KEY,
  user_id TEXT,
  opportunity_id TEXT REFERENCES opportunities(id),
  conversation_id TEXT REFERENCES conversations(id),
  phone_number TEXT NOT NULL,
  subject TEXT,
  message TEXT NOT NULL,
  batch_id TEXT,
  status_code TEXT,
  status_message TEXT,
  error_details TEXT,
  cost REAL,
  credit_after REAL,
  delivered_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_sms_logs_conversation ON sms_logs(conversation_id);
CREATE INDEX idx_sms_logs_opportunity ON sms_logs(opportunity_id);
```

### Migration åŸ·è¡Œ

```bash
# ç”Ÿæˆ migration
bun run drizzle-kit generate

# æŸ¥çœ‹ SQL
cat packages/db/migrations/0003_*.sql

# åŸ·è¡Œ migration
bun run drizzle-kit push
```

---

## ğŸš€ éƒ¨ç½²æ­¥é©Ÿ

### 1. å®‰è£ä¾è³´

```bash
bun install
```

### 2. è¨­å®šç’°å¢ƒè®Šæ•¸

```bash
# è¤‡è£½ç¯„ä¾‹ç’°å¢ƒè®Šæ•¸æª”æ¡ˆ
cp .env.example .env

# ç·¨è¼¯ .env ä¸¦å¡«å…¥å¯¦éš›çš„ EVERY8D æ†‘è­‰
# EVERY8D_USERNAME=...
# EVERY8D_PASSWORD=...
```

### 3. åŸ·è¡Œè³‡æ–™åº« Migration

```bash
cd packages/db
bun run drizzle-kit generate
bun run drizzle-kit push
```

### 4. æ¸¬è©¦ SMS ç™¼é€

```bash
# è¨­å®šæ¸¬è©¦é›»è©±è™Ÿç¢¼
export TEST_PHONE_NUMBER=0912345678

# åŸ·è¡Œæ¸¬è©¦è…³æœ¬
bun run test-sms-integration.ts
```

### 5. éƒ¨ç½²åˆ° Cloudflare Workers

```bash
# éƒ¨ç½² Server
cd apps/server
wrangler deploy --env production

# éƒ¨ç½² Queue Worker
cd ../queue-worker
wrangler deploy --env production

# éƒ¨ç½² Slack Bot
cd ../slack-bot
wrangler deploy --env production
cd ../slack-bot-beauty
wrangler deploy --env production
```

### 6. è¨­å®šç”Ÿç”¢ç’°å¢ƒ Secrets

```bash
# Server Secrets
cd apps/server
wrangler secret put EVERY8D_USERNAME --env production
wrangler secret put EVERY8D_PASSWORD --env production
wrangler secret put SHARE_TOKEN_SECRET --env production

# Queue Worker Secrets
cd ../queue-worker
wrangler secret put SERVICE_API_TOKEN --env production
```

---

## ğŸ§ª æ¸¬è©¦æµç¨‹

### 1. ç«¯åˆ°ç«¯æ¸¬è©¦ (E2E)

1. **ä¸Šå‚³éŸ³æª”åˆ° Slack**
   - åœ¨ Slack ä¸Šå‚³éŸ³æª”
   - å¡«å¯«å®¢æˆ¶è³‡è¨Šè¡¨å–® (åŒ…å«é›»è©±è™Ÿç¢¼: 09xxxxxxxx)
   - ç¢ºèªè¡¨å–®æäº¤æˆåŠŸ

2. **ç­‰å¾…è™•ç†å®Œæˆ**
   - Queue Worker è™•ç†éŸ³æª”
   - ç”Ÿæˆ MEDDIC åˆ†æ
   - ç”Ÿæˆå…¬é–‹åˆ†äº« token
   - ç™¼é€ Slack å®Œæˆé€šçŸ¥

3. **é©—è­‰ Slack é€šçŸ¥**
   - ç¢ºèªé€šçŸ¥åŒ…å«ã€ŒğŸ“± ç™¼é€ SMS çµ¦å®¢æˆ¶ã€æŒ‰éˆ•
   - æŒ‰éˆ• value åŒ…å«: conversationId, phoneNumber, shareToken

4. **é»æ“Šç™¼é€ SMS æŒ‰éˆ•**
   - é»æ“ŠæŒ‰éˆ•
   - ç¢ºèªé¡¯ç¤ºã€Œæ­£åœ¨ç™¼é€ç°¡è¨Šè‡³ 09xxxxxxxx...ã€
   - ç­‰å¾…ç™¼é€å®Œæˆ
   - ç¢ºèªé¡¯ç¤ºã€Œâœ… ç°¡è¨Šå·²æˆåŠŸç™¼é€è‡³ 09xxxxxxxxã€

5. **é©—è­‰ SMS æ¥æ”¶**
   - æª¢æŸ¥æ‰‹æ©Ÿæ˜¯å¦æ”¶åˆ°ç°¡è¨Š
   - ç¢ºèªç°¡è¨Šå…§å®¹åŒ…å«:
     - å…¬å¸åç¨±
     - æ¡ˆä»¶ç·¨è™Ÿ
     - MEDDIC åˆ†æ•¸
     - åˆ†äº«é€£çµ

6. **é©—è­‰åˆ†äº«é€£çµ**
   - é»æ“Šç°¡è¨Šä¸­çš„é€£çµ
   - ç¢ºèªå¯ä»¥åœ¨ç€è¦½å™¨ä¸­é–‹å•Ÿ
   - ç¢ºèªé¡¯ç¤ºå®Œæ•´çš„ MEDDIC åˆ†æå ±å‘Š
   - ç¢ºèªä¸éœ€è¦ç™»å…¥

### 2. API æ¸¬è©¦

#### æ¸¬è©¦ç”Ÿæˆ Share Token

```bash
curl -X POST http://localhost:3000/rpc/share.create \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your-token" \
  -d '{"json": {"conversationId": "conv-id"}}'
```

#### æ¸¬è©¦ç™¼é€ SMS

```bash
curl -X POST http://localhost:3000/rpc/sms.sendCustomer \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your-token" \
  -d '{"json": {"conversationId": "conv-id"}}'
```

#### æ¸¬è©¦å…¬é–‹å­˜å– (ä¸éœ€ç™»å…¥)

```bash
curl -X POST http://localhost:3000/rpc/share.getByToken \
  -H "Content-Type: application/json" \
  -d '{"json": {"token": "share-token"}}'
```

---

## ğŸ“Š ç›£æ§èˆ‡é™¤éŒ¯

### 1. æŸ¥çœ‹ Logs

```bash
# Server Logs
wrangler tail --env production

# Queue Worker Logs
cd apps/queue-worker
wrangler tail --env production

# Slack Bot Logs
cd apps/slack-bot
wrangler tail --env production
```

### 2. æª¢æŸ¥ SMS ç™¼é€è¨˜éŒ„

```sql
-- æŸ¥çœ‹æœ€è¿‘çš„ SMS ç™¼é€è¨˜éŒ„
SELECT
  id,
  phone_number,
  status_code,
  status_message,
  cost,
  credit_after,
  created_at
FROM sms_logs
ORDER BY created_at DESC
LIMIT 10;

-- æŸ¥çœ‹å¤±æ•—çš„ SMS
SELECT *
FROM sms_logs
WHERE status_code != 'SUCCESS'
ORDER BY created_at DESC;
```

### 3. æª¢æŸ¥ Share Token

```sql
-- æŸ¥çœ‹æœ€è¿‘çš„ Share Token
SELECT
  id,
  conversation_id,
  token,
  view_count,
  expires_at,
  is_revoked
FROM share_tokens
ORDER BY created_at DESC
LIMIT 10;

-- æŸ¥çœ‹å·²éæœŸçš„ Token
SELECT *
FROM share_tokens
WHERE expires_at < NOW()
AND is_revoked = FALSE;
```

### 4. å¸¸è¦‹å•é¡Œæ’æŸ¥

#### å•é¡Œ 1: SMS æŒ‰éˆ•æœªå‡ºç¾

**å¯èƒ½åŸå› **:
- å®¢æˆ¶é›»è©±æ¬„ä½æœªå¡«å¯«
- Share token ç”Ÿæˆå¤±æ•—
- Queue Worker æœªå‚³é shareToken

**æ’æŸ¥**:
```sql
-- æª¢æŸ¥ opportunity æ˜¯å¦æœ‰é›»è©±è™Ÿç¢¼
SELECT id, company_name, contact_phone
FROM opportunities
WHERE id = 'opp-id';

-- æª¢æŸ¥æ˜¯å¦æœ‰ share token
SELECT *
FROM share_tokens
WHERE conversation_id = 'conv-id';
```

#### å•é¡Œ 2: SMS ç™¼é€å¤±æ•—

**å¯èƒ½åŸå› **:
- EVERY8D æ†‘è­‰éŒ¯èª¤
- é›»è©±è™Ÿç¢¼æ ¼å¼ä¸æ­£ç¢º
- EVERY8D é»æ•¸ä¸è¶³

**æ’æŸ¥**:
```bash
# æª¢æŸ¥ç’°å¢ƒè®Šæ•¸
echo $EVERY8D_USERNAME
echo $EVERY8D_PASSWORD

# æ¸¬è©¦ EVERY8D API
bun run test-sms-integration.ts
```

#### å•é¡Œ 3: åˆ†äº«é€£çµç„¡æ³•è¨ªå•

**å¯èƒ½åŸå› **:
- Token å·²éæœŸ (7 å¤©)
- Token å·²è¢«æ’¤éŠ·
- WEB_APP_URL é…ç½®éŒ¯èª¤

**æ’æŸ¥**:
```sql
-- æª¢æŸ¥ token ç‹€æ…‹
SELECT
  token,
  expires_at,
  is_revoked,
  expires_at > NOW() AS is_valid
FROM share_tokens
WHERE token = 'your-token';
```

---

## ğŸ”’ å®‰å…¨è€ƒé‡

### 1. Share Token å®‰å…¨

- Token ä½¿ç”¨ HMAC-SHA256 åŠ å¯†
- Token åŒ…å« conversationId å’Œæ™‚é–“æˆ³
- é è¨­ 7 å¤©æœ‰æ•ˆæœŸ
- æ”¯æ´æ’¤éŠ·åŠŸèƒ½ (is_revoked)
- è¨˜éŒ„æŸ¥çœ‹æ¬¡æ•¸å’Œæœ€å¾ŒæŸ¥çœ‹æ™‚é–“

### 2. API æ¬Šé™æ§åˆ¶

- `sendCustomerSMS` - protectedProcedure (éœ€è¦ç™»å…¥)
- `getByToken` - publicProcedure (å…¬é–‹,ä½†éœ€æœ‰æ•ˆ token)
- Service Account ä½¿ç”¨ Bearer Token èªè­‰

### 3. è³‡æ–™éš±ç§

- å…¬é–‹åˆ†äº«ä¸åŒ…å«æ•æ„Ÿæ¥­å‹™è³‡è¨Š:
  - âœ… åŒ…å«: å…¬å¸åç¨±ã€MEDDIC åˆ†æã€è½‰éŒ„è¨˜éŒ„
  - âŒ ä¸åŒ…å«: userId, å…§éƒ¨å‚™è¨», å®Œæ•´å®¢æˆ¶è¯çµ¡è³‡è¨Š

### 4. SMS å…§å®¹å®‰å…¨

- ä¸åŒ…å«æ•æ„Ÿè³‡è¨Š
- é€£çµä½¿ç”¨åŠ å¯† token (ç„¡æ³•åå‘æ¨å° conversationId)
- SMS æ—¥èªŒè¨˜éŒ„æ‰€æœ‰ç™¼é€è¡Œç‚º (å¯©è¨ˆè¿½è¹¤)

---

## ğŸ“ æœªä¾†æ”¹é€²æ–¹å‘

### 1. åŠŸèƒ½å¢å¼·

- [ ] SMS æ¨¡æ¿ç³»çµ± (æ”¯æ´è‡ªè¨‚ç°¡è¨Šå…§å®¹)
- [ ] æ‰¹æ¬¡ç™¼é€ SMS
- [ ] SMS ç™¼é€æ’ç¨‹
- [ ] SMS é€é”ç‹€æ…‹è¿½è¹¤ (EVERY8D webhook)
- [ ] å¤šèªç³» SMS å…§å®¹

### 2. ä½¿ç”¨è€…é«”é©—

- [ ] Slack Modal ç¢ºèªå°è©±æ¡† (é è¦½ SMS å…§å®¹)
- [ ] ç™¼é€å‰é©—è­‰é›»è©±è™Ÿç¢¼æ ¼å¼
- [ ] é¡¯ç¤º EVERY8D å‰©é¤˜é»æ•¸
- [ ] SMS ç™¼é€æ­·å²è¨˜éŒ„ (Slack æŒ‡ä»¤æŸ¥è©¢)

### 3. ç›£æ§èˆ‡åˆ†æ

- [ ] SMS ç™¼é€æˆåŠŸç‡å„€è¡¨æ¿
- [ ] å®¢æˆ¶é»æ“Šé€£çµè¿½è¹¤ (Google Analytics)
- [ ] æˆæœ¬åˆ†æå ±è¡¨
- [ ] ç•°å¸¸ç™¼é€è­¦å ± (Slack é€šçŸ¥)

### 4. æŠ€è¡“å„ªåŒ–

- [ ] SMS Queue (é¿å…åŒæ™‚ç™¼é€å¤§é‡ç°¡è¨Š)
- [ ] Share Token è‡ªå‹•æ¸…ç† (åˆªé™¤éæœŸ token)
- [ ] SMS å…§å®¹å¿«å– (æ¸›å°‘é‡è¤‡ç”Ÿæˆ)
- [ ] Rate Limiting (é˜²æ­¢æ¿«ç”¨)

---

## ğŸ“ å­¸ç¿’è³‡æº

### EVERY8D API æ–‡ä»¶
- å®˜æ–¹æ–‡ä»¶: https://www.every8d.com/api
- API ç«¯é»: `POST https://oms.every8d.com/API21/HTTP/sendSMS.ashx`
- å›æ‡‰æ ¼å¼: `credit,sended,cost,unsend,batch_id`

### Slack Block Kit
- Block Kit Builder: https://app.slack.com/block-kit-builder
- Interactive Components: https://api.slack.com/interactivity

### Cloudflare Workers
- Workers æ–‡ä»¶: https://developers.cloudflare.com/workers/
- Queue æ–‡ä»¶: https://developers.cloudflare.com/queues/

---

## ğŸ“ è¯çµ¡æ”¯æ´

å¦‚æœ‰å•é¡Œ,è«‹è¯ç¹«:
- æŠ€è¡“æ”¯æ´: stephen@ichef.com
- EVERY8D å®¢æœ: https://www.every8d.com/contact

---

**æœ€å¾Œæ›´æ–°**: 2026-01-20
**ç‰ˆæœ¬**: 1.0.0
