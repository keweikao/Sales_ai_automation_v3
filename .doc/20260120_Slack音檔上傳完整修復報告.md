# Slack éŸ³æª”ä¸Šå‚³å®Œæ•´ä¿®å¾©å ±å‘Š

**æ—¥æœŸï¼š** 2026-01-20
**ç‹€æ…‹ï¼š** âœ… å…¨éƒ¨å®Œæˆ

## ä¿®å¾©çš„å•é¡Œ

### 1. 401 Unauthorized éŒ¯èª¤

**å•é¡Œæè¿°ï¼š**
åœ¨ Slack ä¸Šå‚³éŸ³æª”ä¸¦å¡«å¯«å®¢æˆ¶è³‡è¨Šå¾Œï¼Œç³»çµ±é¡¯ç¤ºï¼š
```
:x: è™•ç†éŸ³æª”ã€Œæ‹—åˆé¤ - æ¢æ˜å‡±.m4aã€æ™‚ç™¼ç”ŸéŒ¯èª¤:
API Error: 401 - {"json":{"defined":false,"code":"UNAUTHORIZED","status":401,"message":"Unauthorized"}}
```

**æ ¹æœ¬åŸå› ï¼š**
- Slack Bot å’Œ Server çš„ `API_TOKEN` ä¸ä¸€è‡´
- Slack Bot èª¿ç”¨ Server API æ™‚èªè­‰å¤±æ•—

**è§£æ±ºæ–¹æ¡ˆï¼š**
1. ç”Ÿæˆæ–°çš„å®‰å…¨ tokenï¼ˆ32 å­—å…ƒï¼‰
2. åŒæ­¥è¨­å®šåˆ°å…©å€‹æœå‹™ï¼š
   ```bash
   # Slack Bot
   echo "01cc199c38cd72f6acd34bc833384fda58afbf3b0d2f426b4ae0a7bf1415b33f" | \
     bunx wrangler secret put API_TOKEN --name sales-ai-slack-bot

   # Server
   cd apps/server
   echo "01cc199c38cd72f6acd34bc833384fda58afbf3b0d2f426b4ae0a7bf1415b33f" | \
     bunx wrangler secret put API_TOKEN
   ```
3. é‡æ–°éƒ¨ç½²å…©å€‹æœå‹™

**ç›¸é—œæª”æ¡ˆï¼š**
- [`packages/api/src/context.ts:26-40`](packages/api/src/context.ts#L26-L40) - Server ç«¯èªè­‰é‚è¼¯
- [`apps/slack-bot/src/api-client.ts:39-41`](apps/slack-bot/src/api-client.ts#L39-L41) - Slack Bot èªè­‰æ¨™é ­
- [`sync-api-tokens.sh`](sync-api-tokens.sh) - Token åŒæ­¥å·¥å…·è…³æœ¬

---

### 2. é›»è©±æ¬„ä½æ‡‰ç‚ºå¿…å¡«è€Œéé¸å¡«

**å•é¡Œæè¿°ï¼š**
Slack modal è¡¨å–®ä¸­çš„é›»è©±æ¬„ä½æ¨™ç¤ºç‚ºã€Œé¸å¡«ã€ï¼Œä½†å¯¦éš›ä¸Šéœ€è¦é›»è©±è™Ÿç¢¼æ‰èƒ½ç™¼é€ SMS é€šçŸ¥ã€‚

**è§£æ±ºæ–¹æ¡ˆï¼š**

#### ä¿®æ”¹ 1ï¼šè¡¨å–®æ¬„ä½è¨­å®š
**æª”æ¡ˆï¼š** [`apps/slack-bot/src/utils/form-builder.ts:163-168`](apps/slack-bot/src/utils/form-builder.ts#L163-L168)

```typescript
// ä¿®æ”¹å‰
buildTextInput(
  "contact_phone",
  "å®¢æˆ¶é›»è©±ï¼ˆé¸å¡«ï¼Œç”¨æ–¼ç™¼é€ SMS é€šçŸ¥ï¼‰",
  "ä¾‹å¦‚ï¼š0912-345-678",
  false // é¸å¡«
)

// ä¿®æ”¹å¾Œ
buildTextInput(
  "contact_phone",
  "å®¢æˆ¶é›»è©±ï¼ˆç”¨æ–¼ç™¼é€ SMS é€šçŸ¥ï¼‰",
  "ä¾‹å¦‚ï¼š0912-345-678",
  true // å¿…å¡«
)
```

#### ä¿®æ”¹ 2ï¼šé©—è­‰å‡½æ•¸
**æª”æ¡ˆï¼š** [`apps/slack-bot/src/utils/form-builder.ts:19-28`](apps/slack-bot/src/utils/form-builder.ts#L19-L28)

```typescript
// ä¿®æ”¹å‰
function validateTaiwanPhoneNumber(phone: string): boolean {
  if (!phone) return true; // é¸å¡«æ¬„ä½ï¼Œç©ºå€¼è¦–ç‚ºæœ‰æ•ˆ
  // ...
}

// ä¿®æ”¹å¾Œ
function validateTaiwanPhoneNumber(phone: string): boolean {
  if (!phone) return false; // å¿…å¡«æ¬„ä½ï¼Œç©ºå€¼è¦–ç‚ºç„¡æ•ˆ
  // ...
}
```

#### ä¿®æ”¹ 3ï¼šè¡¨å–®æäº¤é©—è­‰
**æª”æ¡ˆï¼š** [`apps/slack-bot/src/index.ts:523-531`](apps/slack-bot/src/index.ts#L523-L531)

```typescript
// æ–°å¢é›»è©±é©—è­‰é‚è¼¯
if (!metadata.contactPhone?.trim()) {
  errors.contact_phone = "è«‹è¼¸å…¥å®¢æˆ¶é›»è©±";
} else {
  // é©—è­‰é›»è©±æ ¼å¼
  const phoneDigits = metadata.contactPhone.replace(/\D/g, "");
  if (!/^09\d{8}$/.test(phoneDigits)) {
    errors.contact_phone = "è«‹è¼¸å…¥æœ‰æ•ˆçš„å°ç£æ‰‹æ©Ÿè™Ÿç¢¼ï¼ˆä¾‹å¦‚ï¼š0912-345-678ï¼‰";
  }
}
```

**é©—è­‰è¦å‰‡ï¼š**
- âœ… å¿…å¡«æª¢æŸ¥ï¼šä¸èƒ½ç‚ºç©º
- âœ… æ ¼å¼é©—è­‰ï¼š10 ä½æ•¸å­—ï¼Œä»¥ 09 é–‹é ­
- âœ… æ”¯æ´åˆ†éš”ç¬¦è™Ÿï¼š`0912-345-678`ã€`09-1234-5678` ç­‰

**åŒæ­¥ä¿®æ”¹ï¼š**
- âœ… iCHEF Slack Bot ([`apps/slack-bot/`](apps/slack-bot/))
- âœ… Beauty Slack Bot ([`apps/slack-bot-beauty/`](apps/slack-bot-beauty/))

---

### 3. Slack æŒ‰éˆ• URL æŒ‡å‘ localhost

**å•é¡Œæè¿°ï¼š**
Slack é€šçŸ¥è¨Šæ¯ä¸­çš„æŒ‰éˆ•ï¼ˆã€ŒæŸ¥çœ‹å®Œæ•´åˆ†æã€ã€ã€Œç·¨è¼¯æœƒè­°æ‘˜è¦èˆ‡ç°¡è¨Šã€ï¼‰æŒ‡å‘ `http://localhost:5173` è€Œé production ç¶²å€ã€‚

**è§£æ±ºæ–¹æ¡ˆï¼š**

#### ä¿®æ”¹ 1ï¼šé è¨­ URL
**æª”æ¡ˆï¼š** [`packages/services/src/notifications/blocks.ts:195`](packages/services/src/notifications/blocks.ts#L195)

```typescript
// ä¿®æ”¹å‰
const webAppUrl = process.env.WEB_APP_URL || "http://localhost:5173";

// ä¿®æ”¹å¾Œ
const webAppUrl = process.env.WEB_APP_URL || "https://sales-ai-web.pages.dev";
```

#### ä¿®æ”¹ 2ï¼šç’°å¢ƒè®Šæ•¸è¨­å®š
**æª”æ¡ˆï¼š** [`apps/server/wrangler.toml:6-10`](apps/server/wrangler.toml#L6-L10)

```toml
[vars]
ENVIRONMENT = "production"
BETTER_AUTH_URL = "https://sales-ai-server.salesaiautomationv3.workers.dev"
CORS_ORIGIN = "https://sales-ai-web.pages.dev"
WEB_APP_URL = "https://sales-ai-web.pages.dev"  # æ–°å¢
```

**å—å½±éŸ¿çš„æŒ‰éˆ•ï¼š**
1. **æŸ¥çœ‹å®Œæ•´åˆ†æ** â†’ `https://sales-ai-web.pages.dev/conversations/{conversationId}`
2. **ç·¨è¼¯æœƒè­°æ‘˜è¦èˆ‡ç°¡è¨Š** â†’ `https://sales-ai-web.pages.dev/conversations/{conversationId}/summary`

---

## éƒ¨ç½²è¨˜éŒ„

### å·²éƒ¨ç½²çš„æœå‹™

| æœå‹™ | ç‰ˆæœ¬ ID | ç‹€æ…‹ |
|------|---------|------|
| **Server** | `26664787-cd0d-4697-bd69-1d37bf4ea98d` | âœ… å·²éƒ¨ç½² |
| **Queue Worker** | `efd9bf1d-a8ac-4586-a611-d3f59823af96` | âœ… å·²éƒ¨ç½² |
| **Slack Bot (iCHEF)** | `0bbf2150-5ffd-4d54-902b-e4a4a57b97a2` | âœ… å·²éƒ¨ç½² |
| **Slack Bot (Beauty)** | `89c4803c-2b8e-49ef-a00e-715d00760cb5` | âœ… å·²éƒ¨ç½² |

### éƒ¨ç½²ç¶²å€

- **Web App**: https://sales-ai-web.pages.dev
- **Server**: https://sales-ai-server.salesaiautomationv3.workers.dev
- **Queue Worker**: https://sales-ai-queue-worker.salesaiautomationv3.workers.dev
- **Slack Bot (iCHEF)**: https://sales-ai-slack-bot.salesaiautomationv3.workers.dev
- **Slack Bot (Beauty)**: https://sales-ai-slack-bot-beauty.salesaiautomationv3.workers.dev

---

## æ¸¬è©¦æŒ‡å—

### å®Œæ•´æ¸¬è©¦æµç¨‹

1. **ä¸Šå‚³éŸ³æª”åˆ° Slack**
   - åœ¨æŒ‡å®šçš„ Slack é »é“ä¸Šå‚³ m4a éŸ³æª”
   - é æœŸï¼šç³»çµ±é¡¯ç¤ºã€Œå¡«å¯«è³‡è¨Šä¸¦åˆ†æã€æŒ‰éˆ•

2. **å¡«å¯«å®¢æˆ¶è³‡è¨Šè¡¨å–®**
   - é»æ“ŠæŒ‰éˆ•é–‹å•Ÿ modal
   - å¡«å¯«å¿…å¡«æ¬„ä½ï¼š
     - âœ… å®¢æˆ¶ç·¨è™Ÿ
     - âœ… å®¢æˆ¶åç¨±
     - âœ… **å®¢æˆ¶é›»è©±**ï¼ˆå¿…å¡«ï¼Œæ ¼å¼ï¼š09XXXXXXXXï¼‰
     - âœ… åº—å‹
     - âœ… ç‡Ÿé‹å‹æ…‹ï¼ˆiCHEFï¼‰/ å“¡å·¥æ•¸é‡ï¼ˆBeautyï¼‰
     - âœ… ç¾æœ‰ç³»çµ±
   - é æœŸï¼š
     - é›»è©±ç•™ç©ºæœƒé¡¯ç¤ºã€Œè«‹è¼¸å…¥å®¢æˆ¶é›»è©±ã€
     - æ ¼å¼éŒ¯èª¤æœƒé¡¯ç¤ºã€Œè«‹è¼¸å…¥æœ‰æ•ˆçš„å°ç£æ‰‹æ©Ÿè™Ÿç¢¼ã€

3. **æäº¤è¡¨å–®**
   - é æœŸï¼š
     - âœ… ç„¡ 401 éŒ¯èª¤
     - âœ… é¡¯ç¤ºã€Œæ­£åœ¨è™•ç†éŸ³æª”...ã€è¨Šæ¯
     - âœ… è™•ç†å®Œæˆå¾Œé¡¯ç¤ºåˆ†æçµæœ

4. **æª¢æŸ¥æŒ‰éˆ• URL**
   - é»æ“Šã€ŒæŸ¥çœ‹å®Œæ•´åˆ†æã€æŒ‰éˆ•
   - é æœŸï¼šå°å‘ `https://sales-ai-web.pages.dev/conversations/...`
   - é»æ“Šã€Œç·¨è¼¯æœƒè­°æ‘˜è¦èˆ‡ç°¡è¨Šã€æŒ‰éˆ•
   - é æœŸï¼šå°å‘ `https://sales-ai-web.pages.dev/conversations/.../summary`

5. **æª¢æŸ¥ SMS åŠŸèƒ½**
   - å¦‚æœå¡«å¯«äº†å®¢æˆ¶é›»è©±
   - é æœŸï¼šé¡¯ç¤ºã€ŒğŸ“± ç™¼é€ SMS çµ¦å®¢æˆ¶ã€æŒ‰éˆ•
   - é»æ“Šå¾Œæ‡‰èƒ½æˆåŠŸç™¼é€ SMS

---

## å·¥å…·è…³æœ¬

### API Token åŒæ­¥è…³æœ¬

**æª”æ¡ˆï¼š** [`sync-api-tokens.sh`](sync-api-tokens.sh)

```bash
#!/bin/bash
# ç”Ÿæˆæ–° token ä¸¦åŒæ­¥åˆ° Slack Bot å’Œ Server

NEW_TOKEN=$(openssl rand -hex 32)
echo "ç”Ÿæˆçš„æ–° token: $NEW_TOKEN"

# è¨­å®š Slack Bot
echo "$NEW_TOKEN" | bunx wrangler secret put API_TOKEN --name sales-ai-slack-bot

# è¨­å®š Server
cd apps/server
echo "$NEW_TOKEN" | bunx wrangler secret put API_TOKEN

# é‡æ–°éƒ¨ç½²
cd ../slack-bot && bunx wrangler deploy
cd ../server && bunx wrangler deploy
```

---

## é é˜²æªæ–½

### æœªä¾†ç¶­è­·æŒ‡å—

1. **API Token ç®¡ç†**
   - å®šæœŸè¼ªæ› API tokens
   - ä½¿ç”¨ `sync-api-tokens.sh` ç¢ºä¿ä¸€è‡´æ€§
   - æ›´æ–°å¾Œå‹™å¿…é‡æ–°éƒ¨ç½²æ‰€æœ‰æœå‹™

2. **ç’°å¢ƒè®Šæ•¸æª¢æŸ¥**
   - éƒ¨ç½²å‰æª¢æŸ¥ `wrangler.toml` ä¸­çš„ URL è¨­å®š
   - ç¢ºèª `WEB_APP_URL` æŒ‡å‘æ­£ç¢ºçš„ç’°å¢ƒ
   - é–‹ç™¼ç’°å¢ƒå’Œç”Ÿç”¢ç’°å¢ƒåˆ†åˆ¥è¨­å®š

3. **è¡¨å–®é©—è­‰**
   - æ–°å¢å¿…å¡«æ¬„ä½æ™‚è¨˜å¾—æ›´æ–°é©—è­‰é‚è¼¯
   - ä¿æŒ iCHEF Bot å’Œ Beauty Bot çš„ä¸€è‡´æ€§
   - éŒ¯èª¤è¨Šæ¯è¦æ¸…æ¥šæ˜ç¢º

4. **éƒ¨ç½²å¾Œé©—è­‰**
   - æ¸¬è©¦å®Œæ•´çš„éŸ³æª”ä¸Šå‚³æµç¨‹
   - æª¢æŸ¥ Slack é€šçŸ¥ä¸­çš„æ‰€æœ‰æŒ‰éˆ•
   - ç¢ºèª SMS ç™¼é€åŠŸèƒ½æ­£å¸¸

---

## ç›¸é—œæ–‡ä»¶

- [`.doc/20260120_API_TOKENè¨­å®šå®Œæˆå ±å‘Š.md`](.doc/20260120_API_TOKENè¨­å®šå®Œæˆå ±å‘Š.md)
- [`.doc/20260120_Beauty_Bot_APIé€£æ¥è¨­å®šå®Œæˆå ±å‘Š.md`](.doc/20260120_Beauty_Bot_APIé€£æ¥è¨­å®šå®Œæˆå ±å‘Š.md)
- [`.doc/20260120_SMSç™¼é€åŠŸèƒ½éƒ¨ç½²å®Œæˆå ±å‘Š.md`](.doc/20260120_SMSç™¼é€åŠŸèƒ½éƒ¨ç½²å®Œæˆå ±å‘Š.md)

---

## ç¸½çµ

âœ… **æ‰€æœ‰å•é¡Œå·²ä¿®å¾©ä¸¦éƒ¨ç½²å®Œæˆ**

- 401 éŒ¯èª¤ï¼šå·²é€éåŒæ­¥ API tokens è§£æ±º
- é›»è©±æ¬„ä½ï¼šå·²æ”¹ç‚ºå¿…å¡«ä¸¦åŠ å…¥å®Œæ•´é©—è­‰
- URL å•é¡Œï¼šå·²ä¿®æ­£ç‚º production ç¶²å€

ç³»çµ±ç¾åœ¨å¯ä»¥æ­£å¸¸è™•ç† Slack éŸ³æª”ä¸Šå‚³ï¼Œä¸¦æä¾›å®Œæ•´çš„åˆ†æå’Œ SMS é€šçŸ¥åŠŸèƒ½ã€‚
