# æ¥­å‹™ Todo List åŠŸèƒ½å¯¦ä½œåŸ·è¡Œæ–‡ä»¶

**å»ºç«‹æ—¥æœŸ**: 2026-01-26
**Branch**: `feature/sales-todos`
**ç‹€æ…‹**: ç¨‹å¼ç¢¼å·²å®Œæˆï¼Œå¾…éƒ¨ç½²

---

## ä¸€ã€åŠŸèƒ½æ¦‚è¿°

### 1.1 åŠŸèƒ½ç›®çš„
è®“æ¥­å‹™åœ¨ä¸Šå‚³éŸ³æª”å¾Œï¼Œå¯ä»¥è¨­å®š Follow-up æé†’ï¼Œç³»çµ±æœƒåœ¨æŒ‡å®šæ—¥æœŸé€é Slack æé†’æ¥­å‹™éœ€è¦è·Ÿé€²çš„æ¡ˆä»¶ã€‚

### 1.2 ä½¿ç”¨è€…æµç¨‹

```
æ¥­å‹™ä¸Šå‚³éŸ³æª” â†’ å¡«å¯«å®¢æˆ¶è³‡æ–™ â†’ å½ˆå‡º Follow-up Modal â†’ é¸æ“‡å¹¾å¤©å¾Œ Follow + å¡«å¯«äº‹é …
                                      â†“
                              ç³»çµ±å„²å­˜å¾…è¾¦äº‹é …
                                      â†“
              æ¯æ—¥ 09:00 Slack æé†’ â† æ¥­å‹™å¯åœ¨ Slack/Web å›å ±å®Œæˆ
```

### 1.3 æ ¸å¿ƒåŠŸèƒ½
1. **Slack è¨­å®š Follow-up**: éŸ³æª”è¡¨å–®é€å‡ºå¾Œå½ˆå‡º Modalï¼Œé¸æ“‡ 1/3/5/7/14 å¤©å¾Œè¿½è¹¤
2. **æ¯æ—¥ Slack æé†’**: æ¯å¤© 09:00 ç™¼é€ç•¶æ—¥å¾…è¾¦çµ¦å„æ¥­å‹™
3. **Slack äº’å‹•å›å ±**: å¯ç›´æ¥åœ¨ Slack å®Œæˆ/æ”¹æœŸ/å–æ¶ˆå¾…è¾¦
4. **Web å€‹äººé é¢**: æ¥­å‹™å¯åœ¨ç¶²é æŸ¥çœ‹å’Œç®¡ç†è‡ªå·±çš„å¾…è¾¦
5. **Web ä¸»ç®¡é é¢**: ä¸»ç®¡å¯æŸ¥çœ‹åœ˜éšŠå¾…è¾¦å®Œæˆç‹€æ³

---

## äºŒã€è³‡æ–™åº«è®Šæ›´

### 2.1 æ–°å¢ Table: `sales_todos`

**Migration æª”æ¡ˆ**: `/packages/db/src/migrations/0007_add_sales_todos.sql`

```sql
CREATE TABLE IF NOT EXISTS "sales_todos" (
    "id" text PRIMARY KEY NOT NULL,
    "user_id" text NOT NULL REFERENCES "user"("id") ON DELETE CASCADE,
    "opportunity_id" text REFERENCES "opportunities"("id") ON DELETE SET NULL,
    "conversation_id" text REFERENCES "conversations"("id") ON DELETE SET NULL,
    "title" text NOT NULL,
    "description" text,
    "due_date" timestamp NOT NULL,
    "original_due_date" timestamp NOT NULL,
    "status" text DEFAULT 'pending' NOT NULL,
    "completion_record" jsonb,
    "postpone_history" jsonb DEFAULT '[]'::jsonb,
    "cancellation_reason" text,
    "reminder_sent" boolean DEFAULT false,
    "reminder_sent_at" timestamp,
    "slack_message_ts" text,
    "source" text DEFAULT 'slack' NOT NULL,
    "created_at" timestamp DEFAULT now() NOT NULL,
    "updated_at" timestamp DEFAULT now() NOT NULL
);

-- ç´¢å¼•
CREATE INDEX IF NOT EXISTS "sales_todos_user_id_idx" ON "sales_todos" ("user_id");
CREATE INDEX IF NOT EXISTS "sales_todos_due_date_idx" ON "sales_todos" ("due_date");
CREATE INDEX IF NOT EXISTS "sales_todos_status_idx" ON "sales_todos" ("status");
CREATE INDEX IF NOT EXISTS "sales_todos_opportunity_id_idx" ON "sales_todos" ("opportunity_id");
```

### 2.2 æ¬„ä½èªªæ˜

| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| `id` | text | ä¸»éµï¼ŒUUID |
| `user_id` | text | æ¥­å‹™ IDï¼Œé—œè¯ user è¡¨ |
| `opportunity_id` | text | å•†æ©Ÿ IDï¼Œå¯ç‚º null |
| `conversation_id` | text | å°è©± IDï¼Œå¯ç‚º null |
| `title` | text | å¾…è¾¦äº‹é …æ¨™é¡Œï¼ˆå¿…å¡«ï¼‰|
| `description` | text | è©³ç´°æè¿°ï¼ˆé¸å¡«ï¼‰|
| `due_date` | timestamp | åˆ°æœŸæ—¥ï¼ˆéœ€ follow çš„æ—¥æœŸï¼‰|
| `original_due_date` | timestamp | åŸå§‹åˆ°æœŸæ—¥ï¼ˆè¿½è¹¤æ”¹æœŸæ¬¡æ•¸ï¼‰|
| `status` | text | ç‹€æ…‹ï¼špending/completed/postponed/cancelled |
| `completion_record` | jsonb | å®Œæˆè¨˜éŒ„ `{result, completedAt, completedVia}` |
| `postpone_history` | jsonb | æ”¹æœŸæ­·å² `[{fromDate, toDate, reason, postponedAt}]` |
| `cancellation_reason` | text | å–æ¶ˆåŸå›  |
| `reminder_sent` | boolean | æ˜¯å¦å·²ç™¼é€æé†’ |
| `reminder_sent_at` | timestamp | æé†’ç™¼é€æ™‚é–“ |
| `slack_message_ts` | text | Slack è¨Šæ¯ timestampï¼ˆç”¨æ–¼æ›´æ–°è¨Šæ¯ï¼‰|
| `source` | text | ä¾†æºï¼šslack/web |

### 2.3 åŸ·è¡Œ Migration

**æ–¹æ³• 1: ç›´æ¥åœ¨ Neon Console åŸ·è¡Œ**
1. ç™»å…¥ [Neon Console](https://console.neon.tech/)
2. é¸æ“‡ä½ çš„å°ˆæ¡ˆå’Œè³‡æ–™åº«
3. é€²å…¥ SQL Editor
4. è²¼ä¸Šä¸Šè¿° SQL ä¸¦åŸ·è¡Œ

**æ–¹æ³• 2: ä½¿ç”¨ psql å‘½ä»¤åˆ—**
```bash
# å–å¾— DATABASE_URL ç’°å¢ƒè®Šæ•¸
source apps/server/.env

# åŸ·è¡Œ migration
psql $DATABASE_URL -f packages/db/src/migrations/0007_add_sales_todos.sql
```

**é©—è­‰ Migration æˆåŠŸ**
```sql
-- ç¢ºèªè¡¨å·²å»ºç«‹
SELECT table_name FROM information_schema.tables WHERE table_name = 'sales_todos';

-- ç¢ºèªç´¢å¼•å·²å»ºç«‹
SELECT indexname FROM pg_indexes WHERE tablename = 'sales_todos';
```

---

## ä¸‰ã€æ–°å¢æª”æ¡ˆæ¸…å–®

### 3.1 è³‡æ–™åº« Schema
| æª”æ¡ˆ | èªªæ˜ |
|------|------|
| `packages/db/src/schema/sales-todo.ts` | Drizzle ORM Schema å®šç¾© |
| `packages/db/src/migrations/0007_add_sales_todos.sql` | SQL Migration |

### 3.2 API Router
| æª”æ¡ˆ | èªªæ˜ |
|------|------|
| `packages/api/src/routers/sales-todo.ts` | å®Œæ•´ CRUD APIï¼ˆ7 å€‹ç«¯é»ï¼‰|

### 3.3 Slack Bot
| æª”æ¡ˆ | èªªæ˜ |
|------|------|
| `apps/slack-bot/src/blocks/follow-up-modal.ts` | Follow-up Modal å»ºæ§‹å™¨ |
| `apps/slack-bot/src/blocks/todo-reminder.ts` | æ¯æ—¥æé†’è¨Šæ¯ Blocks |

### 3.4 Queue Worker
| æª”æ¡ˆ | èªªæ˜ |
|------|------|
| `apps/queue-worker/wrangler.toml` | æ–°å¢ cron æ’ç¨‹ |
| `apps/queue-worker/src/index.ts` | æ–°å¢ `handleDailyTodoReminder` |

### 3.5 Web å‰ç«¯
| æª”æ¡ˆ | èªªæ˜ |
|------|------|
| `apps/web/src/routes/todos/index.tsx` | å€‹äººå¾…è¾¦é é¢ |
| `apps/web/src/routes/todos/team.tsx` | ä¸»ç®¡åœ˜éšŠé é¢ |

---

## å››ã€ä¿®æ”¹æª”æ¡ˆæ¸…å–®

| æª”æ¡ˆ | ä¿®æ”¹å…§å®¹ |
|------|---------|
| `packages/db/src/schema/index.ts` | æ–°å¢ `export * from "./sales-todo"` |
| `packages/api/src/routers/index.ts` | è¨»å†Š `salesTodo` router |
| `apps/slack-bot/src/index.ts` | æ–°å¢ Modal å’Œäº’å‹•è™•ç† |
| `apps/slack-bot/src/blocks/index.ts` | æ–°å¢ export |
| `apps/queue-worker/wrangler.toml` | æ–°å¢ cron `0 1 * * *` |
| `apps/queue-worker/src/index.ts` | æ–°å¢æ¯æ—¥æé†’é‚è¼¯ |

---

## äº”ã€API ç«¯é»èªªæ˜

### 5.1 ç«¯é»æ¸…å–®

| ç«¯é» | æ–¹æ³• | èªªæ˜ |
|------|------|------|
| `salesTodo.create` | POST | å»ºç«‹å¾…è¾¦ |
| `salesTodo.get` | GET | å–å¾—å–®ç­†å¾…è¾¦ |
| `salesTodo.list` | GET | åˆ—è¡¨æŸ¥è©¢ |
| `salesTodo.complete` | POST | å®Œæˆå¾…è¾¦ |
| `salesTodo.postpone` | POST | æ”¹æœŸå¾…è¾¦ |
| `salesTodo.cancel` | POST | å–æ¶ˆå¾…è¾¦ |
| `salesTodo.getTodaysTodos` | GET | å–å¾—ä»Šæ—¥å¾…è¾¦ï¼ˆä¾› Cronï¼‰|

### 5.2 æ¬Šé™æ§åˆ¶

| è§’è‰² | æ¬Šé™ |
|------|------|
| `sales_rep` | åªèƒ½çœ‹/æ”¹è‡ªå·±çš„å¾…è¾¦ |
| `manager` | å¯çœ‹åŒ department çš„æ‰€æœ‰å¾…è¾¦ |
| `admin` | å¯çœ‹å…¨éƒ¨å¾…è¾¦ |

### 5.3 API ä½¿ç”¨ç¯„ä¾‹

**å»ºç«‹å¾…è¾¦**
```typescript
await client.salesTodo.create({
  title: "ç¢ºèªå ±åƒ¹å–®",
  description: "è·Ÿç‹è€é—†ç¢ºèªå ±åƒ¹æ˜¯å¦OK",
  dueDate: "2026-01-29T00:00:00.000Z",
  opportunityId: "xxx-xxx-xxx",
  conversationId: "yyy-yyy-yyy",
  source: "slack"
});
```

**å®Œæˆå¾…è¾¦**
```typescript
await client.salesTodo.complete({
  todoId: "zzz-zzz-zzz",
  result: "å®¢æˆ¶ç¢ºèªä¸‹é€±ç°½ç´„",
  completedVia: "web"
});
```

**æ”¹æœŸå¾…è¾¦**
```typescript
await client.salesTodo.postpone({
  todoId: "zzz-zzz-zzz",
  newDate: "2026-02-01T00:00:00.000Z",
  reason: "å®¢æˆ¶å‡ºå·®ä¸­"
});
```

---

## å…­ã€Slack äº’å‹•èªªæ˜

### 6.1 Follow-up Modalï¼ˆéŸ³æª”ä¸Šå‚³å¾Œï¼‰

ç•¶æ¥­å‹™å®ŒæˆéŸ³æª”ä¸Šå‚³è¡¨å–®å¾Œï¼Œç³»çµ±æœƒè‡ªå‹•å½ˆå‡º Follow-up Modalï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¨­å®š Follow-up                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ¡ˆä»¶: 202601-IC046                  â”‚
â”‚  å®¢æˆ¶: ç‹è¨˜å°åƒ                       â”‚
â”‚                                     â”‚
â”‚  å¹¾å¤©å¾Œ Follow:                       â”‚
â”‚  [1å¤©] [3å¤©] [5å¤©] [7å¤©] [14å¤©]       â”‚
â”‚                                     â”‚
â”‚  Follow äº‹é …: [________________]     â”‚
â”‚                                     â”‚
â”‚  è©³ç´°æè¿°ï¼ˆé¸å¡«ï¼‰:                    â”‚
â”‚  [____________________________]     â”‚
â”‚                                     â”‚
â”‚  [è·³é]              [å»ºç«‹]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- **callback_id**: `follow_up_form`
- **å¤©æ•¸é¸æ“‡**: ç³»çµ±è‡ªå‹•è¨ˆç®—åˆ°æœŸæ—¥ï¼ˆä»Šå¤© + N å¤©ï¼‰
- **è·³é**: ä¸å»ºç«‹å¾…è¾¦ï¼Œç›´æ¥é—œé–‰
- **å»ºç«‹**: å„²å­˜å¾…è¾¦åˆ°è³‡æ–™åº«

### 6.2 æ¯æ—¥æé†’è¨Šæ¯

æ¯å¤© 09:00 (UTC+8) ç™¼é€åˆ°æ¥­å‹™çš„ Slack DMï¼š

```
ğŸ“‹ ä»Šæ—¥å¾…è¾¦æé†’
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“… 2026/1/26 | å…± 3 é …å¾…è¾¦

ğŸ”´ é€¾æœŸå¾…è¾¦ (1)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ç¢ºèªå ±åƒ¹å–®
ğŸ“ ç‹è¨˜å°åƒ | ğŸ“‹ 202601-IC046
âš ï¸ é€¾æœŸ 2 å¤©
[å®Œæˆ â–¾]

ğŸ“Œ ä»Šæ—¥å¾…è¾¦ (2)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
è©¢å•æ±ºç­–é€²åº¦
ğŸ“ ç¾éº—é«®å»Š | ğŸ“‹ 202601-BT003
[å®Œæˆ â–¾]

è·Ÿé€²è©¦ç”¨åé¥‹
ğŸ“ å¿«æ¨‚å’–å•¡ | ğŸ“‹ 202601-IC047
[å®Œæˆ â–¾]

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[ğŸ“‹ æŸ¥çœ‹æ‰€æœ‰å¾…è¾¦]
```

### 6.3 äº’å‹•æŒ‰éˆ•

é»æ“Šã€Œå®Œæˆã€ä¸‹æ‹‰é¸å–®æœƒé¡¯ç¤ºï¼š
- âœ… å®Œæˆ â†’ é–‹å•Ÿ Modal è¼¸å…¥çµæœ
- ğŸ“… æ”¹æœŸ â†’ é–‹å•Ÿ Modal é¸æ—¥æœŸ + åŸå› 
- âŒ å–æ¶ˆ â†’ é–‹å•Ÿ Modal è¼¸å…¥åŸå› 

---

## ä¸ƒã€Cron Job è¨­å®š

### 7.1 æ’ç¨‹æ™‚é–“

**wrangler.toml è¨­å®š**:
```toml
[triggers]
crons = [
  "0 0 * * *",     # æ¯æ—¥ 08:00 (UTC+8) - å¥åº·å ±å‘Š
  "0 0 * * 1",     # æ¯é€±ä¸€ 08:00 (UTC+8) - é€±å ±
  "0 1 * * *",     # æ¯æ—¥ 09:00 (UTC+8) - Todo æé†’
]
```

> **æ³¨æ„**: Cloudflare Cron ä½¿ç”¨ UTC æ™‚é–“ï¼Œ`0 1 * * *` = UTC 01:00 = å°ç£ 09:00

### 7.2 æé†’é‚è¼¯

```typescript
async function handleDailyTodoReminder(env: Env) {
  // 1. æŸ¥è©¢ status='pending' ä¸” dueDate <= ä»Šå¤© çš„å¾…è¾¦
  // 2. æŒ‰ userId åˆ†çµ„
  // 3. æŸ¥è©¢ userProfiles å–å¾— slackUserId
  // 4. å°æ¯å€‹ç”¨æˆ¶ç™¼é€ Slack DM
  // 5. æ›´æ–° reminderSent = true
}
```

---

## å…«ã€éƒ¨ç½²æ­¥é©Ÿ

### 8.1 éƒ¨ç½²å‰æª¢æŸ¥æ¸…å–®

- [ ] ç¢ºèªåœ¨ `feature/sales-todos` branch
- [ ] åŸ·è¡Œ `bun x ultracite check` ç¢ºèªç„¡ lint éŒ¯èª¤
- [ ] åŸ·è¡Œ `bun run typecheck` ç¢ºèªç„¡é¡å‹éŒ¯èª¤
- [ ] ç¢ºèªè³‡æ–™åº« migration å·²åŸ·è¡Œ

### 8.2 éƒ¨ç½²é †åº

**Step 1: åŸ·è¡Œè³‡æ–™åº« Migration**
```bash
# åœ¨ Neon Console æˆ–ç”¨ psql åŸ·è¡Œ
psql $DATABASE_URL -f packages/db/src/migrations/0007_add_sales_todos.sql
```

**Step 2: éƒ¨ç½² Serverï¼ˆåŒ…å«æ–°çš„ API Routerï¼‰**
```bash
cd apps/server
wrangler deploy
```

**Step 3: éƒ¨ç½² Queue Workerï¼ˆåŒ…å«æ–°çš„ Cron Jobï¼‰**
```bash
cd apps/queue-worker
wrangler deploy
```

**Step 4: éƒ¨ç½² Slack Botï¼ˆåŒ…å«æ–°çš„ Modal å’Œäº’å‹•ï¼‰**
```bash
cd apps/slack-bot
wrangler deploy
```

**Step 5: éƒ¨ç½² Webï¼ˆåŒ…å«æ–°çš„é é¢ï¼‰**
```bash
cd apps/web
wrangler pages deploy dist
```

### 8.3 éƒ¨ç½²å¾Œé©—è­‰

1. **API æ¸¬è©¦**
   - å‘¼å« `salesTodo.create` å»ºç«‹æ¸¬è©¦å¾…è¾¦
   - å‘¼å« `salesTodo.list` ç¢ºèªå¯ä»¥æŸ¥è©¢

2. **Slack æ¸¬è©¦**
   - ä¸Šå‚³ä¸€å€‹æ¸¬è©¦éŸ³æª”
   - ç¢ºèª Follow-up Modal æœ‰å½ˆå‡º
   - å¡«å¯«ä¸¦é€å‡ºï¼Œç¢ºèªè³‡æ–™åº«æœ‰è¨˜éŒ„

3. **Cron æ¸¬è©¦**
   - ä½¿ç”¨ `wrangler dev --test-scheduled` æ‰‹å‹•è§¸ç™¼
   - æˆ–ç­‰å¾…éš”å¤© 09:00 ç¢ºèªæé†’æœ‰ç™¼é€

4. **Web æ¸¬è©¦**
   - è¨ªå• https://sales-ai-web.pages.dev/todos
   - ç¢ºèªå€‹äººå¾…è¾¦é é¢å¯æ­£å¸¸é¡¯ç¤º
   - æ¸¬è©¦å®Œæˆ/æ”¹æœŸåŠŸèƒ½

---

## ä¹ã€Web é é¢è·¯å¾‘

| è·¯å¾‘ | èªªæ˜ | æ¬Šé™ |
|------|------|------|
| `/todos` | å€‹äººå¾…è¾¦é é¢ | æ‰€æœ‰ç™»å…¥ç”¨æˆ¶ |
| `/todos/team` | åœ˜éšŠå¾…è¾¦é é¢ | manager, admin |

---

## åã€æ³¨æ„äº‹é …

### 10.1 Slack User ID æ˜ å°„

ç‚ºäº†è®“ Cron Job èƒ½ç™¼é€ Slack DMï¼Œéœ€è¦ç¢ºä¿ `user_profiles` è¡¨ä¸­æœ‰æ­£ç¢ºçš„ `slack_user_id` æ˜ å°„ã€‚

ç¾æœ‰æ˜ å°„æ–¹å¼ï¼š
1. æ¥­å‹™é¦–æ¬¡ä½¿ç”¨ Slack Bot æ™‚è‡ªå‹•å»ºç«‹
2. ç®¡ç†å“¡æ‰‹å‹•åœ¨è³‡æ–™åº«è¨­å®š

### 10.2 æ™‚å€è™•ç†

- è³‡æ–™åº«å„²å­˜ï¼šUTC
- é¡¯ç¤ºè½‰æ›ï¼šAsia/Taipei
- Cron æ’ç¨‹ï¼šä½¿ç”¨ UTC æ™‚é–“

### 10.3 æ•ˆèƒ½è€ƒé‡

å·²å»ºç«‹ä»¥ä¸‹ç´¢å¼•ï¼š
- `sales_todos_user_id_idx`
- `sales_todos_due_date_idx`
- `sales_todos_status_idx`
- `sales_todos_opportunity_id_idx`

---

## åä¸€ã€æœªä¾†æ“´å……å»ºè­°

1. **æé†’é »ç‡è¨­å®š**: è®“æ¥­å‹™å¯ä»¥è¨­å®šæ˜¯å¦è¦æ¯å¤©æé†’ï¼Œé‚„æ˜¯åªåœ¨ç•¶å¤©æé†’ä¸€æ¬¡
2. **é€¾æœŸè­¦å‘Š**: å°å¤šæ¬¡æ”¹æœŸæˆ–é•·æœŸé€¾æœŸçš„æ¡ˆä»¶ç™¼é€è­¦å‘Šçµ¦ä¸»ç®¡
3. **çµ±è¨ˆå ±è¡¨**: åœ¨ä¸»ç®¡é é¢å¢åŠ å®Œæˆç‡è¶¨å‹¢åœ–
4. **æ‰¹æ¬¡æ“ä½œ**: å…è¨±æ‰¹æ¬¡å®Œæˆæˆ–æ”¹æœŸå¤šå€‹å¾…è¾¦

---

## åäºŒã€ç›¸é—œæ–‡ä»¶

- è¨ˆç•«æª”: `~/.claude/plans/humble-riding-kahn.md`
- Schema å®šç¾©: `/packages/db/src/schema/sales-todo.ts`
- API Router: `/packages/api/src/routers/sales-todo.ts`
