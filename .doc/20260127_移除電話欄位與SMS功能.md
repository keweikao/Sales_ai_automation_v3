# ç§»é™¤é›»è©±æ¬„ä½èˆ‡ SMS åŠŸèƒ½

**æ—¥æœŸ**: 2026-01-27
**é¡å‹**: åŠŸèƒ½ç§»é™¤ / ç°¡åŒ–
**ç‹€æ…‹**: å·²å®Œæˆ

---

## ä¸€ã€è®Šæ›´æ‘˜è¦

æ ¹æ“šç”¢å“éœ€æ±‚èª¿æ•´ï¼Œç§»é™¤ä»¥ä¸‹åŠŸèƒ½ï¼š
1. **ä¸Šå‚³éŸ³æª” Modal** - ç§»é™¤å®¢æˆ¶é›»è©±è™Ÿç¢¼è¼¸å…¥æ¬„ä½
2. **åˆ†æå ±å‘Š** - ç§»é™¤ SMS ç™¼é€æŒ‰éˆ•å’Œè¯çµ¡è³‡è¨Šé¡¯ç¤ºå€å¡Š
3. **Web å°è©±é é¢** - ç§»é™¤ SMS ç™¼é€åŠŸèƒ½ï¼Œä¿ç•™åˆ†äº«é è¦½

---

## äºŒã€ä¿®æ”¹æª”æ¡ˆæ¸…å–®

### 2.1 Slack Bot (iCHEF)

| æª”æ¡ˆ | è®Šæ›´å…§å®¹ |
|------|---------|
| `apps/slack-bot/src/utils/form-builder.ts` | ç§»é™¤ `contact_phone` æ¬„ä½ã€é›»è©±é©—è­‰å‡½æ•¸ã€`contactPhone` å±¬æ€§ |
| `apps/slack-bot/src/blocks/analysis-result.ts` | ç§»é™¤ `ContactInfo` ä»‹é¢ã€SMS æŒ‰éˆ•ã€è¯çµ¡è³‡è¨Šé¡¯ç¤º |
| `apps/slack-bot/src/blocks/edit-summary-modal.ts` | ç§»é™¤è¯çµ¡è³‡è¨Šé¡¯ç¤ºå€å¡Š |
| `apps/slack-bot/src/events/file.ts` | æ›´æ–° `buildSummaryBlocks` å‘¼å«ï¼Œç§»é™¤ `contactInfo` åƒæ•¸ |
| `apps/slack-bot/src/index.ts` | ç§»é™¤ `send_sms` handlerã€é›»è©±é©—è­‰ã€ç·¨è¼¯æ‘˜è¦çš„è¯çµ¡è³‡è¨Š |

### 2.2 Slack Bot (Beauty)

| æª”æ¡ˆ | è®Šæ›´å…§å®¹ |
|------|---------|
| `apps/slack-bot-beauty/src/utils/form-builder.ts` | åŒ iCHEF ç‰ˆæœ¬ |
| `apps/slack-bot-beauty/src/blocks/analysis-result.ts` | åŒ iCHEF ç‰ˆæœ¬ |
| `apps/slack-bot-beauty/src/blocks/edit-summary-modal.ts` | åŒ iCHEF ç‰ˆæœ¬ |
| `apps/slack-bot-beauty/src/events/file.ts` | åŒ iCHEF ç‰ˆæœ¬ |
| `apps/slack-bot-beauty/src/index.ts` | åŒ iCHEF ç‰ˆæœ¬ |

### 2.3 Web å‰ç«¯

| æª”æ¡ˆ | è®Šæ›´å…§å®¹ |
|------|---------|
| `apps/web/src/routes/conversations/$id.tsx` | ç§»é™¤ `sendSmsMutation`ã€SMS ç™¼é€æŒ‰éˆ•ã€ç°¡è¨Šç‹€æ…‹é¡¯ç¤º |

---

## ä¸‰ã€è©³ç´°è®Šæ›´èªªæ˜

### 3.1 ä¸Šå‚³éŸ³æª” Modal (`form-builder.ts`)

**ç§»é™¤å‰**:
```typescript
const commonBlocks = [
  buildTextInput("customer_number", "å®¢æˆ¶ç·¨è™Ÿ", ...),
  buildTextInput("customer_name", "å®¢æˆ¶åç¨±", ...),
  buildTextInput("contact_phone", "å®¢æˆ¶é›»è©±ï¼ˆç”¨æ–¼ç™¼é€ SMS é€šçŸ¥ï¼‰", ...),
];
```

**ç§»é™¤å¾Œ**:
```typescript
const commonBlocks = [
  buildTextInput("customer_number", "å®¢æˆ¶ç·¨è™Ÿ", ...),
  buildTextInput("customer_name", "å®¢æˆ¶åç¨±", ...),
];
```

**åŒæ™‚ç§»é™¤**:
- `validateTaiwanPhoneNumber()` å‡½æ•¸
- `formatTaiwanPhoneNumber()` å‡½æ•¸
- `AudioUploadMetadata.contactPhone` å±¬æ€§
- è¡¨å–®è§£æä¸­çš„é›»è©±è™Ÿç¢¼è™•ç†é‚è¼¯

### 3.2 åˆ†æå ±å‘Š (`analysis-result.ts`)

**ç§»é™¤å‰**:
```typescript
export interface ContactInfo {
  phone?: string | null;
  email?: string | null;
}

export function buildSummaryBlocks(
  conversationId: string,
  summary: string,
  nextSteps: Array<...>,
  contactInfo: ContactInfo  // ç§»é™¤æ­¤åƒæ•¸
): object[]
```

**ç§»é™¤å¾Œ**:
```typescript
export function buildSummaryBlocks(
  conversationId: string,
  summary: string,
  nextSteps: Array<...>
): object[]
```

**ç§»é™¤çš„ UI å€å¡Š**:
- å®¢æˆ¶è¯çµ¡è³‡è¨Šå€å¡Šï¼ˆé›»è©±ã€Email é¡¯ç¤ºï¼‰
- ã€Œå¯„ç°¡è¨Šã€æŒ‰éˆ•
- ã€Œå¯„ Emailã€æŒ‰éˆ•ï¼ˆä¿ç•™æ¶æ§‹ä½†ç§»é™¤ SMS ç›¸é—œï¼‰

### 3.3 ç·¨è¼¯æ‘˜è¦ Modal (`edit-summary-modal.ts`)

**ç§»é™¤å‰**:
```typescript
export interface SummaryModalData {
  conversationId: string;
  currentSummary: string;
  contactPhone?: string | null;  // ç§»é™¤
  contactEmail?: string | null;  // ç§»é™¤
}

// Modal ä¸­é¡¯ç¤ºçš„å®¢æˆ¶è¯çµ¡è³‡è¨Šå€å¡Š
{
  type: "section",
  fields: [
    { type: "mrkdwn", text: `*ğŸ“ é›»è©±*\n${data.contactPhone ?? "_ç„¡_"}` },
    { type: "mrkdwn", text: `*ğŸ“§ Email*\n${data.contactEmail ?? "_ç„¡_"}` },
  ],
}
```

**ç§»é™¤å¾Œ**:
```typescript
export interface SummaryModalData {
  conversationId: string;
  currentSummary: string;
}

// åªä¿ç•™æ‘˜è¦ç·¨è¼¯å€
```

### 3.4 Slack Bot Handler (`index.ts`)

**ç§»é™¤çš„ Action Handler**:
```typescript
case "send_sms": {
  // ç™¼é€ç°¡è¨Šçµ¦å®¢æˆ¶ - æ•´å€‹ case å€å¡Šç§»é™¤
  const data = JSON.parse(value);
  const notificationService = createNotificationService(env);
  // ... SMS ç™¼é€é‚è¼¯
  break;
}
```

**ç§»é™¤çš„è¡¨å–®é©—è­‰**:
```typescript
// åŸæœ¬çš„é›»è©±é©—è­‰é‚è¼¯
if (metadata.contactPhone?.trim()) {
  const phoneDigits = metadata.contactPhone.replace(/\D/g, "");
  if (!/^09\d{8}$/.test(phoneDigits)) {
    errors.contact_phone = "è«‹è¼¸å…¥æœ‰æ•ˆçš„å°ç£æ‰‹æ©Ÿè™Ÿç¢¼";
  }
} else {
  errors.contact_phone = "è«‹è¼¸å…¥å®¢æˆ¶é›»è©±";
}
```

### 3.5 Web å°è©±é é¢ (`conversations/$id.tsx`)

**ç§»é™¤çš„ Mutation**:
```typescript
const sendSmsMutation = useMutation({
  mutationFn: () => client.sms.sendCustomer({ conversationId: id }),
  onSuccess: (data) => {
    toast.success(`ç°¡è¨Šå·²æˆåŠŸç™¼é€è‡³ ${data.phoneNumber}!`);
  },
});
```

**ç§»é™¤çš„ UI å€å¡Š**:
```tsx
// åŸæœ¬çš„ã€Œå®¢æˆ¶é€šçŸ¥ã€å¡ç‰‡
<Card>
  <CardHeader>
    <CardTitle>å®¢æˆ¶é€šçŸ¥</CardTitle>
    <CardDescription>SMS ç™¼é€ç‹€æ…‹èˆ‡é è¦½</CardDescription>
  </CardHeader>
  <CardContent>
    <Button onClick={handlePreviewShare}>é è¦½å…¬é–‹åˆ†äº«é é¢</Button>
    <Button onClick={() => sendSmsMutation.mutate()}>ç™¼é€ SMS çµ¦å®¢æˆ¶</Button>
    {/* SMS ç™¼é€ç‹€æ…‹é¡¯ç¤º */}
  </CardContent>
</Card>
```

**ä¿ç•™çš„åŠŸèƒ½**:
```tsx
// ç°¡åŒ–å¾Œçš„ã€Œåˆ†äº«é€£çµã€å¡ç‰‡
<Card>
  <CardHeader>
    <CardTitle>åˆ†äº«é€£çµ</CardTitle>
    <CardDescription>å…¬é–‹åˆ†äº«é é¢é è¦½</CardDescription>
  </CardHeader>
  <CardContent>
    <Button onClick={handlePreviewShare}>
      <ExternalLink /> é è¦½å…¬é–‹åˆ†äº«é é¢
    </Button>
  </CardContent>
</Card>
```

**ç§»é™¤çš„ Imports**:
```typescript
// ç§»é™¤
import { Send, CheckCircle2 } from "lucide-react";
```

---

## å››ã€å½±éŸ¿ç¯„åœ

### 4.1 ç”¨æˆ¶é«”é©—è®Šæ›´

| åŠŸèƒ½ | è®Šæ›´å‰ | è®Šæ›´å¾Œ |
|------|--------|--------|
| ä¸Šå‚³éŸ³æª”è¡¨å–® | éœ€å¡«å¯«å®¢æˆ¶é›»è©±ï¼ˆå¿…å¡«ï¼‰ | ä¸éœ€å¡«å¯«é›»è©± |
| åˆ†æå ±å‘Š | é¡¯ç¤ºè¯çµ¡è³‡è¨Š + SMS/Email æŒ‰éˆ• | åªé¡¯ç¤ºç·¨è¼¯æ‘˜è¦æŒ‰éˆ• |
| ç·¨è¼¯æ‘˜è¦ Modal | é¡¯ç¤ºè¯çµ¡è³‡è¨Š | åªé¡¯ç¤ºæ‘˜è¦ç·¨è¼¯å€ |
| Web å°è©±é é¢ | å¯ç™¼é€ SMS | åªèƒ½é è¦½åˆ†äº«é é¢ |

### 4.2 è³‡æ–™åº«å½±éŸ¿

- **ç„¡ Schema è®Šæ›´**: `customerPhone` æ¬„ä½ä¿ç•™åœ¨è³‡æ–™åº«ä¸­
- **ç¾æœ‰è³‡æ–™**: å·²å„²å­˜çš„é›»è©±è™Ÿç¢¼è³‡æ–™ä¿ç•™ï¼Œåƒ…ä¸å†æ”¶é›†æ–°è³‡æ–™
- **å‘ä¸‹ç›¸å®¹**: API ç«¯é»ä¿ç•™ï¼Œåªæ˜¯å‰ç«¯ä¸å†å‘¼å«

### 4.3 ä¿ç•™çš„åŠŸèƒ½

- æ©Ÿæœƒ (Opportunity) ä¸­çš„ `contactPhone` æ¬„ä½ï¼ˆç”¨æ–¼å…¶ä»–ç”¨é€”ï¼‰
- SMS API ç«¯é»ï¼ˆ`/rpc/sms/sendCustomer`ï¼‰ä»å¯ç”¨
- `opportunity-card.ts` ä¸­çš„é›»è©±é¡¯ç¤ºï¼ˆæ©Ÿæœƒå¡ç‰‡ï¼‰

---

## äº”ã€æ¸¬è©¦é©—è­‰

### 5.1 Type Check
```bash
bunx turbo check-types
# Tasks: 10 successful, 10 total
```

### 5.2 Linting
```bash
bun x ultracite check
# No fixes applied
```

### 5.3 åŠŸèƒ½æ¸¬è©¦

- [ ] ä¸Šå‚³éŸ³æª” Modal æ­£ç¢ºé¡¯ç¤ºï¼ˆç„¡é›»è©±æ¬„ä½ï¼‰
- [ ] åˆ†æå ±å‘Šæ­£ç¢ºé¡¯ç¤ºï¼ˆç„¡ SMS æŒ‰éˆ•ï¼‰
- [ ] ç·¨è¼¯æ‘˜è¦ Modal æ­£ç¢ºé¡¯ç¤ºï¼ˆç„¡è¯çµ¡è³‡è¨Šï¼‰
- [ ] Web å°è©±é é¢æ­£ç¢ºé¡¯ç¤ºï¼ˆåªæœ‰åˆ†äº«é è¦½æŒ‰éˆ•ï¼‰

---

## å…­ã€éƒ¨ç½²æ³¨æ„äº‹é …

1. **Slack Bot éƒ¨ç½²**:
   ```bash
   cd apps/slack-bot && wrangler deploy
   cd apps/slack-bot-beauty && wrangler deploy
   ```

2. **Web éƒ¨ç½²**: éš¨ä¸€èˆ¬éƒ¨ç½²æµç¨‹

3. **ç„¡éœ€è³‡æ–™åº«é·ç§»**: æ­¤æ¬¡è®Šæ›´ä¸æ¶‰åŠ Schema è®Šæ›´

---

## ä¸ƒã€å›æ»¾æ–¹æ¡ˆ

å¦‚éœ€æ¢å¾© SMS åŠŸèƒ½ï¼š
1. é‚„åŸ `form-builder.ts` çš„é›»è©±æ¬„ä½
2. é‚„åŸ `analysis-result.ts` çš„ ContactInfo å’ŒæŒ‰éˆ•
3. é‚„åŸ `edit-summary-modal.ts` çš„è¯çµ¡è³‡è¨Šé¡¯ç¤º
4. é‚„åŸ `index.ts` çš„ send_sms handler
5. é‚„åŸ `conversations/$id.tsx` çš„ SMS mutation å’Œ UI

Git å‘½ä»¤:
```bash
git revert <commit-hash>
```
