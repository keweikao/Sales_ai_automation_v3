# Migration 0004 執行指南

**日期**: 2026-01-20
**目的**: 新增業務脈絡欄位至 opportunities 表

---

## 方案 1: 使用 Neon Console (推薦,最簡單)

1. 開啟 Neon Dashboard: https://console.neon.tech
2. 選擇你的專案
3. 進入 **SQL Editor**
4. 複製以下 SQL 並執行:

```sql
-- Migration 0004: Add Business Context Fields to Opportunities Table
ALTER TABLE opportunities
ADD COLUMN IF NOT EXISTS store_type TEXT,
ADD COLUMN IF NOT EXISTS service_type TEXT,
ADD COLUMN IF NOT EXISTS staff_count TEXT,
ADD COLUMN IF NOT EXISTS current_system TEXT,
ADD COLUMN IF NOT EXISTS decision_maker_present TEXT;

-- Add column comments
COMMENT ON COLUMN opportunities.store_type IS '店型/店鋪類型 (e.g., coffee_shop, hair_salon)';
COMMENT ON COLUMN opportunities.service_type IS '營運型態 (e.g., dine_in, takeout) - iCHEF only';
COMMENT ON COLUMN opportunities.staff_count IS '員工數量 (e.g., 1-3, 4-10) - Beauty only';
COMMENT ON COLUMN opportunities.current_system IS '現有POS/系統 (e.g., none, ichef_old, excel)';
COMMENT ON COLUMN opportunities.decision_maker_present IS '決策者在場 (yes, no, unknown)';

-- Verify migration
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'opportunities'
  AND column_name IN ('store_type', 'service_type', 'staff_count', 'current_system', 'decision_maker_present')
ORDER BY column_name;
```

5. 查看結果,應該看到 5 個新欄位

---

## 方案 2: 使用 psql 命令列

如果你有安裝 psql:

```bash
# 從 Neon Dashboard 複製 Connection String
export DATABASE_URL="postgresql://user:pass@host/db"

# 執行 Migration
psql $DATABASE_URL < packages/db/run-migration-0004-direct.sql
```

---

## 方案 3: 使用 Bun 腳本 (需要 DATABASE_URL)

```bash
# 設定環境變數
export DATABASE_URL="postgresql://user:pass@host/db"

# 執行 Migration
cd packages/db
bun run execute-migration-0004.ts
```

---

## 驗證 Migration 成功

執行以下 SQL 查詢:

```sql
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'opportunities'
  AND column_name IN ('store_type', 'service_type', 'staff_count', 'current_system', 'decision_maker_present')
ORDER BY column_name;
```

**預期結果**: 應該看到 5 筆記錄,每個欄位都是 `text` 類型且 `is_nullable = YES`

---

## Migration 內容說明

### 新增欄位

| 欄位名稱 | 類型 | 說明 | 適用產品線 |
|---------|------|------|----------|
| `store_type` | TEXT | 店型/店鋪類型 | 全部 |
| `service_type` | TEXT | 營運型態 | iCHEF only |
| `staff_count` | TEXT | 員工數量 | Beauty only |
| `current_system` | TEXT | 現有POS系統 | 全部 |
| `decision_maker_present` | TEXT | 決策者在場 | 全部 |

### 欄位範例值

**iCHEF 產品線**:
- `store_type`: coffee_shop, restaurant, bakery
- `service_type`: dine_in, takeout, both
- `current_system`: none, ichef_old, excel, pos_365

**Beauty 產品線**:
- `store_type`: hair_salon, nail_salon, spa
- `staff_count`: 1-3, 4-10, 11-20
- `current_system`: none, excel, custom_system

**共同欄位**:
- `decision_maker_present`: yes, no, unknown

---

## 執行後的下一步

Migration 完成後,以下功能將立即可用:

1. ✅ **Web 新增商機頁面**: 可以選擇產品線並填寫業務脈絡資訊
2. ✅ **Slack Bot**: 上傳音檔時會自動收集並儲存業務脈絡
3. ✅ **API**: `/opportunities/create` 和 `/update` 接受新欄位
4. ✅ **MEDDIC 分析**: 可使用完整的業務脈絡進行更準確的分析

---

## 回滾 Migration (如果需要)

如果需要回滾此 Migration:

```sql
ALTER TABLE opportunities
DROP COLUMN IF EXISTS store_type,
DROP COLUMN IF EXISTS service_type,
DROP COLUMN IF EXISTS staff_count,
DROP COLUMN IF EXISTS current_system,
DROP COLUMN IF EXISTS decision_maker_present;
```

⚠️ **警告**: 回滾會刪除這些欄位的所有資料,請謹慎操作!

---

**建議執行方案**: 方案 1 (Neon Console) - 最簡單且視覺化
**預計執行時間**: < 1 分鐘
**風險等級**: 低 (使用 IF NOT EXISTS,不會影響現有資料)
