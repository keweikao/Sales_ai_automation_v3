# V3 Cases é·ç§»åŸ·è¡ŒæŒ‡å—

## æ¦‚è¿°

æœ¬æŒ‡å—èªªæ˜å¦‚ä½•å°‡ Google Firestore çš„ `cases` collection (V2 ç³»çµ±) é·ç§»è‡³ PostgreSQL V3 è³‡æ–™åº«ã€‚

**é·ç§»è¦æ¨¡:** <1,000 ç­† cases
**é è¨ˆæ™‚é–“:** ç¬¬ä¸€éšæ®µ 60-90 ç§’ (æ–‡å­—è³‡æ–™)
**é·ç§»ç­–ç•¥:** å…©éšæ®µé·ç§» (ç¬¬ä¸€éšæ®µæ–‡å­—,ç¬¬äºŒéšæ®µéŸ³æª”)

## è³‡æ–™æ˜ å°„é—œä¿‚

```
Firestore cases (1 case)
â”œâ”€> PostgreSQL opportunities (1 opportunity per unique customerName)
â”œâ”€> PostgreSQL conversations (1 conversation per case)
â””â”€> PostgreSQL meddic_analyses (åƒ…ç•¶æœ‰ analysis è³‡æ–™æ™‚)
```

### é—œéµæ˜ å°„é‚è¼¯

- **Opportunities å»é‡:** æŒ‰ `customerName` å»é‡,åŒä¸€å®¢æˆ¶åƒ…å»ºç«‹ä¸€å€‹ Opportunity
- **Customer Number:** è‡ªå‹•ç”Ÿæˆæ ¼å¼ `YYYYMM-{6ä½æ•¸å­—}`,åŸºæ–¼ customerName hash
- **Case Number:** ç›´æ¥ä½¿ç”¨ Firestore document ID (ä¾‹: `202511-IC004`)
- **User Mapping:** Slack User ID â†’ PostgreSQL User ID,ç„¡æ³•æ˜ å°„æ™‚ä½¿ç”¨ `service-account`
- **Product Line:** `IC` â†’ `ichef`, `OC` â†’ `outchef`
- **MEDDIC åˆ†æ•¸:** å¾ agent2 (Buyer) å’Œ agent3 (Seller) è¨ˆç®—å¹³å‡å€¼

## åŸ·è¡Œæ­¥é©Ÿ

### æ­¥é©Ÿ 0: ç’°å¢ƒè®Šæ•¸è¨­å®š

```bash
# è¨­å®š Firebase ç’°å¢ƒè®Šæ•¸
export FIREBASE_PROJECT_ID="sales-ai-automation-v2"
export FIREBASE_CLIENT_EMAIL="firebase-adminsdk-fbsvc@sales-ai-automation-v2.iam.gserviceaccount.com"
export FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----"

# è¨­å®š PostgreSQL ç’°å¢ƒè®Šæ•¸
export DATABASE_URL="postgresql://neondb_owner:...@ep-sparkling-band-a130c5ks-pooler.ap-southeast-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require"
```

**æç¤º:** å¯å¾ `.env.migration.example` å’Œ `apps/server/.env` å–å¾—å®Œæ•´ç’°å¢ƒè®Šæ•¸

### æ­¥é©Ÿ 1: æ¸…ç† V3 è³‡æ–™åº« (âš ï¸ é‡è¦)

**é‡è¦:** V2 çš„ caseId æœƒæ²¿ç”¨åˆ° V3 çš„ conversations.id,å› æ­¤å¿…é ˆå…ˆæ¸…é™¤ V3 æ‰€æœ‰æ¸¬è©¦è³‡æ–™,é¿å…ä¸»éµè¡çªã€‚

```bash
# 1. å…ˆæª¢æŸ¥è¦åˆªé™¤çš„è³‡æ–™é‡ (Dry Run)
DRY_RUN=true bun run scripts/migration/cleanup-v3-database.ts

# 2. ç¢ºèªç„¡èª¤å¾Œ,åŸ·è¡Œæ¸…ç†
FORCE_CLEANUP=true bun run scripts/migration/cleanup-v3-database.ts
```

**é æœŸè¼¸å‡º:**

```
ğŸš¨ V3 è³‡æ–™åº«æ¸…ç†å·¥å…·
================================================================================
âš ï¸  è­¦å‘Š: æ­¤æ“ä½œå°‡åˆªé™¤ä»¥ä¸‹è¡¨çš„æ‰€æœ‰è³‡æ–™:
   - meddic_analyses
   - conversations
   - opportunities
================================================================================

ğŸ”¥ æ­£å¼æ¸…ç†æ¨¡å¼ - å³å°‡åˆªé™¤è³‡æ–™

ğŸ“Š çµ±è¨ˆç•¶å‰è³‡æ–™é‡:
   - meddic_analyses: 123 ç­†
   - conversations: 456 ç­†
   - opportunities: 234 ç­†

   ç¸½è¨ˆ: 813 ç­†è³‡æ–™

ğŸ”¥ é–‹å§‹æ¸…ç†è³‡æ–™...

1ï¸âƒ£ åˆªé™¤ meddic_analyses...
   âœ… å·²åˆªé™¤ 123 ç­† meddic_analyses

2ï¸âƒ£ åˆªé™¤ conversations...
   âœ… å·²åˆªé™¤ 456 ç­† conversations

3ï¸âƒ£ åˆªé™¤ opportunities...
   âœ… å·²åˆªé™¤ 234 ç­† opportunities

ğŸ“Š é©—è­‰æ¸…ç†çµæœ:
   - meddic_analyses: 0 ç­†
   - conversations: 0 ç­†
   - opportunities: 0 ç­†

================================================================================
âœ… æ¸…ç†å®Œæˆ! V3 è³‡æ–™åº«å·²æ¸…ç©º
================================================================================
```

### æ­¥é©Ÿ 2: Dry Run æ¸¬è©¦

```bash
# ä½¿ç”¨æ¸¬è©¦æ¨¡å¼åŸ·è¡Œé·ç§»
DRY_RUN=true bun run scripts/migration/migrate-v3-cases.ts
```

**æª¢æŸ¥é …ç›®:**
- æ‰€æœ‰æ¬„ä½æ˜ å°„æ˜¯å¦æ­£ç¢º
- customerNumber ç”Ÿæˆé‚è¼¯æ˜¯å¦åˆç†
- userId æ˜ å°„æ˜¯å¦æˆåŠŸ
- ç„¡éŒ¯èª¤è¨Šæ¯

### æ­¥é©Ÿ 3: æ­£å¼é·ç§» (ç¬¬ä¸€éšæ®µ)

```bash
# åŸ·è¡Œæ­£å¼é·ç§» (ä¸åŒ…å«éŸ³æª”)
DRY_RUN=false bun run scripts/migration/migrate-v3-cases.ts
```

**é æœŸè¼¸å‡ºç¯„ä¾‹:**

```
ğŸš€ é–‹å§‹ Firestore Cases â†’ PostgreSQL V3 é·ç§»
ğŸ“Š æ¨¡å¼: æ­£å¼é·ç§»
================================================================================

ğŸ“¦ Phase 0: é è¼‰ç”¨æˆ¶æ˜ å°„
âœ… é è¼‰ 12 å€‹ç”¨æˆ¶æ˜ å°„

ğŸ“– Phase 1: è®€å– Firestore cases
âœ… è®€å– 856 ç­† cases

ğŸ¯ Phase 2: å»ºç«‹ Opportunities (æŒ‰ customerName å»é‡)
--------------------------------------------------------------------------------
ğŸ“Š ç™¼ç¾ 512 å€‹ä¸é‡è¤‡å®¢æˆ¶
âœ… å»ºç«‹: å†° (202601-123456) â†’ User abc123
â­ï¸  è·³éå·²å­˜åœ¨: é¤å»³ A (202601-654321) â†’ existing-id
...

ğŸ“Š Opportunities çµ±è¨ˆ:
   ç¸½æ•¸: 512
   å»ºç«‹: 489
   è·³é: 23
   éŒ¯èª¤: 0

ğŸ’¬ Phase 3: å»ºç«‹ Conversations
--------------------------------------------------------------------------------
âœ… å»ºç«‹: 202511-IC004 â†’ opp-id-1
...

ğŸ“Š Conversations çµ±è¨ˆ:
   ç¸½æ•¸: 856
   æˆåŠŸ: 856
   å¤±æ•—: 0

ğŸ“Š Phase 4: å»ºç«‹ MEDDIC Analyses
--------------------------------------------------------------------------------
âœ… å»ºç«‹: 202511-IC004 (score: 75)
...

ğŸ“Š MEDDIC Analyses çµ±è¨ˆ:
   ç¸½æ•¸: 617
   æˆåŠŸ: 617
   è·³é: 0
   å¤±æ•—: 0

================================================================================
ğŸ“Š é·ç§»çµ±è¨ˆå ±å‘Š
================================================================================
â±ï¸  ç¸½è€—æ™‚: 68.32 ç§’

ğŸ¯ Opportunities:
  - ç¸½æ•¸: 512
  - å»ºç«‹: 489
  - è·³é: 23
  - éŒ¯èª¤: 0

ğŸ’¬ Conversations:
  - ç¸½æ•¸: 856
  - æˆåŠŸ: 856
  - å¤±æ•—: 0

ğŸ“Š MEDDIC Analyses:
  - ç¸½æ•¸: 617
  - æˆåŠŸ: 617
  - è·³é: 0
  - å¤±æ•—: 0

================================================================================
âœ… é·ç§»å®Œæˆ!
```

### æ­¥é©Ÿ 4: é©—è­‰é·ç§»çµæœ

```bash
# åŸ·è¡Œé©—è­‰è…³æœ¬
bun run scripts/migration/validate-v3-cases.ts
```

**é©—è­‰é …ç›®:**

1. âœ… Cases â†’ Conversations ç­†æ•¸ä¸€è‡´
2. âœ… Unique Customers â†’ Opportunities ç­†æ•¸
3. âœ… MEDDIC Analyses ç­†æ•¸
4. âœ… ç„¡å­¤ç«‹ Conversations
5. âœ… customerNumber å¿…å¡«æ¬„ä½å®Œæ•´æ€§
6. âœ… caseNumber å¿…å¡«æ¬„ä½å®Œæ•´æ€§
7. âœ… éŸ³æª” URL ç¬¬ä¸€éšæ®µæ‡‰ç‚º null
8. âœ… Service Account ä½¿ç”¨æ¯”ä¾‹ (<50%)
9. âœ… Opportunity source æ¨™è¨˜ç‚º 'import'
10. âœ… Conversation ID èˆ‡ Firestore ä¸€è‡´

**é æœŸè¼¸å‡º:**

```
ğŸ” é–‹å§‹é©—è­‰ Firestore â†’ PostgreSQL V3 é·ç§»çµæœ
================================================================================

âœ… æª¢æŸ¥ 1: Cases â†’ Conversations ç­†æ•¸
   âœ… é€šé: 856 cases = 856 conversations

âœ… æª¢æŸ¥ 2: Unique Customers â†’ Opportunities
   âœ… é€šé: 512 å®¢æˆ¶ = 512 opportunities

...

================================================================================
ğŸ“Š é©—è­‰çµæœ: 10 é€šé, 0 å¤±æ•—
================================================================================
âœ… æ‰€æœ‰æª¢æŸ¥é€šé! é·ç§»è³‡æ–™æ­£ç¢ºç„¡èª¤
```

### æ­¥é©Ÿ 5: å›æ»¾ (å¦‚éœ€è¦)

å¦‚æœé·ç§»çµæœä¸ç¬¦é æœŸ,å¯ä½¿ç”¨æ¸…ç†è…³æœ¬å›æ»¾:

```bash
# å›æ»¾æ‰€æœ‰è³‡æ–™ (æ¸…ç©º V3 è³‡æ–™åº«)
FORCE_CLEANUP=true bun run scripts/migration/cleanup-v3-database.ts
```

æˆ–æ‰‹å‹•ä½¿ç”¨ SQL:

```sql
-- å®Œæ•´å›æ»¾æ‰€æœ‰ source='import' çš„è³‡æ–™
BEGIN;

DELETE FROM meddic_analyses
WHERE conversation_id IN (
  SELECT id FROM conversations WHERE opportunity_id IN (
    SELECT id FROM opportunities WHERE source = 'import'
  )
);

DELETE FROM conversations
WHERE opportunity_id IN (
  SELECT id FROM opportunities WHERE source = 'import'
);

DELETE FROM opportunities WHERE source = 'import';

COMMIT;
```

## éŸ³æª”é·ç§» (ç¬¬äºŒéšæ®µ - å¾…å¯¦ä½œ)

éŸ³æª”é·ç§»éœ€è¦å¾ GCS ä¸‹è¼‰éŸ³æª”ä¸¦ä¸Šå‚³è‡³ Cloudflare R2,é è¨ˆéœ€è¦ 1-3 å°æ™‚ã€‚

æ­¤éšæ®µè…³æœ¬å°šæœªå»ºç«‹,éœ€è¦æ™‚å¯åƒè€ƒè¨ˆç•«æ–‡ä»¶ä¸­çš„ `migrate-v3-audio.ts` ç¯„ä¾‹ã€‚

## æª”æ¡ˆæ¸…å–®

é·ç§»ç›¸é—œæª”æ¡ˆä½æ–¼ `scripts/migration/`:

```
scripts/migration/
â”œâ”€â”€ cleanup-v3-database.ts         # V3 è³‡æ–™åº«æ¸…ç†è…³æœ¬ â­
â”œâ”€â”€ types-v3-cases.ts              # V3 Cases é¡å‹å®šç¾©
â”œâ”€â”€ user-mapping.ts                # Slack User ID æ˜ å°„æœå‹™
â”œâ”€â”€ mappers/
â”‚   â””â”€â”€ v3-cases-mapper.ts         # æ ¸å¿ƒæ˜ å°„é‚è¼¯
â”œâ”€â”€ migrate-v3-cases.ts            # ä¸»åŸ·è¡Œè…³æœ¬ â­
â”œâ”€â”€ validate-v3-cases.ts           # é©—è­‰è…³æœ¬ â­
â””â”€â”€ explore-firestore-schema.ts    # Schema æ¢ç´¢è…³æœ¬ (å·²åŸ·è¡Œ)
```

## å¿«é€ŸåŸ·è¡Œæµç¨‹

```bash
# 0. è¨­å®šç’°å¢ƒè®Šæ•¸
export FIREBASE_PROJECT_ID="sales-ai-automation-v2"
export FIREBASE_CLIENT_EMAIL="firebase-adminsdk-fbsvc@..."
export FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----..."
export DATABASE_URL="postgresql://..."

# 1. æ¸…ç† V3 è³‡æ–™åº« (âš ï¸ é‡è¦ - é¿å…ä¸»éµè¡çª)
DRY_RUN=true bun run scripts/migration/cleanup-v3-database.ts
FORCE_CLEANUP=true bun run scripts/migration/cleanup-v3-database.ts

# 2. Dry Run æ¸¬è©¦
DRY_RUN=true bun run scripts/migration/migrate-v3-cases.ts

# 3. æ­£å¼é·ç§»
DRY_RUN=false bun run scripts/migration/migrate-v3-cases.ts

# 4. é©—è­‰çµæœ
bun run scripts/migration/validate-v3-cases.ts
```

## å¸¸è¦‹å•é¡Œ

### Q1: ç‚ºä»€éº¼å¿…é ˆå…ˆæ¸…ç† V3 è³‡æ–™åº«?

**åŸå› :** V2 çš„ caseId æœƒç›´æ¥æ²¿ç”¨åˆ° V3 çš„ conversations.id (ä¸»éµ)ã€‚å¦‚æœ V3 å·²æœ‰æ¸¬è©¦è³‡æ–™,æœƒç™¼ç”Ÿä¸»éµè¡çªå°è‡´é·ç§»å¤±æ•—ã€‚

**è§£æ±ºæ–¹æ³•:** é·ç§»å‰åŸ·è¡Œ `cleanup-v3-database.ts` æ¸…é™¤æ‰€æœ‰æ¸¬è©¦è³‡æ–™ã€‚

### Q2: V2 caseId å¦‚ä½•æ˜ å°„åˆ° V3?

**é‡è¦æ˜ å°„é—œä¿‚:**
- **V2 caseId** â†’ **V3 conversations.id** (ä¸»éµ,å®Œå…¨æ²¿ç”¨,ä¸è®Šæ›´)
- **V2 caseId** â†’ **V3 conversations.caseNumber** (æ¥­å‹™ç·¨è™Ÿ)
- **V2 customerName** (å»é‡) â†’ **V3 opportunities.customerNumber** (è‡ªå‹•ç”Ÿæˆ)

**ç¯„ä¾‹:**
```
V2: caseId = "202511-IC004", customerName = "å†°"
V3:
  - conversations.id = "202511-IC004" (æ²¿ç”¨)
  - conversations.caseNumber = "202511-IC004" (æ²¿ç”¨)
  - opportunities.customerNumber = "202601-123456" (åŸºæ–¼ customerName hash ç”Ÿæˆ)
```

### Q4: Service Account ä½¿ç”¨æ¯”ä¾‹éé«˜æ€éº¼è¾¦?

å¦‚æœ Service Account ä½¿ç”¨æ¯”ä¾‹ >= 50%,è¡¨ç¤ºå¤§éƒ¨åˆ† Slack User ID ç„¡æ³•æ˜ å°„åˆ° PostgreSQL Userã€‚

**è§£æ±ºæ–¹æ³•:**
1. æª¢æŸ¥ `user_profiles` è¡¨ä¸­æ˜¯å¦æœ‰æ­£ç¢ºçš„ `slackUserId` æ¬„ä½
2. ç¢ºèª Firestore çš„ `salesRepSlackId` æ ¼å¼æ˜¯å¦æ­£ç¢º (ä¾‹: `U0BU3PESX`)
3. è€ƒæ…®æ‰‹å‹•è£œå……ç”¨æˆ¶æ˜ å°„è³‡æ–™

**æ³¨æ„:** Service Account æ˜¯åˆæ³•çš„å¾Œå‚™æ–¹æ¡ˆ,ç¢ºä¿è³‡æ–™ä¸æœƒéºå¤±ã€‚

### Q6: éƒ¨åˆ† MEDDIC Analyses å»ºç«‹å¤±æ•—?

V3 cases åƒ…æœ‰ 4 å€‹ Agent (agent1-4),è€Œ PostgreSQL æœŸæœ› 6 å€‹ Agentã€‚

**è§£æ±ºæ–¹æ³•:**
- æ˜ å°„é‚è¼¯æœƒè‡ªå‹•å°‡ agent5 å’Œ agent6 è¨­ç‚º null
- å¦‚æœä»ç„¶å¤±æ•—,æª¢æŸ¥ `analysis.agents` çš„è³‡æ–™æ ¼å¼æ˜¯å¦å®Œæ•´

### Q7: éŸ³æª”ä½•æ™‚é·ç§»?

éŸ³æª”é·ç§»ç‚ºç¬¬äºŒéšæ®µ,å¯ç¨ç«‹åŸ·è¡Œã€‚ç¬¬ä¸€éšæ®µé·ç§»å®Œæˆå¾Œ,æ‰€æœ‰ `conversations.audioUrl` æœƒæ˜¯ nullã€‚

å¾…ç¬¬äºŒéšæ®µè…³æœ¬å¯¦ä½œå®Œæˆå¾Œ,æœƒå¾ GCS ä¸‹è¼‰éŸ³æª”ä¸¦ä¸Šå‚³è‡³ R2,ç„¶å¾Œæ›´æ–° `audioUrl` æ¬„ä½ã€‚

## ä¸‹ä¸€æ­¥

1. âœ… å®Œæˆç¬¬ä¸€éšæ®µé·ç§» (æ–‡å­—è³‡æ–™)
2. âœ… é©—è­‰é·ç§»çµæœ
3. â³ å¯¦ä½œéŸ³æª”é·ç§»è…³æœ¬ (ç¬¬äºŒéšæ®µ)
4. â³ åŸ·è¡ŒéŸ³æª”é·ç§»
5. â³ æœ€çµ‚é©—è­‰

---

**å»ºç«‹æ—¥æœŸ:** 2026-01-21
**æœ€å¾Œæ›´æ–°:** 2026-01-21
