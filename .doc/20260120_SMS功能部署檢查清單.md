# SMS 功能部署檢查清單

## ✅ 已完成項目

### 1. 程式碼實作
- [x] EVERY8D SMS 服務整合 (`packages/services/src/sms/every8d.ts`)
- [x] SMS API 端點 (`packages/api/src/routers/sms.ts`)
- [x] Slack 通知按鈕 (`packages/services/src/notifications/blocks.ts`)
- [x] Queue Worker 生成 share token (`apps/queue-worker/src/index.ts`)
- [x] Slack Bot 互動處理器 (`apps/slack-bot/src/index.ts`, `apps/slack-bot-beauty/src/index.ts`)
- [x] API Client 方法 (`apps/slack-bot*/src/api-client.ts`)

### 2. 環境變數配置
- [x] Alchemy 配置 (`packages/infra/alchemy.run.ts`)
  - EVERY8D_API_URL
  - EVERY8D_USERNAME (secret)
  - EVERY8D_PASSWORD (secret)
  - SHARE_TOKEN_SECRET (secret)
  - WEB_APP_URL
- [x] Queue Worker 環境變數 (`apps/queue-worker/.dev.vars`)
  - SERVER_URL
  - WEB_APP_URL
- [x] Cloudflare Workers Secrets
  - 您已在 Cloudflare 上設定 ✓

## 📋 部署前檢查

### 1. 資料庫 Migration

檢查是否需要執行 migration 建立 `sms_logs` 資料表:

```bash
# 檢查是否已有 sms_logs 資料表
psql $DATABASE_URL -c "\d sms_logs"
```

如果資料表不存在,執行:

```bash
cd packages/db
bun run drizzle-kit generate
bun run drizzle-kit push
```

### 2. 環境變數驗證

確認以下環境變數已設定在 Cloudflare Workers:

#### Server Worker
```bash
# 檢查 secrets (在 Cloudflare Dashboard)
- EVERY8D_USERNAME ✓
- EVERY8D_PASSWORD ✓
- SHARE_TOKEN_SECRET ✓

# 檢查環境變數 (在 wrangler.toml 或 Dashboard)
- EVERY8D_API_URL
- WEB_APP_URL
```

#### Queue Worker
```bash
# 檢查環境變數
- SERVER_URL (應指向 Server Worker URL)
- WEB_APP_URL
- SERVICE_API_TOKEN (如果使用 Service Account 認證)
```

### 3. 部署順序

```bash
# 1. 部署 Server (包含 SMS API)
cd apps/server
wrangler deploy

# 2. 部署 Queue Worker (會調用 Server API)
cd ../queue-worker
wrangler deploy

# 3. 部署 Slack Bots (會調用 Server API)
cd ../slack-bot
wrangler deploy

cd ../slack-bot-beauty
wrangler deploy
```

## 🧪 測試流程

### 1. 端到端測試

1. **上傳音檔到 Slack**
   - [ ] 在 Slack 頻道上傳測試音檔
   - [ ] 填寫表單,確保包含電話號碼 (格式: 09xxxxxxxx)
   - [ ] 確認表單提交成功

2. **等待處理完成**
   - [ ] 觀察 Queue Worker logs (`wrangler tail`)
   - [ ] 確認 "生成公開分享 Token" 日誌出現
   - [ ] 確認 Slack 收到完成通知

3. **驗證 SMS 按鈕**
   - [ ] 確認通知中有「📱 發送 SMS 給客戶」按鈕
   - [ ] 按鈕應該是藍色 (primary style)

4. **點擊發送 SMS**
   - [ ] 點擊按鈕
   - [ ] 確認顯示「正在發送簡訊至 09xxxxxxxx...」
   - [ ] 等待 2-3 秒
   - [ ] 確認顯示「✅ 簡訊已成功發送至 09xxxxxxxx」

5. **驗證 SMS 接收**
   - [ ] 檢查測試手機是否收到簡訊
   - [ ] 確認簡訊內容格式正確
   - [ ] 點擊簡訊中的連結

6. **驗證分享連結**
   - [ ] 確認連結可在瀏覽器開啟
   - [ ] 確認顯示完整 MEDDIC 分析報告
   - [ ] 確認不需要登入

### 2. 錯誤處理測試

測試各種錯誤情況:

- [ ] 客戶沒有電話號碼 → 按鈕不應出現
- [ ] EVERY8D 憑證錯誤 → 應顯示「簡訊發送失敗」
- [ ] 電話號碼格式錯誤 → 應在表單驗證階段被攔截
- [ ] Share token 生成失敗 → 按鈕不應出現 (graceful degradation)

## 🔍 監控與除錯

### 查看 Logs

```bash
# Server Logs
cd apps/server
wrangler tail

# Queue Worker Logs (重點查看 share token 生成)
cd apps/queue-worker
wrangler tail | grep -E "(share token|SMS)"

# Slack Bot Logs (重點查看 SMS 發送)
cd apps/slack-bot
wrangler tail | grep "SMS"
```

### 檢查資料庫

```sql
-- 查看最近的 SMS 發送記錄
SELECT
  phone_number,
  status_code,
  status_message,
  cost,
  credit_after,
  created_at
FROM sms_logs
ORDER BY created_at DESC
LIMIT 5;

-- 查看 Share Token
SELECT
  conversation_id,
  token,
  view_count,
  expires_at > NOW() AS is_valid
FROM share_tokens
ORDER BY created_at DESC
LIMIT 5;
```

## ⚠️ 常見問題

### 問題 1: SMS 按鈕未出現

**檢查項目**:
1. Queue Worker logs 是否有 "生成公開分享 Token" 日誌
2. 資料庫是否有對應的 share_token 記錄
3. Opportunity 是否有 contact_phone 欄位

**解決方案**:
```bash
# 檢查 Queue Worker 環境變數
wrangler secret list --env production

# 確認 SERVER_URL 設定正確
echo $SERVER_URL
```

### 問題 2: SMS 發送失敗

**檢查項目**:
1. EVERY8D 憑證是否正確
2. EVERY8D 帳戶是否有足夠點數
3. 電話號碼格式是否正確

**解決方案**:
```bash
# 測試 EVERY8D API
bun run test-sms-integration.ts

# 檢查 sms_logs
SELECT * FROM sms_logs WHERE status_code != 'SUCCESS' ORDER BY created_at DESC LIMIT 1;
```

### 問題 3: 分享連結無法訪問

**檢查項目**:
1. Token 是否過期 (預設 7 天)
2. WEB_APP_URL 是否設定正確
3. Share API 是否正常運作

**解決方案**:
```bash
# 測試 Share API
curl -X POST https://your-server.workers.dev/rpc/share.getByToken \
  -H "Content-Type: application/json" \
  -d '{"json": {"token": "your-token"}}'
```

## 📝 後續改進

未來可以考慮:
- [ ] SMS 發送確認對話框 (Slack Modal)
- [ ] 批次發送 SMS
- [ ] SMS 送達狀態追蹤
- [ ] 自訂 SMS 模板
- [ ] 發送歷史記錄查詢 (Slack 指令)

## ✅ 部署完成確認

當所有測試都通過後,在此打勾:

- [ ] 端到端測試成功
- [ ] 錯誤處理正常
- [ ] 監控系統運作正常
- [ ] 文件更新完成

---

**部署日期**: ___________
**部署人員**: ___________
**版本**: 1.0.0
