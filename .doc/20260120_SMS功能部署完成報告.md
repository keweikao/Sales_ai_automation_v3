# SMS åŠŸèƒ½éƒ¨ç½²å®Œæˆå ±å‘Š

**éƒ¨ç½²æ—¥æœŸ**: 2026-01-20
**éƒ¨ç½²ç‹€æ…‹**: âœ… æˆåŠŸ
**ç‰ˆæœ¬**: 1.0.0

---

## ğŸ‰ éƒ¨ç½²æˆåŠŸ

æ‰€æœ‰æœå‹™å·²æˆåŠŸéƒ¨ç½²åˆ° Cloudflare Workers!

### éƒ¨ç½²çš„æœå‹™

| æœå‹™åç¨± | éƒ¨ç½²ç‹€æ…‹ | Worker URL | Version ID |
|---------|---------|-----------|------------|
| **Server** | âœ… æˆåŠŸ | https://sales-ai-server.salesaiautomationv3.workers.dev | 09b8ae3f-151f-488e-93af-3cc2ca36d4aa |
| **Queue Worker** | âœ… æˆåŠŸ | https://sales-ai-queue-worker.salesaiautomationv3.workers.dev | 04c2cdc4-bf3c-42ac-90dd-710317fded46 |
| **Slack Bot (iCHEF)** | âœ… æˆåŠŸ | https://sales-ai-slack-bot.salesaiautomationv3.workers.dev | cf0e2245-e9bd-4b6f-92bf-d8b0ce331008 |
| **Slack Bot (Beauty)** | âœ… æˆåŠŸ | https://sales-ai-slack-bot-beauty.salesaiautomationv3.workers.dev | c599d091-b6d1-47b4-8148-8b7a7ff62869 |

---

## ğŸ“¦ å·²éƒ¨ç½²çš„åŠŸèƒ½

### 1. SMS ç™¼é€ç³»çµ±
- âœ… EVERY8D API æ•´åˆ
- âœ… SMS å…§å®¹ç”Ÿæˆ
- âœ… ç™¼é€è¨˜éŒ„è¿½è¹¤ (`sms_logs` è³‡æ–™è¡¨)

### 2. å…¬é–‹åˆ†äº«é€£çµ
- âœ… åŠ å¯† Token ç”Ÿæˆ (HMAC-SHA256)
- âœ… 7 å¤©æœ‰æ•ˆæœŸé™
- âœ… æŸ¥çœ‹æ¬¡æ•¸è¿½è¹¤
- âœ… å…¬é–‹ API (ä¸éœ€ç™»å…¥)

### 3. Slack äº’å‹•åŠŸèƒ½
- âœ… ã€ŒğŸ“± ç™¼é€ SMS çµ¦å®¢æˆ¶ã€æŒ‰éˆ•
- âœ… ç™¼é€é€²åº¦å³æ™‚å›é¥‹
- âœ… éŒ¯èª¤è™•ç†èˆ‡é€šçŸ¥

### 4. Queue Worker æ•´åˆ
- âœ… è‡ªå‹•ç”Ÿæˆ Share Token
- âœ… å‚³é Token çµ¦ Slack é€šçŸ¥
- âœ… Graceful degradation (Token ç”Ÿæˆå¤±æ•—ä¸å½±éŸ¿ä¸»æµç¨‹)

---

## ğŸ”§ ç’°å¢ƒè®Šæ•¸é…ç½®

### Server Worker
å·²é…ç½®çš„ç’°å¢ƒè®Šæ•¸:
- `EVERY8D_API_URL` - EVERY8D API ç«¯é»
- `EVERY8D_USERNAME` - EVERY8D å¸³è™Ÿ (Secret)
- `EVERY8D_PASSWORD` - EVERY8D å¯†ç¢¼ (Secret)
- `SHARE_TOKEN_SECRET` - Token åŠ å¯†é‡‘é‘° (Secret)
- `WEB_APP_URL` - ç¶²é æ‡‰ç”¨ç¨‹å¼ URL
- `BETTER_AUTH_URL` - èªè­‰æœå‹™ URL
- `CORS_ORIGIN` - CORS ä¾†æºè¨­å®š

### Queue Worker
å·²é…ç½®çš„ç’°å¢ƒè®Šæ•¸:
- `SERVER_URL` - Server API URL (éœ€è¦æ‰‹å‹•é…ç½®)
- `WEB_APP_URL` - ç¶²é æ‡‰ç”¨ç¨‹å¼ URL (éœ€è¦æ‰‹å‹•é…ç½®)
- `SERVICE_API_TOKEN` - Service Account Token (Secret,éœ€è¦æ‰‹å‹•é…ç½®)
- `ENVIRONMENT` - ç’°å¢ƒè¨­å®š (production)

### Slack Bots
å·²é…ç½®çš„ç’°å¢ƒè®Šæ•¸:
- `API_BASE_URL` - Server API URL (éœ€è¦æ‰‹å‹•é…ç½®)
- `API_TOKEN` - API èªè­‰ Token (Secret,éœ€è¦æ‰‹å‹•é…ç½®)
- `SLACK_BOT_TOKEN` - Slack Bot Token (Secret)
- `SLACK_SIGNING_SECRET` - Slack ç°½ç« å¯†é‘° (Secret)
- `ENVIRONMENT` - ç’°å¢ƒè¨­å®š (production)

---

## âš ï¸ éœ€è¦æ‰‹å‹•é…ç½®çš„ç’°å¢ƒè®Šæ•¸

éƒ¨ç½²å¾Œ,è«‹ç«‹å³è¨­å®šä»¥ä¸‹ç’°å¢ƒè®Šæ•¸:

### 1. Queue Worker

```bash
cd apps/queue-worker

# è¨­å®š Server API URL
wrangler secret put SERVER_URL
# è¼¸å…¥: https://sales-ai-server.salesaiautomationv3.workers.dev

# è¨­å®š Web App URL
wrangler secret put WEB_APP_URL
# è¼¸å…¥: https://5bcc2d03.sales-ai-web.pages.dev

# è¨­å®š Service API Token (ç”¨æ–¼ Queue Worker -> Server èªè­‰)
wrangler secret put SERVICE_API_TOKEN
# è¼¸å…¥: [æ‚¨çš„ Service Account Token]
```

### 2. Slack Bots (å¦‚æœé‚„æ²’è¨­å®š)

```bash
cd apps/slack-bot

# è¨­å®š API Base URL
wrangler secret put API_BASE_URL
# è¼¸å…¥: https://sales-ai-server.salesaiautomationv3.workers.dev

# è¨­å®š API Token
wrangler secret put API_TOKEN
# è¼¸å…¥: [æ‚¨çš„ API Token]

# å° Beauty Bot é‡è¤‡ç›¸åŒæ­¥é©Ÿ
cd ../slack-bot-beauty
wrangler secret put API_BASE_URL
wrangler secret put API_TOKEN
```

---

## ğŸ§ª æ¸¬è©¦æ­¥é©Ÿ

### 1. ç«¯åˆ°ç«¯æ¸¬è©¦

è«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿé€²è¡Œå®Œæ•´æ¸¬è©¦:

#### Step 1: ä¸Šå‚³éŸ³æª”
1. åœ¨ Slack é »é“ä¸Šå‚³æ¸¬è©¦éŸ³æª”
2. å¡«å¯«å®¢æˆ¶è³‡è¨Šè¡¨å–®
3. **é‡è¦**: ç¢ºä¿å¡«å¯«ã€Œå®¢æˆ¶é›»è©±ã€æ¬„ä½ (æ ¼å¼: 09xxxxxxxx)
4. æäº¤è¡¨å–®

#### Step 2: ç­‰å¾…è™•ç†
1. Queue Worker æœƒè™•ç†éŸ³æª”
2. é è¨ˆè™•ç†æ™‚é–“: 2-5 åˆ†é˜ (è¦–éŸ³æª”é•·åº¦)
3. å¯é€é `wrangler tail` è§€å¯Ÿè™•ç†é€²åº¦

#### Step 3: æª¢æŸ¥ Slack é€šçŸ¥
1. è™•ç†å®Œæˆå¾Œæœƒæ”¶åˆ° Slack é€šçŸ¥
2. ç¢ºèªé€šçŸ¥ä¸­æœ‰ã€ŒğŸ“± ç™¼é€ SMS çµ¦å®¢æˆ¶ã€æŒ‰éˆ•
3. æŒ‰éˆ•æ‡‰ç‚ºè—è‰² (primary style)

#### Step 4: ç™¼é€ SMS
1. é»æ“Šã€Œç™¼é€ SMSã€æŒ‰éˆ•
2. ç¢ºèªé¡¯ç¤ºã€Œæ­£åœ¨ç™¼é€ç°¡è¨Šè‡³ 09xxxxxxxx...ã€
3. ç­‰å¾… 2-3 ç§’
4. ç¢ºèªé¡¯ç¤ºã€Œâœ… ç°¡è¨Šå·²æˆåŠŸç™¼é€è‡³ 09xxxxxxxxã€

#### Step 5: é©—è­‰å®¢æˆ¶ç«¯
1. æª¢æŸ¥æ¸¬è©¦æ‰‹æ©Ÿæ˜¯å¦æ”¶åˆ°ç°¡è¨Š
2. ç¢ºèªç°¡è¨Šå…§å®¹åŒ…å«:
   - å…¬å¸åç¨±
   - æ¡ˆä»¶ç·¨è™Ÿ
   - MEDDIC åˆ†æ•¸
   - åˆ†äº«é€£çµ
3. é»æ“Šç°¡è¨Šä¸­çš„é€£çµ
4. ç¢ºèªå¯åœ¨ç€è¦½å™¨é–‹å•Ÿå ±å‘Šé é¢
5. ç¢ºèªä¸éœ€è¦ç™»å…¥å³å¯æŸ¥çœ‹

### 2. ç›£æ§å‘½ä»¤

```bash
# ç›£æ§ Server æ—¥èªŒ
cd apps/server
wrangler tail

# ç›£æ§ Queue Worker æ—¥èªŒ (é‡é»æŸ¥çœ‹ share token ç”Ÿæˆ)
cd apps/queue-worker
wrangler tail | grep -E "(share|SMS|token)"

# ç›£æ§ Slack Bot æ—¥èªŒ (é‡é»æŸ¥çœ‹ SMS ç™¼é€)
cd apps/slack-bot
wrangler tail | grep "SMS"
```

---

## ğŸ“Š é æœŸè¡Œç‚º

### æ­£å¸¸æµç¨‹

```
1. ç”¨æˆ¶ä¸Šå‚³éŸ³æª” + å¡«å¯«é›»è©± (09xxxxxxxx)
   â†“
2. Queue Worker è™•ç†éŸ³æª”
   â†“
3. Queue Worker ç”Ÿæˆ Share Token
   ğŸ“ Log: "[Queue] ğŸ”— Generating share token..."
   ğŸ“ Log: "[Queue] âœ“ Share token generated: xxx"
   â†“
4. ç™¼é€ Slack é€šçŸ¥ (åŒ…å« SMS æŒ‰éˆ•)
   â†“
5. æ¥­å‹™é»æ“Šã€Œç™¼é€ SMSã€æŒ‰éˆ•
   ğŸ“ Log: "[SMS] Sending customer SMS via API"
   â†“
6. èª¿ç”¨ Server API ç™¼é€ SMS
   ğŸ“ Log: "[SMS] API response: {success: true}"
   â†“
7. å®¢æˆ¶æ”¶åˆ°ç°¡è¨Š
   â†“
8. å®¢æˆ¶é»æ“Šé€£çµæŸ¥çœ‹å ±å‘Š
```

### é‚Šç•Œæƒ…æ³

| æƒ…æ³ | é æœŸè¡Œç‚º |
|-----|---------|
| å®¢æˆ¶æ²’æœ‰é›»è©±è™Ÿç¢¼ | SMS æŒ‰éˆ•ä¸å‡ºç¾ (graceful degradation) |
| Share Token ç”Ÿæˆå¤±æ•— | è¨˜éŒ„éŒ¯èª¤,SMS æŒ‰éˆ•ä¸å‡ºç¾,ä¸»æµç¨‹ç¹¼çºŒ |
| EVERY8D API å¤±æ•— | é¡¯ç¤ºã€ŒâŒ ç°¡è¨Šç™¼é€å¤±æ•—ã€,è¨˜éŒ„åˆ° `sms_logs` |
| é›»è©±è™Ÿç¢¼æ ¼å¼éŒ¯èª¤ | è¡¨å–®é©—è­‰éšæ®µå°±æœƒè¢«æ””æˆª |

---

## ğŸ” é™¤éŒ¯æŒ‡å—

### å•é¡Œ 1: SMS æŒ‰éˆ•æœªå‡ºç¾

**å¯èƒ½åŸå› **:
1. Queue Worker ç’°å¢ƒè®Šæ•¸ `SERVER_URL` æœªè¨­å®š
2. Share Token ç”Ÿæˆå¤±æ•—
3. å®¢æˆ¶æ²’æœ‰é›»è©±è™Ÿç¢¼

**æª¢æŸ¥æ­¥é©Ÿ**:
```bash
# 1. æª¢æŸ¥ Queue Worker logs
cd apps/queue-worker
wrangler tail | grep "share token"

# æ‡‰è©²çœ‹åˆ°:
# [Queue] ğŸ”— Generating share token...
# [Queue] âœ“ Share token generated: xxx

# 2. æª¢æŸ¥è³‡æ–™åº«
# ç¢ºèª share_tokens è³‡æ–™è¡¨æœ‰æ–°è¨˜éŒ„
```

### å•é¡Œ 2: SMS ç™¼é€å¤±æ•—

**å¯èƒ½åŸå› **:
1. EVERY8D æ†‘è­‰éŒ¯èª¤
2. EVERY8D é»æ•¸ä¸è¶³
3. é›»è©±è™Ÿç¢¼æ ¼å¼éŒ¯èª¤

**æª¢æŸ¥æ­¥é©Ÿ**:
```bash
# æª¢æŸ¥ Server logs
cd apps/server
wrangler tail | grep -i "every8d\|sms"

# æª¢æŸ¥ sms_logs è³‡æ–™è¡¨
# SELECT * FROM sms_logs WHERE status_code != 'SUCCESS' ORDER BY created_at DESC LIMIT 1;
```

### å•é¡Œ 3: åˆ†äº«é€£çµç„¡æ³•é–‹å•Ÿ

**å¯èƒ½åŸå› **:
1. Token å·²éæœŸ (é è¨­ 7 å¤©)
2. WEB_APP_URL é…ç½®éŒ¯èª¤

**æª¢æŸ¥æ­¥é©Ÿ**:
```bash
# æ¸¬è©¦ Share API
curl -X POST https://sales-ai-server.salesaiautomationv3.workers.dev/rpc/share.getByToken \
  -H "Content-Type: application/json" \
  -d '{"json": {"token": "your-token-here"}}'
```

---

## ğŸ“ ä¸‹ä¸€æ­¥è¡Œå‹•

### ç«‹å³åŸ·è¡Œ

1. **è¨­å®š Queue Worker ç’°å¢ƒè®Šæ•¸** (å¿…è¦!)
   ```bash
   cd apps/queue-worker
   wrangler secret put SERVER_URL
   wrangler secret put WEB_APP_URL
   wrangler secret put SERVICE_API_TOKEN
   ```

2. **åŸ·è¡Œç«¯åˆ°ç«¯æ¸¬è©¦**
   - ä¸Šå‚³æ¸¬è©¦éŸ³æª”
   - å¡«å¯«å®Œæ•´è¡¨å–® (åŒ…å«é›»è©±)
   - é©—è­‰æ•´å€‹æµç¨‹

3. **ç›£æ§é¦–æ¬¡ä½¿ç”¨**
   - é–‹å•Ÿ `wrangler tail` ç›£æ§ logs
   - è§€å¯Ÿæ˜¯å¦æœ‰ä»»ä½•éŒ¯èª¤

### å¾ŒçºŒå„ªåŒ–

- [ ] æ–°å¢ SMS ç™¼é€ç¢ºèªå°è©±æ¡† (Slack Modal)
- [ ] å¯¦ä½œ SMS æ‰¹æ¬¡ç™¼é€åŠŸèƒ½
- [ ] æ–°å¢ SMS æ¨¡æ¿ç³»çµ±
- [ ] å»ºç«‹ SMS ç™¼é€æ­·å²æŸ¥è©¢æŒ‡ä»¤
- [ ] è¨­å®š EVERY8D é»æ•¸ä¸è¶³è­¦å ±

---

## âœ… éƒ¨ç½²æª¢æŸ¥æ¸…å–®

- [x] Server éƒ¨ç½²æˆåŠŸ
- [x] Queue Worker éƒ¨ç½²æˆåŠŸ
- [x] Slack Bot (iCHEF) éƒ¨ç½²æˆåŠŸ
- [x] Slack Bot (Beauty) éƒ¨ç½²æˆåŠŸ
- [ ] Queue Worker ç’°å¢ƒè®Šæ•¸è¨­å®šå®Œæˆ
- [ ] ç«¯åˆ°ç«¯æ¸¬è©¦é€šé
- [ ] ç›£æ§ç³»çµ±é‹ä½œæ­£å¸¸

---

## ğŸ“ æ”¯æ´è³‡è¨Š

å¦‚é‡åˆ°å•é¡Œ,è«‹:

1. æª¢æŸ¥ Worker logs (`wrangler tail`)
2. æª¢æŸ¥è³‡æ–™åº«è¨˜éŒ„ (`sms_logs`, `share_tokens`)
3. åƒè€ƒå®Œæ•´éƒ¨ç½²æŒ‡å—: `.doc/20260120_SMSç™¼é€åŠŸèƒ½éƒ¨ç½²æŒ‡å—.md`
4. è¯ç¹«æŠ€è¡“æ”¯æ´: stephen.kao@ichef.com.tw

---

**éƒ¨ç½²å®Œæˆæ™‚é–“**: 2026-01-20
**éƒ¨ç½²äººå“¡**: Claude Code Assistant
**ä¸‹æ¬¡æª¢æŸ¥**: è¨­å®šå®Œç’°å¢ƒè®Šæ•¸å¾Œé€²è¡Œç«¯åˆ°ç«¯æ¸¬è©¦
