# Agent A: 基礎設施與核心服務實作計畫
# Infrastructure & Core Services Implementation Plan

**負責範圍:** 底層架構、共享模組、基礎服務
**開發週期:** 3 週 (15 個工作日)
**分支:** `feature/infrastructure`

---

## 總覽

Agent A 負責建立整個系統的基礎架構,包括:
- Cloudflare Queue 配置
- 共享錯誤處理系統
- Slack 通知服務
- R2 和 DB 工具模組
- Turborepo 配置
- Types 提取
- 單元測試

---

## Week 1: 核心架構修復 (5 天)

### Day 1: Queue 基礎設施 + 錯誤處理系統

#### 上午任務 (4 小時)

**任務 A1.1: Queue 配置** (1.5 小時)
- [ ] 更新 `apps/server/wrangler.toml`:
  ```toml
  [[queues.producers]]
  queue = "transcription-queue"
  binding = "TRANSCRIPTION_QUEUE"
  ```
- [ ] 創建 `apps/queue-worker/wrangler.toml`:
  ```toml
  name = "sales-ai-queue-worker"
  main = "src/index.ts"
  compatibility_date = "2024-01-01"

  [[queues.consumers]]
  queue = "transcription-queue"
  max_batch_size = 1
  max_retries = 3
  max_wait_time_ms = 60000
  dead_letter_queue = "transcription-dlq"
  ```
- [ ] 在 Cloudflare Dashboard 創建 Queue
- [ ] 測試 Queue binding

**任務 A1.2: 創建 Shared Package 基礎** (1.5 小時)
- [ ] 創建 `packages/shared/` 結構:
  ```
  packages/shared/
  ├── src/
  │   ├── index.ts
  │   ├── errors/
  │   │   └── index.ts
  │   └── types/
  │       └── index.ts
  ├── package.json
  └── tsconfig.json
  ```
- [ ] 配置 package.json (name: `@Sales_ai_automation_v3/shared`)

**任務 A1.3: 實現錯誤處理系統** (1 小時)
- [ ] 創建 `AppError` 類別 (完整實作)
- [ ] 定義所有錯誤類型:
  - `AUDIO_TOO_LARGE`
  - `INVALID_AUDIO_FORMAT`
  - `FILE_DOWNLOAD_FAILED`
  - `TRANSCRIPTION_FAILED`
  - `TRANSCRIPTION_TIMEOUT`
  - `GROQ_API_ERROR`
  - `GEMINI_API_ERROR`
  - `DATABASE_ERROR`
  - `RECORD_NOT_FOUND`
  - `OPPORTUNITY_NOT_FOUND`
  - `UNAUTHORIZED`
- [ ] 實現工具函數:
  - `isAppError()`
  - `formatErrorForUser()`
  - `formatErrorForLog()`

#### 下午任務 (4 小時)

**任務 A1.4: 定義核心類型介面** (2 小時)
- [ ] 創建 `packages/shared/src/types/index.ts`
- [ ] 定義 Queue Message 類型:
  ```typescript
  export interface TranscriptionMessage {
    conversationId: string;
    opportunityId: string;
    audioUrl: string;
    slackUserId?: string;
    slackChannelId?: string;
    metadata: {
      fileName: string;
      fileSize: number;
      format: string;
    };
  }
  ```
- [ ] 定義 Conversation 類型 (基本結構)
- [ ] 定義 Transcript 類型
- [ ] 發布 `@Sales_ai_automation_v3/shared@0.1.0`

**任務 A1.5: 創建 Queue Worker 骨架** (2 小時)
- [ ] 創建 `apps/queue-worker/src/index.ts`:
  ```typescript
  import type { MessageBatch } from '@cloudflare/workers-types';
  import type { TranscriptionMessage } from '@Sales_ai_automation_v3/shared';

  export default {
    async queue(batch: MessageBatch<TranscriptionMessage>, env: Env) {
      console.log('[Queue] Received batch:', batch.messages.length);
      // 骨架實作,先 ack
      for (const message of batch.messages) {
        message.ack();
      }
    }
  };
  ```
- [ ] 測試接收訊息
- [ ] 提交代碼

#### 交付物
- ✅ Queue 配置完成
- ✅ `@Sales_ai_automation_v3/shared` package (錯誤系統 + 類型定義)
- ✅ Queue Worker 骨架可接收訊息

---

### Day 2: Slack 通知服務

#### 上午任務 (4 小時)

**任務 A2.1: 創建 Slack 服務介面** (1 小時)
- [ ] 創建 `packages/services/src/notifications/slack.ts`
- [ ] 定義 `SlackNotificationService` 介面:
  ```typescript
  export interface SlackNotificationService {
    notifyTranscriptionComplete(params: {
      userId: string;
      conversationId: string;
      caseNumber: string;
      analysisResult: any;
    }): Promise<void>;

    notifyTranscriptionFailed(params: {
      userId: string;
      fileName: string;
      errorMessage: string;
    }): Promise<void>;

    notifyProcessingStarted(params: {
      userId: string;
      fileName: string;
      caseNumber: string;
    }): Promise<void>;
  }
  ```

**任務 A2.2: 實作 Slack 服務** (2 小時)
- [ ] 安裝 `@slack/web-api`
- [ ] 實現 `createSlackNotificationService()`
- [ ] 實現三種通知方法 (使用 Block Kit)
- [ ] 添加錯誤處理

**任務 A2.3: 單元測試** (1 小時)
- [ ] 測試訊息格式
- [ ] 測試錯誤處理
- [ ] Mock Slack API

#### 下午任務 (4 小時)

**任務 A2.4: 設計訊息格式** (2 小時)
- [ ] 設計「處理完成」訊息 Block Kit
- [ ] 設計「處理失敗」訊息 Block Kit
- [ ] 設計「開始處理」訊息 Block Kit
- [ ] 在 Slack 測試頻道實際發送

**任務 A2.5: 建立 R2 工具模組** (2 小時)
- [ ] 創建 `apps/queue-worker/src/utils/r2.ts`:
  ```typescript
  export async function downloadFromR2(
    url: string,
    env: Env
  ): Promise<Buffer> {
    // R2 下載實現
  }
  ```
- [ ] 實現下載邏輯
- [ ] 添加錯誤處理 (使用 shared errors)
- [ ] 單元測試

#### 交付物
- ✅ Slack 通知服務完整實作
- ✅ R2 工具模組
- ✅ 單元測試通過

---

### Day 3: 工具模組與測試

#### 上午任務 (4 小時)

**任務 A3.1: 完善 DB 工具** (2 小時)
- [ ] 擴展 `apps/queue-worker/src/utils/db.ts`:
  ```typescript
  export async function saveAnalysisResult(
    db: Database,
    conversationId: string,
    analysis: MEDDICAnalysis
  ): Promise<void> {
    // 保存分析結果
  }

  export async function markConversationFailed(
    db: Database,
    conversationId: string,
    errorMessage: string
  ): Promise<void> {
    // 標記失敗
  }
  ```
- [ ] 單元測試

**任務 A3.2: 完善 R2 工具** (1 小時)
- [ ] 添加重試邏輯到 `downloadFromR2()`
- [ ] 添加超時處理
- [ ] 添加進度日誌
- [ ] 測試大檔案下載 (96MB)

**任務 A3.3: 撰寫工具模組測試** (1 小時)
- [ ] R2 工具單元測試
- [ ] DB 工具單元測試
- [ ] 錯誤場景測試

#### 下午任務 (4 小時)

**任務 A3.4: Slack 整合到 Worker** (2 小時)
- [ ] 在 Queue Worker 中使用 Slack 服務:
  ```typescript
  import { createSlackNotificationService } from '@Sales_ai_automation_v3/services/notifications/slack';

  const slack = createSlackNotificationService(env.SLACK_BOT_TOKEN);

  // 成功時
  await slack.notifyTranscriptionComplete({
    userId: slackUserId,
    conversationId,
    caseNumber,
    analysisResult,
  });

  // 失敗時
  await slack.notifyTranscriptionFailed({
    userId: slackUserId,
    fileName: metadata.fileName,
    errorMessage: formatErrorForUser(error),
  });
  ```
- [ ] 測試通知發送

**任務 A3.5: 單元測試 (Queue Worker)** (2 小時)
- [ ] 測試訊息處理邏輯
- [ ] 測試錯誤處理
- [ ] 測試 ack/retry 機制
- [ ] Mock 所有外部依賴

#### 交付物
- ✅ 完整的工具模組 (R2, DB)
- ✅ Slack 整合完成
- ✅ 單元測試通過

---

### Day 4: 單元測試

#### 全日任務 (8 小時)

**任務 A4.1: 錯誤系統測試** (2 小時)
- [ ] 測試所有 `AppError` 類型
- [ ] 測試 `formatErrorForUser()`
- [ ] 測試 `formatErrorForLog()`
- [ ] 測試 `isAppError()`

**任務 A4.2: Slack 服務測試** (2 小時)
- [ ] Mock Slack API
- [ ] 測試三種通知方法
- [ ] 測試錯誤處理
- [ ] 測試訊息格式

**任務 A4.3: 工具模組測試** (2 小時)
- [ ] R2 工具測試 (Mock R2)
- [ ] DB 工具測試 (Mock DB)
- [ ] 測試重試邏輯
- [ ] 測試超時處理

**任務 A4.4: 達到 80% 覆蓋率** (2 小時)
- [ ] 運行 coverage 報告
- [ ] 補充缺失測試
- [ ] 優化測試代碼

#### 交付物
- ✅ 單元測試覆蓋率 > 80%
- ✅ 所有工具模組測試通過

---

### Day 5: Bug 修復與文檔

#### 上午任務 (4 小時)

**任務 5.1: Bug 修復** (3 小時)
- [ ] 修復 Day 4 發現的所有 Bug
- [ ] 優化日誌輸出
- [ ] 優化錯誤訊息文案
- [ ] 代碼 Review

**任務 5.2: 代碼規範檢查** (1 小時)
- [ ] 運行 `bun x ultracite fix`
- [ ] 修復所有 lint 警告
- [ ] 統一代碼風格

#### 下午任務 (4 小時)

**任務 5.3: 撰寫文檔** (2 小時)
- [ ] 更新 README
- [ ] 創建 `ARCHITECTURE.md` (基礎設施部分)
- [ ] 記錄 Queue 流程圖
- [ ] 記錄錯誤處理機制

**任務 5.4: 準備 Week 2** (2 小時)
- [ ] Review Week 1 成果
- [ ] 整理待辦事項
- [ ] 規劃 Week 2 分工

---

## Week 2: Better-T Stack 重構 (5 天)

### Day 1: Turborepo 配置

#### 上午任務 (4 小時)

**任務 A1.1: 安裝與配置** (2 小時)
- [ ] 安裝 Turborepo: `bun add -D turbo`
- [ ] 創建 `turbo.json`:
  ```json
  {
    "$schema": "https://turbo.build/schema.json",
    "globalDependencies": ["**/.env.*local"],
    "pipeline": {
      "build": {
        "dependsOn": ["^build"],
        "outputs": [".next/**", "!.next/cache/**", "dist/**"]
      },
      "lint": { "dependsOn": ["^lint"] },
      "dev": { "cache": false, "persistent": true },
      "deploy": { "dependsOn": ["build", "lint"] },
      "test": { "dependsOn": ["^build"], "outputs": ["coverage/**"] }
    }
  }
  ```
- [ ] 更新 root `package.json` scripts

**任務 A1.2: 配置各 Package** (2 小時)
- [ ] 確保所有 package 都有統一的 script 名稱
- [ ] 配置 dependencies 關係
- [ ] 測試基本構建

#### 下午任務 (4 小時)

**任務 A1.3: 優化配置** (2 小時)
- [ ] 調整 cache 策略
- [ ] 調整 parallel 執行
- [ ] 配置 outputs

**任務 A1.4: 撰寫文檔** (2 小時)
- [ ] 創建 Turborepo 使用指南
- [ ] 記錄常見問題
- [ ] 準備性能測試指令

#### 交付物
- ✅ Turborepo 配置完成
- ✅ 所有 package 可構建
- ✅ 文檔完成

---

### Day 2-3: 提取 Types

#### Day 2 上午 (4 小時)

**任務 A2.1: 創建 Types 結構** (1 小時)
- [ ] 創建 `packages/shared/src/types/` 目錄結構
- [ ] 規劃類型分類 (conversation, opportunity, meddic, slack)

**任務 A2.2: 提取 Conversation Types** (1.5 小時)
- [ ] 創建 `types/conversation.ts`:
  ```typescript
  export type ConversationStatus = 'pending' | 'transcribed' | 'completed' | 'failed';
  export type ConversationType = 'discovery_call' | 'demo' | 'negotiation' | 'follow_up' | 'other';
  export interface TranscriptSegment { ... }
  export interface Transcript { ... }
  export interface Conversation { ... }
  ```

**任務 A2.3: 提取 MEDDIC Types** (1.5 小時)
- [ ] 創建 `types/meddic.ts`:
  ```typescript
  export interface MEDDICDimension { ... }
  export interface MEDDICAnalysis { ... }
  export interface MEDDICScore { ... }
  ```

#### Day 2 下午 (4 小時)

**任務 A2.4: 提取 Opportunity Types** (2 小時)
- [ ] 創建 `types/opportunity.ts`
- [ ] 定義所有 Opportunity 相關類型

**任務 A2.5: 提取 Slack Types** (2 小時)
- [ ] 創建 `types/slack.ts`
- [ ] 定義 Slack 事件、訊息相關類型

#### Day 3 上午 (4 小時)

**任務 A2.6: 更新 Imports (Services)** (4 小時)
- [ ] 更新 `packages/services/` 使用 shared types
- [ ] 移除本地定義的類型
- [ ] 測試編譯通過

#### Day 3 下午 (4 小時)

**任務 A2.7: 更新 Imports (Apps)** (4 小時)
- [ ] 更新 `apps/queue-worker/` 使用 shared types
- [ ] 更新 `apps/server/` 使用 shared types
- [ ] 測試所有 apps 編譯通過

#### 交付物
- ✅ 所有 Types 提取完成
- ✅ 所有 Imports 更新
- ✅ 編譯無錯誤

---

### Day 4: tRPC POC

#### 上午任務 (4 小時)

**任務 A4.1: 研究 tRPC** (1 小時)
- [ ] 閱讀 tRPC 官方文檔
- [ ] 閱讀 tRPC + Cloudflare Workers 範例
- [ ] 了解與 oRPC 差異

**任務 A4.2: 創建 tRPC POC** (3 小時)
- [ ] 創建 `packages/api-trpc/` 目錄
- [ ] 安裝依賴: `@trpc/server`
- [ ] 實現基本 router:
  ```typescript
  import { initTRPC } from '@trpc/server';

  const t = initTRPC.context<{ env: Env }>().create();

  export const appRouter = t.router({
    conversations: t.router({
      upload: t.procedure.input(uploadConversationSchema).mutation(async ({ input }) => {
        // POC 實現
      }),
      analyze: t.procedure.input(z.object({ id: z.string() })).query(async ({ input }) => {
        // POC 實現
      }),
    }),
  });
  ```

#### 下午任務 (4 小時)

**任務 A4.3: 實現 tRPC Client** (2 小時)
- [ ] 創建測試 client
- [ ] 測試類型推導
- [ ] 測試 API 調用
- [ ] 記錄開發體驗

**任務 A4.4: 性能測試** (2 小時)
- [ ] 對比 oRPC vs tRPC 性能
- [ ] 測試 bundle size
- [ ] 測試類型推導速度
- [ ] 記錄結果

#### 交付物
- ✅ tRPC POC 可運作
- ✅ 性能測試數據
- ✅ 開發體驗報告

---

### Day 5: 決策與文檔

#### 上午任務 (4 小時)

**任務 5.1: 決策會議** (2 小時)
- [ ] Review tRPC 評估結果
- [ ] 討論決策標準
- [ ] 做出最終決定
- [ ] 記錄決策理由

**任務 5.2: 撰寫架構文檔** (2 小時)
- [ ] 更新 `ARCHITECTURE.md`:
  - 系統架構圖
  - Queue 處理流程
  - 錯誤處理機制
  - Package 結構

#### 下午任務 (4 小時)

**任務 5.3: 更新文檔** (2 小時)
- [ ] 更新 README.md
- [ ] 創建 `DEVELOPMENT.md` (開發指南)
- [ ] 更新所有相關文檔

**任務 5.4: 整理 Week 1-2 成果** (2 小時)
- [ ] 創建 `CHANGELOG.md`
- [ ] 記錄所有變更
- [ ] 準備 Week 3 測試計畫

---

## Week 3: 測試與上線 (5 天)

### Day 1-2: 單元測試

#### Day 1 上午 (4 小時)

**任務 A1.1: Queue Worker 測試** (4 小時)
- [ ] 測試 Queue handler
- [ ] 測試 transcription handler
- [ ] 測試 analysis handler
- [ ] 測試錯誤處理

#### Day 1 下午 (4 小時)

**任務 A1.2: Services 測試** (4 小時)
- [ ] 測試 Slack 服務
- [ ] 測試 Whisper 服務
- [ ] 測試 Orchestrator
- [ ] Mock 所有外部 API

#### Day 2 上午 (4 小時)

**任務 A1.3: 工具模組測試** (4 小時)
- [ ] 測試 R2 工具
- [ ] 測試 DB 工具
- [ ] 測試錯誤系統
- [ ] 測試 Schema validation

#### Day 2 下午 (4 小時)

**任務 A1.4: 達到測試覆蓋率目標** (4 小時)
- [ ] 運行 coverage 報告
- [ ] 補充缺失測試
- [ ] 確保 > 80% 覆蓋率
- [ ] 修復失敗測試

#### 交付物
- ✅ 單元測試覆蓋率 > 80%
- ✅ 所有測試通過
- ✅ Coverage 報告

---

### Day 3: 性能測試

#### 上午任務 (4 小時)

**任務 A3.1: 單檔案性能測試** (4 小時)
- [ ] 測試 5MB 音檔 (運行 10 次):
  - 記錄處理時間
  - 計算平均值、中位數、P95
  - 目標: < 2 分鐘
- [ ] 測試 20MB 音檔 (運行 10 次):
  - 記錄數據
  - 目標: < 5 分鐘
- [ ] 測試 96MB 音檔 (運行 5 次):
  - 記錄數據
  - 目標: < 15 分鐘
- [ ] 分析瓶頸

#### 下午任務 (4 小時)

**任務 A3.2: Queue 性能測試** (2 小時)
- [ ] 測試 Queue 延遲 (推送到接收)
- [ ] 測試 Queue 吞吐量 (1 分鐘 100 個訊息)
- [ ] 測試 Dead Letter Queue
- [ ] 記錄數據

**任務 A3.3: 資料庫性能測試** (2 小時)
- [ ] 測試 SELECT 查詢時間
- [ ] 測試 UPDATE 更新時間
- [ ] 測試並發寫入
- [ ] 識別慢查詢

#### 交付物
- ✅ 性能測試數據
- ✅ 瓶頸分析報告
- ✅ 優化建議

---

### Day 4: 部署準備

#### 上午任務 (4 小時)

**任務 A4.1: 部署前檢查** (2 小時)
- [ ] 檢查所有環境變數
- [ ] 檢查所有 secrets
- [ ] 檢查 wrangler.toml 配置
- [ ] 運行 `turbo run build`
- [ ] 運行 `turbo run lint`
- [ ] 創建部署檢查清單

**任務 A4.2: 備份資料庫** (2 小時)
- [ ] 匯出 Neon Database 備份
- [ ] 驗證備份完整性
- [ ] 上傳備份到安全位置
- [ ] 記錄備份時間和版本
- [ ] 準備 Rollback 計畫

#### 下午任務 (4 小時)

**任務 A4.3: 準備部署腳本** (2 小時)
- [ ] 創建 `deploy.sh`
- [ ] 創建 `rollback.sh`
- [ ] 測試腳本

**任務 A4.4: 準備監控** (2 小時)
- [ ] 設定 Cloudflare Alerts
- [ ] 準備監控 Dashboard
- [ ] 設定日誌保留
- [ ] 準備部署通知

#### 交付物
- ✅ 部署準備完成
- ✅ 備份完成
- ✅ 部署腳本準備好

---

### Day 5: 監控與調優

#### 上午任務 (4 小時)

**任務 5.1: 監控初期數據** (2 小時)
- [ ] 收集前 10 個處理的數據
- [ ] 分析處理時間
- [ ] 分析成功率
- [ ] 識別異常

**任務 5.2: 性能調優** (2 小時)
- [ ] 根據監控數據調整配置
- [ ] 優化慢查詢
- [ ] 重新測試

#### 下午任務 (4 小時)

**任務 5.3: 完善文檔** (2 小時)
- [ ] 更新 `OPS_DEPLOYMENT_GUIDE.md`
- [ ] 創建 `MONITORING.md`
- [ ] 創建 `RUNBOOK.md`

**任務 5.4: 項目總結** (2 小時)
- [ ] 撰寫基礎設施總結報告
- [ ] 記錄學到的經驗
- [ ] 記錄未來改進方向

---

## 每日同步點

**上午同步 (9:00 AM, 15 分鐘)**
- 分享今日計畫
- 確認與 Agent B 的依賴關係
- 解決阻塞問題

**下午同步 (3:00 PM, 15 分鐘)**
- 分享進度
- 更新交付物狀態
- 調整計畫 (如需要)

**每日結束同步 (6:00 PM, 30 分鐘)**
- Review 當日成果
- 更新檢查清單
- 提交代碼到 `feature/infrastructure` 分支
- 規劃明日工作

---

## 驗收標準

### 功能驗收
- [ ] Queue 配置正確運作
- [ ] 錯誤處理系統完整
- [ ] Slack 通知正常發送
- [ ] 所有工具模組穩定

### 代碼品質
- [ ] TypeScript 無錯誤
- [ ] 單元測試覆蓋率 > 80%
- [ ] 統一使用 `AppError`
- [ ] 通過 `bun x ultracite check`

### 性能
- [ ] Queue 延遲 < 1 秒
- [ ] R2 下載穩定
- [ ] 構建速度提升 > 30%
