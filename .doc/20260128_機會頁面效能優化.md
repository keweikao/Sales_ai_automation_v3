# 機會頁面效能優化

## 概述

優化 `/opportunities` 列表和 `/opportunities/$id` 詳情頁面的載入速度，透過修復 N+1 查詢問題並加入 KV Cache 機制。

## 問題分析

### 原始問題

`listOpportunities` API 存在嚴重的 N+1 查詢問題：

```
基礎查詢：3 次
+ 每筆機會：conversations (1) + meddicAnalyses (1) + user (1) = 3 次
= 返回 20 筆時共 63 次 DB 查詢
```

### 效能數據

| 指標 | 優化前 |
|------|--------|
| 機會列表 API 平均回應時間 | ~525ms |
| 機會詳情 API 平均回應時間 | ~520ms |
| DB 查詢次數（列表 20 筆） | ~63 次 |

## 解決方案

### Phase 1: 修復 N+1 問題

**修改檔案**：`packages/api/src/routers/opportunity.ts`

將迴圈查詢改為批次查詢：

```typescript
// 批次查詢 1: 取得所有機會的最新 conversation
const allConversations = await db
  .select({...})
  .from(conversations)
  .where(inArray(conversations.opportunityId, opportunityIds))
  .orderBy(desc(conversations.createdAt));

// 批次查詢 2: 取得所有相關 conversation 的 MEDDIC 分析
const allAnalyses = await db
  .select({...})
  .from(meddicAnalyses)
  .where(inArray(meddicAnalyses.conversationId, conversationIds))
  .orderBy(desc(meddicAnalyses.createdAt));

// 批次查詢 3: 取得所有相關 user 的名稱
const allUsers = await db.query.user.findMany({
  where: inArray(user.id, userIds),
  columns: { id: true, name: true },
});

// 組合結果（純記憶體操作，無 DB 查詢）
const opportunitiesWithExtras = results.map((opportunity) => {...});
```

**效果**：從 63 次查詢降到 4 次批次查詢

### Phase 2: 加入 KV Cache

**修改檔案**：
- `packages/api/src/routers/opportunity.ts`
- `packages/services/src/cache/helpers.ts`
- `packages/services/src/index.ts`

**Cache Key 設計**：

```
# 一般用戶（依 userId 分開）
user:{userId}:opportunities:list:active
user:{userId}:opportunities:list:won
user:{userId}:opportunities:list:lost

# 管理員（共用）
admin:opportunities:list:active
admin:opportunities:list:won
admin:opportunities:list:lost

# 主管（依產品線分開）
manager:ichef:opportunities:list:active
manager:ichef:opportunities:list:won
manager:ichef:opportunities:list:lost
manager:beauty:opportunities:list:active
manager:beauty:opportunities:list:won
manager:beauty:opportunities:list:lost
```

**Cache 策略**：
- TTL：10 分鐘
- 只有無搜尋、無 source 篩選、無 productLine 篩選時才使用快取
- 採用 Invalidation-First 策略（刪除而非更新）

### Phase 3: Cache 失效機制

**新增 Helper 函數**：`invalidateOpportunitiesCache`

**失效時機**：
- `createOpportunity` → 失效列表 cache
- `updateOpportunity` → 失效列表 + 詳情 cache
- `rejectOpportunity` → 失效列表 + 詳情 cache
- `winOpportunity` → 失效列表 + 詳情 cache

## 修改檔案清單

| 檔案 | 修改內容 |
|------|---------|
| `packages/api/src/routers/opportunity.ts` | 重寫查詢邏輯、加入 cache 讀取/寫入、加入 cache 失效 |
| `packages/services/src/cache/helpers.ts` | 新增 `invalidateOpportunitiesCache` 函數 |
| `packages/services/src/index.ts` | Export `invalidateOpportunitiesCache` |

## 預期效果

| 指標 | 優化前 | 優化後（預估） |
|------|--------|--------------|
| DB 查詢次數 | ~63 次 | 4 次（cache miss）/ 0 次（cache hit）|
| 回應時間 | ~525ms | ~150-200ms（cache miss）/ ~50-100ms（cache hit）|

## 驗證方式

1. **瀏覽器測試**：開啟 https://sales-ai-web.pages.dev/opportunities 並觀察載入速度
2. **查看日誌**：在 Cloudflare Dashboard 查看 Workers 日誌，確認 `[Cache Hit]` 或 `[Cache Set]` 訊息
3. **重複載入**：第二次載入應該明顯更快（cache hit）

## 注意事項

1. **資料一致性**：Cache TTL 10 分鐘，用戶可能看到稍舊的資料（可接受）
2. **權限分離**：Admin/Manager 和一般用戶的 cache 分開，避免權限洩漏
3. **搜尋功能**：有搜尋條件時不使用 cache（條件組合太多）
4. **Slack 建立機會**：需確保 queue-worker 中也觸發 cache 失效（未來改進項目）

## 部署資訊

- **部署時間**：2026-01-28
- **部署環境**：Production (sales-ai-server)
- **版本 ID**：01dca557-e962-4396-987b-48c639374b73
